!
! This file was generated by expand.py based on kernels.f90.
!
module kernels_module
  use bc_module
  use chemistry_module, only : nspecies, molecular_weight, Ru
  use derivative_stencil_module, only : stencil_ng, first_deriv_8, first_deriv_6, &
       first_deriv_4, first_deriv_l3, first_deriv_r3, first_deriv_rb, first_deriv_lb, &
       M8, M6, M4, M2, BRB, BLB, D8, D6, D4
  use variables_module
  implicit none

  private

  public :: hypterm_3d, narrow_diffterm_3d, chemterm_3d, comp_courno_3d

contains

  subroutine hypterm_3d (lo,hi,dx,cons,clo,chi,q,qlo,qhi,rhs_g,rlo,rhi,dlo_g,dhi_g,bclo,bchi)

    integer,         intent(in):: dlo_g(3),dhi_g(3),bclo(3),bchi(3)
    integer,         intent(in):: lo(3),hi(3),clo(3),chi(3),qlo(3),qhi(3),rlo(3),rhi(3)
    double precision,intent(in):: dx(3)
    double precision,intent(in):: cons(clo(1):chi(1),clo(2):chi(2),clo(3):chi(3),ncons)
    double precision,intent(in)::    q(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3),nprim)
    double precision           ::rhs_g(rlo(1):rhi(1),rlo(2):rhi(2),rlo(3):rhi(3),ncons)

    integer          :: i,j,k,n
    double precision :: dxinv(3)
    double precision :: un(-4:4)
    integer :: slo(3), shi(3), dlo(3), dhi(3)
    
    double precision, allocatable :: tmpx(:), tmpy(:,:),tmpz(:,:,:)
    double precision, allocatable :: rhs(:,:,:,:)

    logical :: physbclo(3), physbchi(3)

    ! Only the region bounded by [dlo_g,dhi_g] contains good data.
    ! [slo,shi] will be safe for 8th-order stencil
    do i=1,3
       dlo(i) = max(lo(i)-stencil_ng, dlo_g(i))
       dhi(i) = min(hi(i)+stencil_ng, dhi_g(i))
       slo(i) = dlo(i) + stencil_ng
       shi(i) = dhi(i) - stencil_ng

       if (dlo(i) .eq. lo(i)) then
          physbclo(i) = .true.
       else
          physbclo(i) = .false.
       end if

       if (dhi(i) .eq. hi(i)) then
          physbchi(i) = .true.
       else
          physbchi(i) = .false.
       end if
    end do

    do i=1,3
       dxinv(i) = 1.0d0 / dx(i)
    end do

    allocate(tmpx(dlo(1):dhi(1)))
    allocate(tmpy(lo(1) : hi(1),dlo(2):dhi(2)))
    allocate(tmpz(lo(1) : hi(1), lo(2): hi(2),dlo(3):dhi(3)))

    allocate(rhs(lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),ncons))
    rhs = 0.d0

    ! ------- BEGIN x-direction -------

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)

          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
!EXPAND                  first_deriv_8( cons(i-4:i+4,j,k,imx) ) 
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
                ( D8(1)*(cons(i+1,j,k,imx)-cons(i-1,j,k,imx)) &
                + D8(2)*(cons(i+2,j,k,imx)-cons(i-2,j,k,imx)) &
                + D8(3)*(cons(i+3,j,k,imx)-cons(i-3,j,k,imx)) &
                + D8(4)*(cons(i+4,j,k,imx)-cons(i-4,j,k,imx)) )
          end do

          do i=dlo(1),dhi(1)
             tmpx(i) = cons(i,j,k,imx)*q(i,j,k,qu)+q(i,j,k,qpres)
          end do
          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * first_deriv_8(tmpx(i-4:i+4))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
                ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
          end do

          do i=dlo(1),dhi(1)
             tmpx(i) = cons(i,j,k,imy)*q(i,j,k,qu)
          end do
          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * first_deriv_8(tmpx(i-4:i+4))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
                ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
          end do

          do i=dlo(1),dhi(1)
             tmpx(i) = cons(i,j,k,imz)*q(i,j,k,qu)
          end do
          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * first_deriv_8(tmpx(i-4:i+4))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
                ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
          end do

          do i=dlo(1),dhi(1)
             tmpx(i) = (cons(i,j,k,iene)+q(i,j,k,qpres))*q(i,j,k,qu)
          end do
          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * first_deriv_8(tmpx(i-4:i+4))
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
                ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
          end do

       enddo
    enddo

    do n = iry1, iry1+nspecies-1
       do k=lo(3),hi(3)
          do j=lo(2),hi(2)
    
             do i=dlo(1),dhi(1)
                tmpx(i) = cons(i,j,k,n)*q(i,j,k,qu)
             end do
             do i=slo(1),shi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * first_deriv_8(tmpx(i-4:i+4))
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
                   ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                   + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                   + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                   + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
             end do

          enddo
       enddo
    enddo

    ! ------- END x-direction -------

    ! ------- BEGIN y-direction -------

    do k=lo(3),hi(3)
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(2) * &
!EXPAND                  first_deriv_8( cons(i,j-4:j+4,k,imy) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(2) * &
                ( D8(1)*(cons(i,j+1,k,imy)-cons(i,j-1,k,imy)) &
                + D8(2)*(cons(i,j+2,k,imy)-cons(i,j-2,k,imy)) &
                + D8(3)*(cons(i,j+3,k,imy)-cons(i,j-3,k,imy)) &
                + D8(4)*(cons(i,j+4,k,imy)-cons(i,j-4,k,imy)) )
          end do
       end do

       do j=dlo(2),dhi(2)
          do i=lo(1),hi(1)
             tmpy(i,j) = cons(i,j,k,imx)*q(i,j,k,qv)
          end do
       end do
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(2) * first_deriv_8(tmpy(i,j-4:j+4))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(2) * &
                ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
          enddo
       enddo

       do j=dlo(2),dhi(2)
          do i=lo(1),hi(1)
             tmpy(i,j) = cons(i,j,k,imy)*q(i,j,k,qv)+q(i,j,k,qpres)
          end do
       end do
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(2) * first_deriv_8(tmpy(i,j-4:j+4))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(2) * &
                ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
          enddo
       enddo

       do j=dlo(2),dhi(2)
          do i=lo(1),hi(1)
             tmpy(i,j) = cons(i,j,k,imz)*q(i,j,k,qv)
          end do
       end do
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(2) * first_deriv_8(tmpy(i,j-4:j+4))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(2) * &
                ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
          enddo
       enddo

       do j=dlo(2),dhi(2)
          do i=lo(1),hi(1)
             tmpy(i,j) = (cons(i,j,k,iene)+q(i,j,k,qpres))*q(i,j,k,qv)
          end do
       end do
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(2) * first_deriv_8(tmpy(i,j-4:j+4))
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(2) * &
                ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
          enddo
       enddo
    enddo

    do n = iry1, iry1+nspecies-1
       do k=lo(3),hi(3)
          do j=dlo(2),dhi(2)
             do i=lo(1),hi(1)
                tmpy(i,j) = cons(i,j,k,n)*q(i,j,k,qv)
             end do
          end do
          do j=slo(2),shi(2)
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * first_deriv_8(tmpy(i,j-4:j+4))
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
                   ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                   + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                   + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                   + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
             end do
          enddo
       enddo
    enddo

    ! ------- END y-direction -------

    ! ------- BEGIN z-direction -------

    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(3) * &
!EXPAND                  first_deriv_8( cons(i,j,k-4:k+4,imz) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(3) * &
                ( D8(1)*(cons(i,j,k+1,imz)-cons(i,j,k-1,imz)) &
                + D8(2)*(cons(i,j,k+2,imz)-cons(i,j,k-2,imz)) &
                + D8(3)*(cons(i,j,k+3,imz)-cons(i,j,k-3,imz)) &
                + D8(4)*(cons(i,j,k+4,imz)-cons(i,j,k-4,imz)) )
          end do
       end do
    end do

    do k=dlo(3),dhi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             tmpz(i,j,k) = cons(i,j,k,imx) * q(i,j,k,qw)
          end do
       end do
    end do
    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(3) * first_deriv_8(tmpz(i,j,k-4:k+4))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(3) * &
                ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
          end do
       end do
    end do

    do k=dlo(3),dhi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             tmpz(i,j,k) = cons(i,j,k,imy) * q(i,j,k,qw)
          end do
       end do
    end do
    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(3) * first_deriv_8(tmpz(i,j,k-4:k+4))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(3) * &
                ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
          end do
       end do
    end do

    do k=dlo(3),dhi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             tmpz(i,j,k) = cons(i,j,k,imz)*q(i,j,k,qw) + q(i,j,k,qpres)
          end do
       end do
    end do
    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(3) * first_deriv_8(tmpz(i,j,k-4:k+4))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(3) * &
                ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
          end do
       end do
    end do

    do k=dlo(3),dhi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             tmpz(i,j,k) = (cons(i,j,k,iene)+q(i,j,k,qpres))*q(i,j,k,qw)
          end do
       end do
    end do
    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(3) * first_deriv_8(tmpz(i,j,k-4:k+4))
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(3) * &
                ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
          end do
       end do
    end do

    do n = iry1, iry1+nspecies-1
       do k=dlo(3),dhi(3)
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
                tmpz(i,j,k) = cons(i,j,k,n)*q(i,j,k,qw)
             end do
          end do
       end do
       do k=slo(3),shi(3)
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * first_deriv_8(tmpz(i,j,k-4:k+4))
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
                   ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                   + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                   + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                   + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
             end do
          end do
       end do
    enddo

    ! ----------------- boundary -----------------------

    !
    ! ----- lo-x boundary -----
    !
    if (physbclo(1)) then 
       do k=lo(3),hi(3)
          do j=lo(2),hi(2)

             ! if (bclo(1) .eq. WALL???) then
             !    i = lo(1)
             !    ! use completely right-biased stencil
             ! end if

             i = lo(1)+1
             ! use 3rd-order slightly right-biased stencil

             un(-1:2) = q(i-1:i+2,j,k,qu)

             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
                  first_deriv_r3( cons(i-1:i+2,j,k,imx) ) 

             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
                  first_deriv_r3( cons(i-1:i+2,j,k,imx)*un(-1:2)+q(i-1:i+2,j,k,qpres) )

             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
                  first_deriv_r3( cons(i-1:i+2,j,k,imy)*un(-1:2) ) 

             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
                  first_deriv_r3( cons(i-1:i+2,j,k,imz)*un(-1:2) ) 

             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
                  first_deriv_r3( (cons(i-1:i+2,j,k,iene)+q(i-1:i+2,j,k,qpres))*un(-1:2) )

             i = lo(1)+2
             ! use 4th-order stencil

             un(-2:2) = q(i-2:i+2,j,k,qu)

!EXPAND             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imx) ) 
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
                ( D4(1)*(cons(i+1,j,k,imx)-cons(i-1,j,k,imx)) &
                + D4(2)*(cons(i+2,j,k,imx)-cons(i-2,j,k,imx)) )

!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imx)*un(-2:2)+q(i-2:i+2,j,k,qpres) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
                ( D4(1)*((cons(i+1,j,k,imx)*un(1)+q(i+1,j,k,qpres))-(cons(i-1,j,k,imx)*un(-1)+q(i-1,j,k,qpres))) &
                + D4(2)*((cons(i+2,j,k,imx)*un(2)+q(i+2,j,k,qpres))-(cons(i-2,j,k,imx)*un(-2)+q(i-2,j,k,qpres))) )

!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imy)*un(-2:2) ) 
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
                ( D4(1)*(cons(i+1,j,k,imy)*un(1)-cons(i-1,j,k,imy)*un(-1)) &
                + D4(2)*(cons(i+2,j,k,imy)*un(2)-cons(i-2,j,k,imy)*un(-2)) )

!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imz)*un(-2:2) ) 
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
                ( D4(1)*(cons(i+1,j,k,imz)*un(1)-cons(i-1,j,k,imz)*un(-1)) &
                + D4(2)*(cons(i+2,j,k,imz)*un(2)-cons(i-2,j,k,imz)*un(-2)) )

!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
!EXPAND                  first_deriv_4( (cons(i-2:i+2,j,k,iene)+q(i-2:i+2,j,k,qpres))*un(-2:2) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
                ( D4(1)*((cons(i+1,j,k,iene)+q(i+1,j,k,qpres))*un(1)-(cons(i-1,j,k,iene)+q(i-1,j,k,qpres))*un(-1)) &
                + D4(2)*((cons(i+2,j,k,iene)+q(i+2,j,k,qpres))*un(2)-(cons(i-2,j,k,iene)+q(i-2,j,k,qpres))*un(-2)) )


             i = lo(1)+3
             ! use 6th-order stencil

             un(-3:3) = q(i-3:i+3,j,k,qu)

!EXPAND             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imx) ) 
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
                ( D6(1)*(cons(i+1,j,k,imx)-cons(i-1,j,k,imx)) &
                + D6(2)*(cons(i+2,j,k,imx)-cons(i-2,j,k,imx)) &
                + D6(3)*(cons(i+3,j,k,imx)-cons(i-3,j,k,imx)) )

!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imx)*un(-3:3)+q(i-3:i+3,j,k,qpres) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
                ( D6(1)*((cons(i+1,j,k,imx)*un(1)+q(i+1,j,k,qpres))-(cons(i-1,j,k,imx)*un(-1)+q(i-1,j,k,qpres))) &
                + D6(2)*((cons(i+2,j,k,imx)*un(2)+q(i+2,j,k,qpres))-(cons(i-2,j,k,imx)*un(-2)+q(i-2,j,k,qpres))) &
                + D6(3)*((cons(i+3,j,k,imx)*un(3)+q(i+3,j,k,qpres))-(cons(i-3,j,k,imx)*un(-3)+q(i-3,j,k,qpres))) )

!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imy)*un(-3:3) ) 
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
                ( D6(1)*(cons(i+1,j,k,imy)*un(1)-cons(i-1,j,k,imy)*un(-1)) &
                + D6(2)*(cons(i+2,j,k,imy)*un(2)-cons(i-2,j,k,imy)*un(-2)) &
                + D6(3)*(cons(i+3,j,k,imy)*un(3)-cons(i-3,j,k,imy)*un(-3)) )

!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imz)*un(-3:3) ) 
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
                ( D6(1)*(cons(i+1,j,k,imz)*un(1)-cons(i-1,j,k,imz)*un(-1)) &
                + D6(2)*(cons(i+2,j,k,imz)*un(2)-cons(i-2,j,k,imz)*un(-2)) &
                + D6(3)*(cons(i+3,j,k,imz)*un(3)-cons(i-3,j,k,imz)*un(-3)) )

!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
!EXPAND                  first_deriv_6( (cons(i-3:i+3,j,k,iene)+q(i-3:i+3,j,k,qpres))*un(-3:3) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
                ( D6(1)*((cons(i+1,j,k,iene)+q(i+1,j,k,qpres))*un(1)-(cons(i-1,j,k,iene)+q(i-1,j,k,qpres))*un(-1)) &
                + D6(2)*((cons(i+2,j,k,iene)+q(i+2,j,k,qpres))*un(2)-(cons(i-2,j,k,iene)+q(i-2,j,k,qpres))*un(-2)) &
                + D6(3)*((cons(i+3,j,k,iene)+q(i+3,j,k,qpres))*un(3)-(cons(i-3,j,k,iene)+q(i-3,j,k,qpres))*un(-3)) )

          enddo
       enddo

       do n = iry1, iry1+nspecies-1
          do k=lo(3),hi(3)
             do j=lo(2),hi(2)

                ! if (bclo(1) .eq. WALL???) then
                !    i = lo(1)
                !    ! use completely right-biased stencil
                ! end if
                
                i = lo(1)+1
                ! use 3rd-order slightly right-biased stencil
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
                     first_deriv_r3( cons(i-1:i+2,j,k,n)*q(i-1:i+2,j,k,qu) )

                i = lo(1)+2
                ! use 4th-order stencil
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
!EXPAND                     first_deriv_4( cons(i-2:i+2,j,k,n)*q(i-2:i+2,j,k,qu) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
                   ( D4(1)*(cons(i+1,j,k,n)*q(i+1,j,k,qu)-cons(i-1,j,k,n)*q(i-1,j,k,qu)) &
                   + D4(2)*(cons(i+2,j,k,n)*q(i+2,j,k,qu)-cons(i-2,j,k,n)*q(i-2,j,k,qu)) )

                i = lo(1)+3
                ! use 6th-order stencil
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
!EXPAND                     first_deriv_6( cons(i-3:i+3,j,k,n)*q(i-3:i+3,j,k,qu) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
                   ( D6(1)*(cons(i+1,j,k,n)*q(i+1,j,k,qu)-cons(i-1,j,k,n)*q(i-1,j,k,qu)) &
                   + D6(2)*(cons(i+2,j,k,n)*q(i+2,j,k,qu)-cons(i-2,j,k,n)*q(i-2,j,k,qu)) &
                   + D6(3)*(cons(i+3,j,k,n)*q(i+3,j,k,qu)-cons(i-3,j,k,n)*q(i-3,j,k,qu)) )
             end do
          end do
       end do
    end if

    !
    ! ----- hi-x boundary -----
    !
    if (physbchi(1)) then 
       do k=lo(3),hi(3)
          do j=lo(2),hi(2)
             
             i = hi(1)-3
             ! use 6th-order stencil

             un(-3:3) = q(i-3:i+3,j,k,qu)

!EXPAND             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imx) ) 
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
                ( D6(1)*(cons(i+1,j,k,imx)-cons(i-1,j,k,imx)) &
                + D6(2)*(cons(i+2,j,k,imx)-cons(i-2,j,k,imx)) &
                + D6(3)*(cons(i+3,j,k,imx)-cons(i-3,j,k,imx)) )

!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imx)*un(-3:3)+q(i-3:i+3,j,k,qpres) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
                ( D6(1)*((cons(i+1,j,k,imx)*un(1)+q(i+1,j,k,qpres))-(cons(i-1,j,k,imx)*un(-1)+q(i-1,j,k,qpres))) &
                + D6(2)*((cons(i+2,j,k,imx)*un(2)+q(i+2,j,k,qpres))-(cons(i-2,j,k,imx)*un(-2)+q(i-2,j,k,qpres))) &
                + D6(3)*((cons(i+3,j,k,imx)*un(3)+q(i+3,j,k,qpres))-(cons(i-3,j,k,imx)*un(-3)+q(i-3,j,k,qpres))) )

!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imy)*un(-3:3) ) 
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
                ( D6(1)*(cons(i+1,j,k,imy)*un(1)-cons(i-1,j,k,imy)*un(-1)) &
                + D6(2)*(cons(i+2,j,k,imy)*un(2)-cons(i-2,j,k,imy)*un(-2)) &
                + D6(3)*(cons(i+3,j,k,imy)*un(3)-cons(i-3,j,k,imy)*un(-3)) )

!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
!EXPAND                  first_deriv_6( cons(i-3:i+3,j,k,imz)*un(-3:3) ) 
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
                ( D6(1)*(cons(i+1,j,k,imz)*un(1)-cons(i-1,j,k,imz)*un(-1)) &
                + D6(2)*(cons(i+2,j,k,imz)*un(2)-cons(i-2,j,k,imz)*un(-2)) &
                + D6(3)*(cons(i+3,j,k,imz)*un(3)-cons(i-3,j,k,imz)*un(-3)) )

!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
!EXPAND                  first_deriv_6( (cons(i-3:i+3,j,k,iene)+q(i-3:i+3,j,k,qpres))*un(-3:3) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
                ( D6(1)*((cons(i+1,j,k,iene)+q(i+1,j,k,qpres))*un(1)-(cons(i-1,j,k,iene)+q(i-1,j,k,qpres))*un(-1)) &
                + D6(2)*((cons(i+2,j,k,iene)+q(i+2,j,k,qpres))*un(2)-(cons(i-2,j,k,iene)+q(i-2,j,k,qpres))*un(-2)) &
                + D6(3)*((cons(i+3,j,k,iene)+q(i+3,j,k,qpres))*un(3)-(cons(i-3,j,k,iene)+q(i-3,j,k,qpres))*un(-3)) )

             i = hi(1)-2
             ! use 4th-order stencil

             un(-2:2) = q(i-2:i+2,j,k,qu)

!EXPAND             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imx) ) 
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
                ( D4(1)*(cons(i+1,j,k,imx)-cons(i-1,j,k,imx)) &
                + D4(2)*(cons(i+2,j,k,imx)-cons(i-2,j,k,imx)) )

!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imx)*un(-2:2)+q(i-2:i+2,j,k,qpres) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
                ( D4(1)*((cons(i+1,j,k,imx)*un(1)+q(i+1,j,k,qpres))-(cons(i-1,j,k,imx)*un(-1)+q(i-1,j,k,qpres))) &
                + D4(2)*((cons(i+2,j,k,imx)*un(2)+q(i+2,j,k,qpres))-(cons(i-2,j,k,imx)*un(-2)+q(i-2,j,k,qpres))) )

!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imy)*un(-2:2) ) 
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
                ( D4(1)*(cons(i+1,j,k,imy)*un(1)-cons(i-1,j,k,imy)*un(-1)) &
                + D4(2)*(cons(i+2,j,k,imy)*un(2)-cons(i-2,j,k,imy)*un(-2)) )

!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
!EXPAND                  first_deriv_4( cons(i-2:i+2,j,k,imz)*un(-2:2) ) 
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
                ( D4(1)*(cons(i+1,j,k,imz)*un(1)-cons(i-1,j,k,imz)*un(-1)) &
                + D4(2)*(cons(i+2,j,k,imz)*un(2)-cons(i-2,j,k,imz)*un(-2)) )

!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
!EXPAND                  first_deriv_4( (cons(i-2:i+2,j,k,iene)+q(i-2:i+2,j,k,qpres))*un(-2:2) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
                ( D4(1)*((cons(i+1,j,k,iene)+q(i+1,j,k,qpres))*un(1)-(cons(i-1,j,k,iene)+q(i-1,j,k,qpres))*un(-1)) &
                + D4(2)*((cons(i+2,j,k,iene)+q(i+2,j,k,qpres))*un(2)-(cons(i-2,j,k,iene)+q(i-2,j,k,qpres))*un(-2)) )

             i = hi(1)-1
             ! use 3rd-order slightly left-biased stencil

             un(-2:1) = q(i-2:i+1,j,k,qu)

             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(1) * &
                  first_deriv_l3( cons(i-2:i+1,j,k,imx) ) 

             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(1) * &
                  first_deriv_l3( cons(i-2:i+1,j,k,imx)*un(-2:1)+q(i-2:i+1,j,k,qpres) )

             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(1) * &
                  first_deriv_l3( cons(i-2:i+1,j,k,imy)*un(-2:1) ) 

             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(1) * &
                  first_deriv_l3( cons(i-2:i+1,j,k,imz)*un(-2:1) ) 

             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(1) * &
                  first_deriv_l3( (cons(i-2:i+1,j,k,iene)+q(i-2:i+1,j,k,qpres))*un(-2:1) )


             ! if (bchi(1) .eq. WALL???) then
             !    i = hi(1)
             !    ! use completely left-biased stencil
             ! end if

          enddo
       enddo
       
       do n = iry1, iry1+nspecies-1
          do k=lo(3),hi(3)
             do j=lo(2),hi(2)
                
                i = hi(1)-3
                ! use 6th-order stencil
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
!EXPAND                     first_deriv_6( cons(i-3:i+3,j,k,n)*q(i-3:i+3,j,k,qu) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
                   ( D6(1)*(cons(i+1,j,k,n)*q(i+1,j,k,qu)-cons(i-1,j,k,n)*q(i-1,j,k,qu)) &
                   + D6(2)*(cons(i+2,j,k,n)*q(i+2,j,k,qu)-cons(i-2,j,k,n)*q(i-2,j,k,qu)) &
                   + D6(3)*(cons(i+3,j,k,n)*q(i+3,j,k,qu)-cons(i-3,j,k,n)*q(i-3,j,k,qu)) )
                
                i = hi(1)-2
                ! use 4th-order stencil
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
!EXPAND                     first_deriv_4( cons(i-2:i+2,j,k,n)*q(i-2:i+2,j,k,qu) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
                   ( D4(1)*(cons(i+1,j,k,n)*q(i+1,j,k,qu)-cons(i-1,j,k,n)*q(i-1,j,k,qu)) &
                   + D4(2)*(cons(i+2,j,k,n)*q(i+2,j,k,qu)-cons(i-2,j,k,n)*q(i-2,j,k,qu)) )
                
                i = hi(1)-1
                ! use 3rd-order slightly left-biased stencil
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(1) * &
                     first_deriv_l3( cons(i-2:i+1,j,k,n)*q(i-2:i+1,j,k,qu) )
                
                ! if (bchi(1) .eq. WALL???) then
                !    i = hi(1)
                !    ! use completely left-biased stencil
                ! end if
                
             enddo
          enddo
       end do
    end if

    !
    ! ----- lo-y boundary -----
    !
    if (physbclo(2)) then 
       do k=lo(3),hi(3)

          ! if (bclo(2) .eq. WALL???) then
          !    j = lo(2)
          !    ! use completely right-biased stencil
          !    enddo
          ! end if

          j = lo(2)+1
          ! use 3rd-order slightly right-biased stencil

          do i=lo(1),hi(1)

             un(-1:2) = q(i,j-1:j+2,k,qv)

             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(2) * &
                  first_deriv_r3( cons(i,j-1:j+2,k,imy) )

             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(2) * &
                  first_deriv_r3( cons(i,j-1:j+2,k,imx)*un(-1:2) )

             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(2) * &
                  first_deriv_r3( cons(i,j-1:j+2,k,imy)*un(-1:2)+q(i,j-1:j+2,k,qpres) )

             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(2) * &
                  first_deriv_r3( cons(i,j-1:j+2,k,imz)*un(-1:2) )

             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(2) * &
                  first_deriv_r3( (cons(i,j-1:j+2,k,iene)+q(i,j-1:j+2,k,qpres))*un(-1:2) )

          enddo

          j = lo(2)+2
          ! use 4th-order stencil

          do i=lo(1),hi(1)

             un(-2:2) = q(i,j-2:j+2,k,qv)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imy) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(2) * &
                ( D4(1)*(cons(i,j+1,k,imy)-cons(i,j-1,k,imy)) &
                + D4(2)*(cons(i,j+2,k,imy)-cons(i,j-2,k,imy)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imx)*un(-2:2) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(2) * &
                ( D4(1)*(cons(i,j+1,k,imx)*un(1)-cons(i,j-1,k,imx)*un(-1)) &
                + D4(2)*(cons(i,j+2,k,imx)*un(2)-cons(i,j-2,k,imx)*un(-2)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imy)*un(-2:2)+q(i,j-2:j+2,k,qpres) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(2) * &
                ( D4(1)*((cons(i,j+1,k,imy)*un(1)+q(i,j+1,k,qpres))-(cons(i,j-1,k,imy)*un(-1)+q(i,j-1,k,qpres))) &
                + D4(2)*((cons(i,j+2,k,imy)*un(2)+q(i,j+2,k,qpres))-(cons(i,j-2,k,imy)*un(-2)+q(i,j-2,k,qpres))) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imz)*un(-2:2) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(2) * &
                ( D4(1)*(cons(i,j+1,k,imz)*un(1)-cons(i,j-1,k,imz)*un(-1)) &
                + D4(2)*(cons(i,j+2,k,imz)*un(2)-cons(i,j-2,k,imz)*un(-2)) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(2) * &
!EXPAND                  first_deriv_4( (cons(i,j-2:j+2,k,iene)+q(i,j-2:j+2,k,qpres))*un(-2:2) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(2) * &
                ( D4(1)*((cons(i,j+1,k,iene)+q(i,j+1,k,qpres))*un(1)-(cons(i,j-1,k,iene)+q(i,j-1,k,qpres))*un(-1)) &
                + D4(2)*((cons(i,j+2,k,iene)+q(i,j+2,k,qpres))*un(2)-(cons(i,j-2,k,iene)+q(i,j-2,k,qpres))*un(-2)) )

          enddo

          j = lo(2)+3
          ! use 6th-order stencil

          do i=lo(1),hi(1)

             un(-3:3) = q(i,j-3:j+3,k,qv)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imy) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(2) * &
                ( D6(1)*(cons(i,j+1,k,imy)-cons(i,j-1,k,imy)) &
                + D6(2)*(cons(i,j+2,k,imy)-cons(i,j-2,k,imy)) &
                + D6(3)*(cons(i,j+3,k,imy)-cons(i,j-3,k,imy)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imx)*un(-3:3) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(2) * &
                ( D6(1)*(cons(i,j+1,k,imx)*un(1)-cons(i,j-1,k,imx)*un(-1)) &
                + D6(2)*(cons(i,j+2,k,imx)*un(2)-cons(i,j-2,k,imx)*un(-2)) &
                + D6(3)*(cons(i,j+3,k,imx)*un(3)-cons(i,j-3,k,imx)*un(-3)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imy)*un(-3:3)+q(i,j-3:j+3,k,qpres) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(2) * &
                ( D6(1)*((cons(i,j+1,k,imy)*un(1)+q(i,j+1,k,qpres))-(cons(i,j-1,k,imy)*un(-1)+q(i,j-1,k,qpres))) &
                + D6(2)*((cons(i,j+2,k,imy)*un(2)+q(i,j+2,k,qpres))-(cons(i,j-2,k,imy)*un(-2)+q(i,j-2,k,qpres))) &
                + D6(3)*((cons(i,j+3,k,imy)*un(3)+q(i,j+3,k,qpres))-(cons(i,j-3,k,imy)*un(-3)+q(i,j-3,k,qpres))) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imz)*un(-3:3) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(2) * &
                ( D6(1)*(cons(i,j+1,k,imz)*un(1)-cons(i,j-1,k,imz)*un(-1)) &
                + D6(2)*(cons(i,j+2,k,imz)*un(2)-cons(i,j-2,k,imz)*un(-2)) &
                + D6(3)*(cons(i,j+3,k,imz)*un(3)-cons(i,j-3,k,imz)*un(-3)) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(2) * &
!EXPAND                  first_deriv_6( (cons(i,j-3:j+3,k,iene)+q(i,j-3:j+3,k,qpres))*un(-3:3) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(2) * &
                ( D6(1)*((cons(i,j+1,k,iene)+q(i,j+1,k,qpres))*un(1)-(cons(i,j-1,k,iene)+q(i,j-1,k,qpres))*un(-1)) &
                + D6(2)*((cons(i,j+2,k,iene)+q(i,j+2,k,qpres))*un(2)-(cons(i,j-2,k,iene)+q(i,j-2,k,qpres))*un(-2)) &
                + D6(3)*((cons(i,j+3,k,iene)+q(i,j+3,k,qpres))*un(3)-(cons(i,j-3,k,iene)+q(i,j-3,k,qpres))*un(-3)) )

          enddo

       enddo

       do n = iry1, iry1+nspecies-1
          do k=lo(3),hi(3)

             ! if (bclo(2) .eq. WALL???) then
             !    j = lo(2)
             !    ! use completely right-biased stencil
             !    enddo
             ! end if
             
             j = lo(2)+1
             ! use 3rd-order slightly right-biased stencil
             do i=lo(1),hi(1)
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
                     first_deriv_r3( cons(i,j-1:j+2,k,n)*q(i,j-1:j+2,k,qv) )
             end do

             j = lo(2)+2
             ! use 4th-order stencil
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
!EXPAND                     first_deriv_4( cons(i,j-2:j+2,k,n)*q(i,j-2:j+2,k,qv) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
                   ( D4(1)*(cons(i,j+1,k,n)*q(i,j+1,k,qv)-cons(i,j-1,k,n)*q(i,j-1,k,qv)) &
                   + D4(2)*(cons(i,j+2,k,n)*q(i,j+2,k,qv)-cons(i,j-2,k,n)*q(i,j-2,k,qv)) )
             end do

             j = lo(2)+3
             ! use 6th-order stencil
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
!EXPAND                     first_deriv_6( cons(i,j-3:j+3,k,n)*q(i,j-3:j+3,k,qv) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
                   ( D6(1)*(cons(i,j+1,k,n)*q(i,j+1,k,qv)-cons(i,j-1,k,n)*q(i,j-1,k,qv)) &
                   + D6(2)*(cons(i,j+2,k,n)*q(i,j+2,k,qv)-cons(i,j-2,k,n)*q(i,j-2,k,qv)) &
                   + D6(3)*(cons(i,j+3,k,n)*q(i,j+3,k,qv)-cons(i,j-3,k,n)*q(i,j-3,k,qv)) )
             end do

          end do
       end do
    end if

    !
    ! ----- hi-y boundary -----
    !
    if (physbchi(2)) then 
       do k=lo(3),hi(3)

          j = hi(2)-3
          ! use 6th-order stencil

          do i=lo(1),hi(1)

             un(-3:3) = q(i,j-3:j+3,k,qv)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imy) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(2) * &
                ( D6(1)*(cons(i,j+1,k,imy)-cons(i,j-1,k,imy)) &
                + D6(2)*(cons(i,j+2,k,imy)-cons(i,j-2,k,imy)) &
                + D6(3)*(cons(i,j+3,k,imy)-cons(i,j-3,k,imy)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imx)*un(-3:3) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(2) * &
                ( D6(1)*(cons(i,j+1,k,imx)*un(1)-cons(i,j-1,k,imx)*un(-1)) &
                + D6(2)*(cons(i,j+2,k,imx)*un(2)-cons(i,j-2,k,imx)*un(-2)) &
                + D6(3)*(cons(i,j+3,k,imx)*un(3)-cons(i,j-3,k,imx)*un(-3)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imy)*un(-3:3)+q(i,j-3:j+3,k,qpres) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(2) * &
                ( D6(1)*((cons(i,j+1,k,imy)*un(1)+q(i,j+1,k,qpres))-(cons(i,j-1,k,imy)*un(-1)+q(i,j-1,k,qpres))) &
                + D6(2)*((cons(i,j+2,k,imy)*un(2)+q(i,j+2,k,qpres))-(cons(i,j-2,k,imy)*un(-2)+q(i,j-2,k,qpres))) &
                + D6(3)*((cons(i,j+3,k,imy)*un(3)+q(i,j+3,k,qpres))-(cons(i,j-3,k,imy)*un(-3)+q(i,j-3,k,qpres))) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(2) * &
!EXPAND                  first_deriv_6( cons(i,j-3:j+3,k,imz)*un(-3:3) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(2) * &
                ( D6(1)*(cons(i,j+1,k,imz)*un(1)-cons(i,j-1,k,imz)*un(-1)) &
                + D6(2)*(cons(i,j+2,k,imz)*un(2)-cons(i,j-2,k,imz)*un(-2)) &
                + D6(3)*(cons(i,j+3,k,imz)*un(3)-cons(i,j-3,k,imz)*un(-3)) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(2) * &
!EXPAND                  first_deriv_6( (cons(i,j-3:j+3,k,iene)+q(i,j-3:j+3,k,qpres))*un(-3:3) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(2) * &
                ( D6(1)*((cons(i,j+1,k,iene)+q(i,j+1,k,qpres))*un(1)-(cons(i,j-1,k,iene)+q(i,j-1,k,qpres))*un(-1)) &
                + D6(2)*((cons(i,j+2,k,iene)+q(i,j+2,k,qpres))*un(2)-(cons(i,j-2,k,iene)+q(i,j-2,k,qpres))*un(-2)) &
                + D6(3)*((cons(i,j+3,k,iene)+q(i,j+3,k,qpres))*un(3)-(cons(i,j-3,k,iene)+q(i,j-3,k,qpres))*un(-3)) )

          enddo

          j = hi(2)-2
          ! use 4th-order stencil

          do i=lo(1),hi(1)

             un(-2:2) = q(i,j-2:j+2,k,qv)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imy) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(2) * &
                ( D4(1)*(cons(i,j+1,k,imy)-cons(i,j-1,k,imy)) &
                + D4(2)*(cons(i,j+2,k,imy)-cons(i,j-2,k,imy)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imx)*un(-2:2) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(2) * &
                ( D4(1)*(cons(i,j+1,k,imx)*un(1)-cons(i,j-1,k,imx)*un(-1)) &
                + D4(2)*(cons(i,j+2,k,imx)*un(2)-cons(i,j-2,k,imx)*un(-2)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imy)*un(-2:2)+q(i,j-2:j+2,k,qpres) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(2) * &
                ( D4(1)*((cons(i,j+1,k,imy)*un(1)+q(i,j+1,k,qpres))-(cons(i,j-1,k,imy)*un(-1)+q(i,j-1,k,qpres))) &
                + D4(2)*((cons(i,j+2,k,imy)*un(2)+q(i,j+2,k,qpres))-(cons(i,j-2,k,imy)*un(-2)+q(i,j-2,k,qpres))) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(2) * &
!EXPAND                  first_deriv_4( cons(i,j-2:j+2,k,imz)*un(-2:2) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(2) * &
                ( D4(1)*(cons(i,j+1,k,imz)*un(1)-cons(i,j-1,k,imz)*un(-1)) &
                + D4(2)*(cons(i,j+2,k,imz)*un(2)-cons(i,j-2,k,imz)*un(-2)) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(2) * &
!EXPAND                  first_deriv_4( (cons(i,j-2:j+2,k,iene)+q(i,j-2:j+2,k,qpres))*un(-2:2) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(2) * &
                ( D4(1)*((cons(i,j+1,k,iene)+q(i,j+1,k,qpres))*un(1)-(cons(i,j-1,k,iene)+q(i,j-1,k,qpres))*un(-1)) &
                + D4(2)*((cons(i,j+2,k,iene)+q(i,j+2,k,qpres))*un(2)-(cons(i,j-2,k,iene)+q(i,j-2,k,qpres))*un(-2)) )

          enddo

          j = hi(2)-1
          ! use 3rd-order slightly left-biased stencil

          do i=lo(1),hi(1)

             un(-2:1) = q(i,j-2:j+1,k,qv)

             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(2) * &
                  first_deriv_l3( cons(i,j-2:j+1,k,imy) )

             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(2) * &
                  first_deriv_l3( cons(i,j-2:j+1,k,imx)*un(-2:1) )

             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(2) * &
                  first_deriv_l3( cons(i,j-2:j+1,k,imy)*un(-2:1)+q(i,j-2:j+1,k,qpres) )

             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(2) * &
                  first_deriv_l3( cons(i,j-2:j+1,k,imz)*un(-2:1) )

             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(2) * &
                  first_deriv_l3( (cons(i,j-2:j+1,k,iene)+q(i,j-2:j+1,k,qpres))*un(-2:1) )

          enddo

          ! if (bchi(2) .eq. WALL???) then
          !    j = hi(2)
          !    ! use completely left-biased stencil
          ! end if

       enddo

       do n = iry1, iry1+nspecies-1
          do k=lo(3),hi(3)

             j = hi(2)-3
             ! use 6th-order stencil
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
!EXPAND                     first_deriv_6( cons(i,j-3:j+3,k,n)*q(i,j-3:j+3,k,qv) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
                   ( D6(1)*(cons(i,j+1,k,n)*q(i,j+1,k,qv)-cons(i,j-1,k,n)*q(i,j-1,k,qv)) &
                   + D6(2)*(cons(i,j+2,k,n)*q(i,j+2,k,qv)-cons(i,j-2,k,n)*q(i,j-2,k,qv)) &
                   + D6(3)*(cons(i,j+3,k,n)*q(i,j+3,k,qv)-cons(i,j-3,k,n)*q(i,j-3,k,qv)) )
             end do

             j = hi(2)-2
             ! use 4th-order stencil
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
!EXPAND                     first_deriv_4( cons(i,j-2:j+2,k,n)*q(i,j-2:j+2,k,qv) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
                   ( D4(1)*(cons(i,j+1,k,n)*q(i,j+1,k,qv)-cons(i,j-1,k,n)*q(i,j-1,k,qv)) &
                   + D4(2)*(cons(i,j+2,k,n)*q(i,j+2,k,qv)-cons(i,j-2,k,n)*q(i,j-2,k,qv)) )
             end do

             j = hi(2)-1
             ! use 3rd-order slightly left-biased stencil
             do i=lo(1),hi(1)
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(2) * &
                     first_deriv_l3( cons(i,j-2:j+1,k,n)*q(i,j-2:j+1,k,qv) )
             end do

             ! if (bchi(2) .eq. WALL???) then
             !    j = hi(2)
             !    ! use completely left-biased stencil
             ! end if

          end do
       end do
    end if

    !
    ! ----- lo-z boundary -----
    !
    if (physbclo(3)) then

       ! if (bclo(3) .eq. WALL???) then
       !    k = lo(3)
       !    ! use completely right-biased stencil
       ! end if

       k = lo(3)+1
       ! use 3rd-order slightly right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             un(-1:2) = q(i,j,k-1:k+2,qw)

             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(3) * &
                  first_deriv_r3( cons(i,j,k-1:k+2,imz) )

             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(3) * &
                  first_deriv_r3( cons(i,j,k-1:k+2,imx)*un(-1:2) )

             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(3) * &
                  first_deriv_r3( cons(i,j,k-1:k+2,imy)*un(-1:2) )

             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(3) * &
                  first_deriv_r3( cons(i,j,k-1:k+2,imz)*un(-1:2)+q(i,j,k-1:k+2,qpres) )

             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(3) * &
                  first_deriv_r3( (cons(i,j,k-1:k+2,iene)+q(i,j,k-1:k+2,qpres))*un(-1:2) )

          enddo
       enddo

       do n = iry1, iry1+nspecies-1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
                     first_deriv_r3( cons(i,j,k-1:k+2,n)*q(i,j,k-1:k+2,qw) )
             end do
          end do
       end do

       k = lo(3)+2
       ! use 4th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             un(-2:2) = q(i,j,k-2:k+2,qw)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imz) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(3) * &
                ( D4(1)*(cons(i,j,k+1,imz)-cons(i,j,k-1,imz)) &
                + D4(2)*(cons(i,j,k+2,imz)-cons(i,j,k-2,imz)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imx)*un(-2:2) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(3) * &
                ( D4(1)*(cons(i,j,k+1,imx)*un(1)-cons(i,j,k-1,imx)*un(-1)) &
                + D4(2)*(cons(i,j,k+2,imx)*un(2)-cons(i,j,k-2,imx)*un(-2)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imy)*un(-2:2) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(3) * &
                ( D4(1)*(cons(i,j,k+1,imy)*un(1)-cons(i,j,k-1,imy)*un(-1)) &
                + D4(2)*(cons(i,j,k+2,imy)*un(2)-cons(i,j,k-2,imy)*un(-2)) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imz)*un(-2:2)+q(i,j,k-2:k+2,qpres) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(3) * &
                ( D4(1)*((cons(i,j,k+1,imz)*un(1)+q(i,j,k+1,qpres))-(cons(i,j,k-1,imz)*un(-1)+q(i,j,k-1,qpres))) &
                + D4(2)*((cons(i,j,k+2,imz)*un(2)+q(i,j,k+2,qpres))-(cons(i,j,k-2,imz)*un(-2)+q(i,j,k-2,qpres))) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(3) * &
!EXPAND                  first_deriv_4( (cons(i,j,k-2:k+2,iene)+q(i,j,k-2:k+2,qpres))*un(-2:2) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(3) * &
                ( D4(1)*((cons(i,j,k+1,iene)+q(i,j,k+1,qpres))*un(1)-(cons(i,j,k-1,iene)+q(i,j,k-1,qpres))*un(-1)) &
                + D4(2)*((cons(i,j,k+2,iene)+q(i,j,k+2,qpres))*un(2)-(cons(i,j,k-2,iene)+q(i,j,k-2,qpres))*un(-2)) )

          enddo
       enddo

       do n = iry1, iry1+nspecies-1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
!EXPAND                     first_deriv_4( cons(i,j,k-2:k+2,n)*q(i,j,k-2:k+2,qw) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
                   ( D4(1)*(cons(i,j,k+1,n)*q(i,j,k+1,qw)-cons(i,j,k-1,n)*q(i,j,k-1,qw)) &
                   + D4(2)*(cons(i,j,k+2,n)*q(i,j,k+2,qw)-cons(i,j,k-2,n)*q(i,j,k-2,qw)) )
             end do
          end do
       end do

       k = lo(3)+3
       ! use 6th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             un(-3:3) = q(i,j,k-3:k+3,qw)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imz) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(3) * &
                ( D6(1)*(cons(i,j,k+1,imz)-cons(i,j,k-1,imz)) &
                + D6(2)*(cons(i,j,k+2,imz)-cons(i,j,k-2,imz)) &
                + D6(3)*(cons(i,j,k+3,imz)-cons(i,j,k-3,imz)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imx)*un(-3:3) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(3) * &
                ( D6(1)*(cons(i,j,k+1,imx)*un(1)-cons(i,j,k-1,imx)*un(-1)) &
                + D6(2)*(cons(i,j,k+2,imx)*un(2)-cons(i,j,k-2,imx)*un(-2)) &
                + D6(3)*(cons(i,j,k+3,imx)*un(3)-cons(i,j,k-3,imx)*un(-3)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imy)*un(-3:3) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(3) * &
                ( D6(1)*(cons(i,j,k+1,imy)*un(1)-cons(i,j,k-1,imy)*un(-1)) &
                + D6(2)*(cons(i,j,k+2,imy)*un(2)-cons(i,j,k-2,imy)*un(-2)) &
                + D6(3)*(cons(i,j,k+3,imy)*un(3)-cons(i,j,k-3,imy)*un(-3)) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imz)*un(-3:3)+q(i,j,k-3:k+3,qpres) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(3) * &
                ( D6(1)*((cons(i,j,k+1,imz)*un(1)+q(i,j,k+1,qpres))-(cons(i,j,k-1,imz)*un(-1)+q(i,j,k-1,qpres))) &
                + D6(2)*((cons(i,j,k+2,imz)*un(2)+q(i,j,k+2,qpres))-(cons(i,j,k-2,imz)*un(-2)+q(i,j,k-2,qpres))) &
                + D6(3)*((cons(i,j,k+3,imz)*un(3)+q(i,j,k+3,qpres))-(cons(i,j,k-3,imz)*un(-3)+q(i,j,k-3,qpres))) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(3) * &
!EXPAND                  first_deriv_6( (cons(i,j,k-3:k+3,iene)+q(i,j,k-3:k+3,qpres))*un(-3:3) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(3) * &
                ( D6(1)*((cons(i,j,k+1,iene)+q(i,j,k+1,qpres))*un(1)-(cons(i,j,k-1,iene)+q(i,j,k-1,qpres))*un(-1)) &
                + D6(2)*((cons(i,j,k+2,iene)+q(i,j,k+2,qpres))*un(2)-(cons(i,j,k-2,iene)+q(i,j,k-2,qpres))*un(-2)) &
                + D6(3)*((cons(i,j,k+3,iene)+q(i,j,k+3,qpres))*un(3)-(cons(i,j,k-3,iene)+q(i,j,k-3,qpres))*un(-3)) )

          enddo
       enddo

       do n = iry1, iry1+nspecies-1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
!EXPAND                     first_deriv_6( cons(i,j,k-3:k+3,n)*q(i,j,k-3:k+3,qw) )
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
                   ( D6(1)*(cons(i,j,k+1,n)*q(i,j,k+1,qw)-cons(i,j,k-1,n)*q(i,j,k-1,qw)) &
                   + D6(2)*(cons(i,j,k+2,n)*q(i,j,k+2,qw)-cons(i,j,k-2,n)*q(i,j,k-2,qw)) &
                   + D6(3)*(cons(i,j,k+3,n)*q(i,j,k+3,qw)-cons(i,j,k-3,n)*q(i,j,k-3,qw)) )
             end do
          end do
       end do
    end if

    !
    ! ----- hi-z boundary -----
    !
    if (physbchi(3)) then

       k = hi(3)-3
       ! use 6th-order stencil
       
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             un(-3:3) = q(i,j,k-3:k+3,qw)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imz) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(3) * &
                ( D6(1)*(cons(i,j,k+1,imz)-cons(i,j,k-1,imz)) &
                + D6(2)*(cons(i,j,k+2,imz)-cons(i,j,k-2,imz)) &
                + D6(3)*(cons(i,j,k+3,imz)-cons(i,j,k-3,imz)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imx)*un(-3:3) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(3) * &
                ( D6(1)*(cons(i,j,k+1,imx)*un(1)-cons(i,j,k-1,imx)*un(-1)) &
                + D6(2)*(cons(i,j,k+2,imx)*un(2)-cons(i,j,k-2,imx)*un(-2)) &
                + D6(3)*(cons(i,j,k+3,imx)*un(3)-cons(i,j,k-3,imx)*un(-3)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imy)*un(-3:3) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(3) * &
                ( D6(1)*(cons(i,j,k+1,imy)*un(1)-cons(i,j,k-1,imy)*un(-1)) &
                + D6(2)*(cons(i,j,k+2,imy)*un(2)-cons(i,j,k-2,imy)*un(-2)) &
                + D6(3)*(cons(i,j,k+3,imy)*un(3)-cons(i,j,k-3,imy)*un(-3)) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(3) * &
!EXPAND                  first_deriv_6( cons(i,j,k-3:k+3,imz)*un(-3:3)+q(i,j,k-3:k+3,qpres) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(3) * &
                ( D6(1)*((cons(i,j,k+1,imz)*un(1)+q(i,j,k+1,qpres))-(cons(i,j,k-1,imz)*un(-1)+q(i,j,k-1,qpres))) &
                + D6(2)*((cons(i,j,k+2,imz)*un(2)+q(i,j,k+2,qpres))-(cons(i,j,k-2,imz)*un(-2)+q(i,j,k-2,qpres))) &
                + D6(3)*((cons(i,j,k+3,imz)*un(3)+q(i,j,k+3,qpres))-(cons(i,j,k-3,imz)*un(-3)+q(i,j,k-3,qpres))) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(3) * &
!EXPAND                  first_deriv_6( (cons(i,j,k-3:k+3,iene)+q(i,j,k-3:k+3,qpres))*un(-3:3) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(3) * &
                ( D6(1)*((cons(i,j,k+1,iene)+q(i,j,k+1,qpres))*un(1)-(cons(i,j,k-1,iene)+q(i,j,k-1,qpres))*un(-1)) &
                + D6(2)*((cons(i,j,k+2,iene)+q(i,j,k+2,qpres))*un(2)-(cons(i,j,k-2,iene)+q(i,j,k-2,qpres))*un(-2)) &
                + D6(3)*((cons(i,j,k+3,iene)+q(i,j,k+3,qpres))*un(3)-(cons(i,j,k-3,iene)+q(i,j,k-3,qpres))*un(-3)) )

          enddo
       enddo

       do n = iry1, iry1+nspecies-1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
!EXPAND                     first_deriv_6(cons(i,j,k-3:k+3,n)*q(i,j,k-3:k+3,qw))
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
                   ( D6(1)*(cons(i,j,k+1,n)*q(i,j,k+1,qw)-cons(i,j,k-1,n)*q(i,j,k-1,qw)) &
                   + D6(2)*(cons(i,j,k+2,n)*q(i,j,k+2,qw)-cons(i,j,k-2,n)*q(i,j,k-2,qw)) &
                   + D6(3)*(cons(i,j,k+3,n)*q(i,j,k+3,qw)-cons(i,j,k-3,n)*q(i,j,k-3,qw)) )
             end do
          enddo
       end do

       k = hi(3)-2
       ! use 4th-order stencil
       
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             un(-2:2) = q(i,j,k-2:k+2,qw)

!EXPAND             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imz) )
             rhs(i,j,k,irho) = rhs(i,j,k,irho) - dxinv(3) * &
                ( D4(1)*(cons(i,j,k+1,imz)-cons(i,j,k-1,imz)) &
                + D4(2)*(cons(i,j,k+2,imz)-cons(i,j,k-2,imz)) )

!EXPAND             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imx)*un(-2:2) )
             rhs(i,j,k,imx) = rhs(i,j,k,imx) - dxinv(3) * &
                ( D4(1)*(cons(i,j,k+1,imx)*un(1)-cons(i,j,k-1,imx)*un(-1)) &
                + D4(2)*(cons(i,j,k+2,imx)*un(2)-cons(i,j,k-2,imx)*un(-2)) )

!EXPAND             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imy)*un(-2:2) )
             rhs(i,j,k,imy) = rhs(i,j,k,imy) - dxinv(3) * &
                ( D4(1)*(cons(i,j,k+1,imy)*un(1)-cons(i,j,k-1,imy)*un(-1)) &
                + D4(2)*(cons(i,j,k+2,imy)*un(2)-cons(i,j,k-2,imy)*un(-2)) )

!EXPAND             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(3) * &
!EXPAND                  first_deriv_4( cons(i,j,k-2:k+2,imz)*un(-2:2)+q(i,j,k-2:k+2,qpres) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz) - dxinv(3) * &
                ( D4(1)*((cons(i,j,k+1,imz)*un(1)+q(i,j,k+1,qpres))-(cons(i,j,k-1,imz)*un(-1)+q(i,j,k-1,qpres))) &
                + D4(2)*((cons(i,j,k+2,imz)*un(2)+q(i,j,k+2,qpres))-(cons(i,j,k-2,imz)*un(-2)+q(i,j,k-2,qpres))) )

!EXPAND             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(3) * &
!EXPAND                  first_deriv_4( (cons(i,j,k-2:k+2,iene)+q(i,j,k-2:k+2,qpres))*un(-2:2) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene) - dxinv(3) * &
                ( D4(1)*((cons(i,j,k+1,iene)+q(i,j,k+1,qpres))*un(1)-(cons(i,j,k-1,iene)+q(i,j,k-1,qpres))*un(-1)) &
                + D4(2)*((cons(i,j,k+2,iene)+q(i,j,k+2,qpres))*un(2)-(cons(i,j,k-2,iene)+q(i,j,k-2,qpres))*un(-2)) )

          enddo
       enddo

       do n = iry1, iry1+nspecies-1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
!EXPAND                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
!EXPAND                     first_deriv_4(cons(i,j,k-2:k+2,n)*q(i,j,k-2:k+2,qw))
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
                   ( D4(1)*(cons(i,j,k+1,n)*q(i,j,k+1,qw)-cons(i,j,k-1,n)*q(i,j,k-1,qw)) &
                   + D4(2)*(cons(i,j,k+2,n)*q(i,j,k+2,qw)-cons(i,j,k-2,n)*q(i,j,k-2,qw)) )
             end do
          enddo
       enddo

       k = hi(3)-1
       ! use 3rd-order slightly left-biased stencil
       
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             un(-2:1) = q(i,j,k-2:k+1,qw)

             rhs(i,j,k,irho)=rhs(i,j,k,irho) - dxinv(3) * &
                  first_deriv_l3( cons(i,j,k-2:k+1,imz) )

             rhs(i,j,k,imx)=rhs(i,j,k,imx) - dxinv(3) * &
                  first_deriv_l3( cons(i,j,k-2:k+1,imx)*un(-2:1) )

             rhs(i,j,k,imy)=rhs(i,j,k,imy) - dxinv(3) * &
                  first_deriv_l3( cons(i,j,k-2:k+1,imy)*un(-2:1) )

             rhs(i,j,k,imz)=rhs(i,j,k,imz) - dxinv(3) * &
                  first_deriv_l3( cons(i,j,k-2:k+1,imz)*un(-2:1)+q(i,j,k-2:k+1,qpres) )

             rhs(i,j,k,iene)=rhs(i,j,k,iene) - dxinv(3) * &
                  first_deriv_l3( (cons(i,j,k-2:k+1,iene)+q(i,j,k-2:k+1,qpres))*un(-2:1) )

          enddo
       enddo

       do n = iry1, iry1+nspecies-1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
                rhs(i,j,k,n) = rhs(i,j,k,n) - dxinv(3) * &
                     first_deriv_l3(cons(i,j,k-2:k+1,n)*q(i,j,k-2:k+1,qw))
             end do
          enddo
       enddo

       ! if (bchi(3) .eq. WALL???) then
       !    k = hi(3)
       !    ! use completely left-biased stencil
       ! end if

    end if

    deallocate(tmpx,tmpy,tmpz)

    rhs_g(lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),:) = &
         rhs_g(lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),:) &
         + rhs(lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),:)
    deallocate(rhs)

  end subroutine hypterm_3d


  subroutine narrow_diffterm_3d (lo,hi,dx,q,qlo,qhi,rhs_g,glo,ghi,rhs,rlo,rhi, &
       mu,xi,lam,dxy,dlo_g,dhi_g,bclo,bchi)

    integer,         intent(in):: dlo_g(3),dhi_g(3),bclo(3),bchi(3)
    integer,         intent(in):: lo(3),hi(3),qlo(3),qhi(3),rlo(3),rhi(3),glo(3),ghi(3)
    double precision,intent(in):: dx(3)
    double precision,intent(in)   ::  q  (qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3),nprim)
    double precision,intent(in)   ::  mu (qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(in)   ::  xi (qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(in)   ::  lam(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(in)   ::  dxy(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3),nspecies)
    double precision,intent(inout)::rhs_g(glo(1):ghi(1),glo(2):ghi(2),glo(3):ghi(3),ncons)
    double precision,intent(inout)::rhs  (rlo(1):rhi(1),rlo(2):rhi(2),rlo(3):rhi(3),ncons)

    integer :: i
    integer :: slo(3), shi(3), dlo(3), dhi(3)
    double precision :: dxinv(3), dx2inv(3)

    ! used to turn off some terms
    double precision :: finlo(3), finhi(3)
    double precision :: foulo(3), fouhi(3)

    logical :: physbclo(3), physbchi(3)

    ! Only the region bounded by [dlo_g,dhi_g] contains good data.
    ! [slo,shi] will be safe for 8th-order stencil
    do i=1,3
       dlo(i) = max(lo(i)-stencil_ng, dlo_g(i))
       dhi(i) = min(hi(i)+stencil_ng, dhi_g(i))
       slo(i) = dlo(i) + stencil_ng
       shi(i) = dhi(i) - stencil_ng

       if (dlo(i) .eq. lo(i)) then
          physbclo(i) = .true.
       else
          physbclo(i) = .false.
       end if

       if (dhi(i) .eq. hi(i)) then
          physbchi(i) = .true.
       else
          physbchi(i) = .false.
       end if
    end do

    finlo = 1.d0 
    finhi = 1.d0
    foulo = 1.d0 
    fouhi = 1.d0

    do i=1,3
       if (physbclo(i)) then 
          if (bclo(i) .eq. INLET) then
             finlo(i) = 0.d0
          else if (bclo(i) .eq. OUTLET) then
             foulo(i) = 0.d0
          end if
       end if

       if (physbchi(i)) then 
          if (bchi(i) .eq. INLET) then
             finhi(i) = 0.d0
          else if (bchi(i) .eq. OUTLET) then
             fouhi(i) = 0.d0
          end if
       end if
    end do

    do i = 1,3
       dxinv(i) = 1.0d0 / dx(i)
       dx2inv(i) = dxinv(i)**2
    end do

    rhs(lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),:) = 0.d0

    call diffterm_1(q,qlo,qhi,rhs,rlo,rhi,mu,xi, &
         lo,hi,slo,shi,dlo,dhi,finlo,finhi,foulo,fouhi,physbclo,physbchi,dxinv)

    call diffterm_2(q,qlo,qhi,rhs,rlo,rhi, mu,xi,lam,dxy, &
         lo,hi,slo,shi,dlo,dhi,finlo,finhi,foulo,fouhi,physbclo,physbchi,dx2inv)

    rhs_g     (lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),:) = &
         rhs_g(lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),:) &
         + rhs(lo(1):hi(1),lo(2):hi(2),lo(3):hi(3),:)

  end subroutine narrow_diffterm_3d

  
  subroutine diffterm_1(q,qlo,qhi,rhs,rlo,rhi,mu,xi, &
       lo,hi,slo,shi,dlo,dhi,finlo,finhi,foulo,fouhi,physbclo,physbchi,dxinv)
    integer,         intent(in):: lo(3),hi(3),slo(3),shi(3),dlo(3),dhi(3)
    integer,         intent(in):: qlo(3),qhi(3),rlo(3),rhi(3)
    logical,         intent(in):: physbclo(3),physbchi(3)
    double precision,intent(in):: finlo(3),finhi(3),foulo(3),fouhi(3)
    double precision,intent(in):: dxinv(3)
    double precision,intent(in)   ::  q(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3),nprim)
    double precision,intent(in)   :: mu(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(in)   :: xi(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(inout)::rhs(rlo(1):rhi(1),rlo(2):rhi(2),rlo(3):rhi(3),ncons)

    double precision, allocatable, dimension(:,:,:) :: ux,uy,uz,vx,vy,vz,wx,wy,wz
    double precision, allocatable :: tmpx(:), tmpy(:,:),tmpz(:,:,:)
    double precision, allocatable, dimension(:,:,:) :: vsm
    double precision, dimension(lo(1):hi(1)) :: tauxx,tauyy,tauzz,divu
    integer          :: i,j,k

    allocate(ux( lo(1): hi(1),dlo(2):dhi(2),dlo(3):dhi(3)))
    allocate(vx( lo(1): hi(1),dlo(2):dhi(2),dlo(3):dhi(3)))
    allocate(wx( lo(1): hi(1),dlo(2):dhi(2),dlo(3):dhi(3)))

    allocate(uy(dlo(1):dhi(1), lo(2): hi(2),dlo(3):dhi(3)))
    allocate(vy(dlo(1):dhi(1), lo(2): hi(2),dlo(3):dhi(3)))
    allocate(wy(dlo(1):dhi(1), lo(2): hi(2),dlo(3):dhi(3)))

    allocate(uz(dlo(1):dhi(1),dlo(2):dhi(2), lo(3): hi(3)))
    allocate(vz(dlo(1):dhi(1),dlo(2):dhi(2), lo(3): hi(3)))
    allocate(wz(dlo(1):dhi(1),dlo(2):dhi(2), lo(3): hi(3)))

    allocate(vsm(dlo(1):dhi(1),dlo(2):dhi(2),dlo(3):dhi(3)))

    allocate(tmpx(dlo(1):dhi(1)))
    allocate(tmpy( lo(1): hi(1),dlo(2):dhi(2)))
    allocate(tmpz( lo(1): hi(1), lo(2): hi(2),dlo(3):dhi(3)))

    do k=dlo(3),dhi(3)
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
             vsm(i,j,k) = xi(i,j,k) -  TwoThirds*mu(i,j,k)
          enddo
       enddo
    enddo

    do k=dlo(3),dhi(3)
       do j=dlo(2),dhi(2)
          do i=slo(1),shi(1)
!EXPAND             ux(i,j,k) = dxinv(1)*first_deriv_8(q(i-4:i+4,j,k,qu))
             ux(i,j,k) = dxinv(1) * &
                ( D8(1)*(q(i+1,j,k,qu)-q(i-1,j,k,qu)) &
                + D8(2)*(q(i+2,j,k,qu)-q(i-2,j,k,qu)) &
                + D8(3)*(q(i+3,j,k,qu)-q(i-3,j,k,qu)) &
                + D8(4)*(q(i+4,j,k,qu)-q(i-4,j,k,qu)) )
!EXPAND             vx(i,j,k) = dxinv(1)*first_deriv_8(q(i-4:i+4,j,k,qv))
             vx(i,j,k) = dxinv(1) * &
                ( D8(1)*(q(i+1,j,k,qv)-q(i-1,j,k,qv)) &
                + D8(2)*(q(i+2,j,k,qv)-q(i-2,j,k,qv)) &
                + D8(3)*(q(i+3,j,k,qv)-q(i-3,j,k,qv)) &
                + D8(4)*(q(i+4,j,k,qv)-q(i-4,j,k,qv)) )
!EXPAND             wx(i,j,k) = dxinv(1)*first_deriv_8(q(i-4:i+4,j,k,qw))
             wx(i,j,k) = dxinv(1) * &
                ( D8(1)*(q(i+1,j,k,qw)-q(i-1,j,k,qw)) &
                + D8(2)*(q(i+2,j,k,qw)-q(i-2,j,k,qw)) &
                + D8(3)*(q(i+3,j,k,qw)-q(i-3,j,k,qw)) &
                + D8(4)*(q(i+4,j,k,qw)-q(i-4,j,k,qw)) )
          enddo
       enddo
    enddo

    do k=dlo(3),dhi(3)
       do j=slo(2),shi(2)   
          do i=dlo(1),dhi(1)
!EXPAND             uy(i,j,k) = dxinv(2)*first_deriv_8(q(i,j-4:j+4,k,qu))
             uy(i,j,k) = dxinv(2) * &
                ( D8(1)*(q(i,j+1,k,qu)-q(i,j-1,k,qu)) &
                + D8(2)*(q(i,j+2,k,qu)-q(i,j-2,k,qu)) &
                + D8(3)*(q(i,j+3,k,qu)-q(i,j-3,k,qu)) &
                + D8(4)*(q(i,j+4,k,qu)-q(i,j-4,k,qu)) )
!EXPAND             vy(i,j,k) = dxinv(2)*first_deriv_8(q(i,j-4:j+4,k,qv))
             vy(i,j,k) = dxinv(2) * &
                ( D8(1)*(q(i,j+1,k,qv)-q(i,j-1,k,qv)) &
                + D8(2)*(q(i,j+2,k,qv)-q(i,j-2,k,qv)) &
                + D8(3)*(q(i,j+3,k,qv)-q(i,j-3,k,qv)) &
                + D8(4)*(q(i,j+4,k,qv)-q(i,j-4,k,qv)) )
!EXPAND             wy(i,j,k) = dxinv(2)*first_deriv_8(q(i,j-4:j+4,k,qw))
             wy(i,j,k) = dxinv(2) * &
                ( D8(1)*(q(i,j+1,k,qw)-q(i,j-1,k,qw)) &
                + D8(2)*(q(i,j+2,k,qw)-q(i,j-2,k,qw)) &
                + D8(3)*(q(i,j+3,k,qw)-q(i,j-3,k,qw)) &
                + D8(4)*(q(i,j+4,k,qw)-q(i,j-4,k,qw)) )
          enddo
       enddo
    enddo

    do k=slo(3),shi(3)
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
!EXPAND             uz(i,j,k) = dxinv(3)*first_deriv_8(q(i,j,k-4:k+4,qu))
             uz(i,j,k) = dxinv(3) * &
                ( D8(1)*(q(i,j,k+1,qu)-q(i,j,k-1,qu)) &
                + D8(2)*(q(i,j,k+2,qu)-q(i,j,k-2,qu)) &
                + D8(3)*(q(i,j,k+3,qu)-q(i,j,k-3,qu)) &
                + D8(4)*(q(i,j,k+4,qu)-q(i,j,k-4,qu)) )
!EXPAND             vz(i,j,k) = dxinv(3)*first_deriv_8(q(i,j,k-4:k+4,qv))
             vz(i,j,k) = dxinv(3) * &
                ( D8(1)*(q(i,j,k+1,qv)-q(i,j,k-1,qv)) &
                + D8(2)*(q(i,j,k+2,qv)-q(i,j,k-2,qv)) &
                + D8(3)*(q(i,j,k+3,qv)-q(i,j,k-3,qv)) &
                + D8(4)*(q(i,j,k+4,qv)-q(i,j,k-4,qv)) )
!EXPAND             wz(i,j,k) = dxinv(3)*first_deriv_8(q(i,j,k-4:k+4,qw))
             wz(i,j,k) = dxinv(3) * &
                ( D8(1)*(q(i,j,k+1,qw)-q(i,j,k-1,qw)) &
                + D8(2)*(q(i,j,k+2,qw)-q(i,j,k-2,qw)) &
                + D8(3)*(q(i,j,k+3,qw)-q(i,j,k-3,qw)) &
                + D8(4)*(q(i,j,k+4,qw)-q(i,j,k-4,qw)) )
          enddo
       enddo
    enddo

    !
    ! lo-x boundary
    !
    if (physbclo(1)) then
       do k=dlo(3),dhi(3)
          do j=dlo(2),dhi(2)
             i = lo(1)
             ! use completely right-biased stencil
             ux(i,j,k) = dxinv(1)*first_deriv_rb(q(i:i+3,j,k,qu))
             vx(i,j,k) = dxinv(1)*first_deriv_rb(q(i:i+3,j,k,qv))
             wx(i,j,k) = dxinv(1)*first_deriv_rb(q(i:i+3,j,k,qw))

             i = lo(1)+1
             ! use 3rd-order slightly right-biased stencil
             ux(i,j,k) = dxinv(1)*first_deriv_r3(q(i-1:i+2,j,k,qu))
             vx(i,j,k) = dxinv(1)*first_deriv_r3(q(i-1:i+2,j,k,qv))
             wx(i,j,k) = dxinv(1)*first_deriv_r3(q(i-1:i+2,j,k,qw))

             i = lo(1)+2
             ! use 4th-order stencil
!EXPAND             ux(i,j,k) = dxinv(1)*first_deriv_4(q(i-2:i+2,j,k,qu))
             ux(i,j,k) = dxinv(1) * &
                ( D4(1)*(q(i+1,j,k,qu)-q(i-1,j,k,qu)) &
                + D4(2)*(q(i+2,j,k,qu)-q(i-2,j,k,qu)) )
!EXPAND             vx(i,j,k) = dxinv(1)*first_deriv_4(q(i-2:i+2,j,k,qv))
             vx(i,j,k) = dxinv(1) * &
                ( D4(1)*(q(i+1,j,k,qv)-q(i-1,j,k,qv)) &
                + D4(2)*(q(i+2,j,k,qv)-q(i-2,j,k,qv)) )
!EXPAND             wx(i,j,k) = dxinv(1)*first_deriv_4(q(i-2:i+2,j,k,qw))
             wx(i,j,k) = dxinv(1) * &
                ( D4(1)*(q(i+1,j,k,qw)-q(i-1,j,k,qw)) &
                + D4(2)*(q(i+2,j,k,qw)-q(i-2,j,k,qw)) )

             i = lo(1)+3
             ! use 6th-order stencil
!EXPAND             ux(i,j,k) = dxinv(1)*first_deriv_6(q(i-3:i+3,j,k,qu))
             ux(i,j,k) = dxinv(1) * &
                ( D6(1)*(q(i+1,j,k,qu)-q(i-1,j,k,qu)) &
                + D6(2)*(q(i+2,j,k,qu)-q(i-2,j,k,qu)) &
                + D6(3)*(q(i+3,j,k,qu)-q(i-3,j,k,qu)) )
!EXPAND             vx(i,j,k) = dxinv(1)*first_deriv_6(q(i-3:i+3,j,k,qv))
             vx(i,j,k) = dxinv(1) * &
                ( D6(1)*(q(i+1,j,k,qv)-q(i-1,j,k,qv)) &
                + D6(2)*(q(i+2,j,k,qv)-q(i-2,j,k,qv)) &
                + D6(3)*(q(i+3,j,k,qv)-q(i-3,j,k,qv)) )
!EXPAND             wx(i,j,k) = dxinv(1)*first_deriv_6(q(i-3:i+3,j,k,qw))
             wx(i,j,k) = dxinv(1) * &
                ( D6(1)*(q(i+1,j,k,qw)-q(i-1,j,k,qw)) &
                + D6(2)*(q(i+2,j,k,qw)-q(i-2,j,k,qw)) &
                + D6(3)*(q(i+3,j,k,qw)-q(i-3,j,k,qw)) )
          end do
       end do
    end if

    !
    ! hi-x boundary
    !
    if (physbchi(1)) then
       do k=dlo(3),dhi(3)
          do j=dlo(2),dhi(2)
             i = hi(1)-3
             ! use 6th-order stencil
!EXPAND             ux(i,j,k) = dxinv(1)*first_deriv_6(q(i-3:i+3,j,k,qu))
             ux(i,j,k) = dxinv(1) * &
                ( D6(1)*(q(i+1,j,k,qu)-q(i-1,j,k,qu)) &
                + D6(2)*(q(i+2,j,k,qu)-q(i-2,j,k,qu)) &
                + D6(3)*(q(i+3,j,k,qu)-q(i-3,j,k,qu)) )
!EXPAND             vx(i,j,k) = dxinv(1)*first_deriv_6(q(i-3:i+3,j,k,qv))
             vx(i,j,k) = dxinv(1) * &
                ( D6(1)*(q(i+1,j,k,qv)-q(i-1,j,k,qv)) &
                + D6(2)*(q(i+2,j,k,qv)-q(i-2,j,k,qv)) &
                + D6(3)*(q(i+3,j,k,qv)-q(i-3,j,k,qv)) )
!EXPAND             wx(i,j,k) = dxinv(1)*first_deriv_6(q(i-3:i+3,j,k,qw))
             wx(i,j,k) = dxinv(1) * &
                ( D6(1)*(q(i+1,j,k,qw)-q(i-1,j,k,qw)) &
                + D6(2)*(q(i+2,j,k,qw)-q(i-2,j,k,qw)) &
                + D6(3)*(q(i+3,j,k,qw)-q(i-3,j,k,qw)) )

             i = hi(1)-2
             ! use 4th-order stencil
!EXPAND             ux(i,j,k) = dxinv(1)*first_deriv_4(q(i-2:i+2,j,k,qu))
             ux(i,j,k) = dxinv(1) * &
                ( D4(1)*(q(i+1,j,k,qu)-q(i-1,j,k,qu)) &
                + D4(2)*(q(i+2,j,k,qu)-q(i-2,j,k,qu)) )
!EXPAND             vx(i,j,k) = dxinv(1)*first_deriv_4(q(i-2:i+2,j,k,qv))
             vx(i,j,k) = dxinv(1) * &
                ( D4(1)*(q(i+1,j,k,qv)-q(i-1,j,k,qv)) &
                + D4(2)*(q(i+2,j,k,qv)-q(i-2,j,k,qv)) )
!EXPAND             wx(i,j,k) = dxinv(1)*first_deriv_4(q(i-2:i+2,j,k,qw))
             wx(i,j,k) = dxinv(1) * &
                ( D4(1)*(q(i+1,j,k,qw)-q(i-1,j,k,qw)) &
                + D4(2)*(q(i+2,j,k,qw)-q(i-2,j,k,qw)) )

             i = hi(1)-1
             ! use 3rd-order slightly left-biased stencil
             ux(i,j,k) = dxinv(1)*first_deriv_l3(q(i-2:i+1,j,k,qu))
             vx(i,j,k) = dxinv(1)*first_deriv_l3(q(i-2:i+1,j,k,qv))
             wx(i,j,k) = dxinv(1)*first_deriv_l3(q(i-2:i+1,j,k,qw))

             i = hi(1)
             ! use completely left-biased stencil
             ux(i,j,k) = dxinv(1)*first_deriv_lb(q(i-3:i,j,k,qu))
             vx(i,j,k) = dxinv(1)*first_deriv_lb(q(i-3:i,j,k,qv))
             wx(i,j,k) = dxinv(1)*first_deriv_lb(q(i-3:i,j,k,qw))
          end do
       end do
    end if

    !
    ! lo-y boundary
    !
    if (physbclo(2)) then
       do k=dlo(3),dhi(3)
          j = lo(2)
          ! use completely right-biased stencil
          do i=dlo(1),dhi(1)
             uy(i,j,k) = dxinv(2)*first_deriv_rb(q(i,j:j+3,k,qu))
             vy(i,j,k) = dxinv(2)*first_deriv_rb(q(i,j:j+3,k,qv))
             wy(i,j,k) = dxinv(2)*first_deriv_rb(q(i,j:j+3,k,qw))
          enddo

          j = lo(2)+1
          ! use 3rd-order slightly right-biased stencil
          do i=dlo(1),dhi(1)
             uy(i,j,k) = dxinv(2)*first_deriv_r3(q(i,j-1:j+2,k,qu))
             vy(i,j,k) = dxinv(2)*first_deriv_r3(q(i,j-1:j+2,k,qv))
             wy(i,j,k) = dxinv(2)*first_deriv_r3(q(i,j-1:j+2,k,qw))
          enddo

          j = lo(2)+2
          ! use 4th-order stencil
          do i=dlo(1),dhi(1)
!EXPAND             uy(i,j,k) = dxinv(2)*first_deriv_4(q(i,j-2:j+2,k,qu))
             uy(i,j,k) = dxinv(2) * &
                ( D4(1)*(q(i,j+1,k,qu)-q(i,j-1,k,qu)) &
                + D4(2)*(q(i,j+2,k,qu)-q(i,j-2,k,qu)) )
!EXPAND             vy(i,j,k) = dxinv(2)*first_deriv_4(q(i,j-2:j+2,k,qv))
             vy(i,j,k) = dxinv(2) * &
                ( D4(1)*(q(i,j+1,k,qv)-q(i,j-1,k,qv)) &
                + D4(2)*(q(i,j+2,k,qv)-q(i,j-2,k,qv)) )
!EXPAND             wy(i,j,k) = dxinv(2)*first_deriv_4(q(i,j-2:j+2,k,qw))
             wy(i,j,k) = dxinv(2) * &
                ( D4(1)*(q(i,j+1,k,qw)-q(i,j-1,k,qw)) &
                + D4(2)*(q(i,j+2,k,qw)-q(i,j-2,k,qw)) )
          enddo

          j = lo(2)+3
          ! use 6th-order stencil
          do i=dlo(1),dhi(1)
!EXPAND             uy(i,j,k) = dxinv(2)*first_deriv_6(q(i,j-3:j+3,k,qu))
             uy(i,j,k) = dxinv(2) * &
                ( D6(1)*(q(i,j+1,k,qu)-q(i,j-1,k,qu)) &
                + D6(2)*(q(i,j+2,k,qu)-q(i,j-2,k,qu)) &
                + D6(3)*(q(i,j+3,k,qu)-q(i,j-3,k,qu)) )
!EXPAND             vy(i,j,k) = dxinv(2)*first_deriv_6(q(i,j-3:j+3,k,qv))
             vy(i,j,k) = dxinv(2) * &
                ( D6(1)*(q(i,j+1,k,qv)-q(i,j-1,k,qv)) &
                + D6(2)*(q(i,j+2,k,qv)-q(i,j-2,k,qv)) &
                + D6(3)*(q(i,j+3,k,qv)-q(i,j-3,k,qv)) )
!EXPAND             wy(i,j,k) = dxinv(2)*first_deriv_6(q(i,j-3:j+3,k,qw))
             wy(i,j,k) = dxinv(2) * &
                ( D6(1)*(q(i,j+1,k,qw)-q(i,j-1,k,qw)) &
                + D6(2)*(q(i,j+2,k,qw)-q(i,j-2,k,qw)) &
                + D6(3)*(q(i,j+3,k,qw)-q(i,j-3,k,qw)) )
          enddo
       end do
    end if

    !
    ! hi-y boundary
    !
    if (physbchi(2)) then
       do k=dlo(3),dhi(3)
          j = hi(2)-3
          ! use 6th-order stencil
          do i=dlo(1),dhi(1)
!EXPAND             uy(i,j,k) = dxinv(2)*first_deriv_6(q(i,j-3:j+3,k,qu))
             uy(i,j,k) = dxinv(2) * &
                ( D6(1)*(q(i,j+1,k,qu)-q(i,j-1,k,qu)) &
                + D6(2)*(q(i,j+2,k,qu)-q(i,j-2,k,qu)) &
                + D6(3)*(q(i,j+3,k,qu)-q(i,j-3,k,qu)) )
!EXPAND             vy(i,j,k) = dxinv(2)*first_deriv_6(q(i,j-3:j+3,k,qv))
             vy(i,j,k) = dxinv(2) * &
                ( D6(1)*(q(i,j+1,k,qv)-q(i,j-1,k,qv)) &
                + D6(2)*(q(i,j+2,k,qv)-q(i,j-2,k,qv)) &
                + D6(3)*(q(i,j+3,k,qv)-q(i,j-3,k,qv)) )
!EXPAND             wy(i,j,k) = dxinv(2)*first_deriv_6(q(i,j-3:j+3,k,qw))
             wy(i,j,k) = dxinv(2) * &
                ( D6(1)*(q(i,j+1,k,qw)-q(i,j-1,k,qw)) &
                + D6(2)*(q(i,j+2,k,qw)-q(i,j-2,k,qw)) &
                + D6(3)*(q(i,j+3,k,qw)-q(i,j-3,k,qw)) )
          enddo

          j = hi(2)-2
          ! use 4th-order stencil
          do i=dlo(1),dhi(1)
!EXPAND             uy(i,j,k) = dxinv(2)*first_deriv_4(q(i,j-2:j+2,k,qu))
             uy(i,j,k) = dxinv(2) * &
                ( D4(1)*(q(i,j+1,k,qu)-q(i,j-1,k,qu)) &
                + D4(2)*(q(i,j+2,k,qu)-q(i,j-2,k,qu)) )
!EXPAND             vy(i,j,k) = dxinv(2)*first_deriv_4(q(i,j-2:j+2,k,qv))
             vy(i,j,k) = dxinv(2) * &
                ( D4(1)*(q(i,j+1,k,qv)-q(i,j-1,k,qv)) &
                + D4(2)*(q(i,j+2,k,qv)-q(i,j-2,k,qv)) )
!EXPAND             wy(i,j,k) = dxinv(2)*first_deriv_4(q(i,j-2:j+2,k,qw))
             wy(i,j,k) = dxinv(2) * &
                ( D4(1)*(q(i,j+1,k,qw)-q(i,j-1,k,qw)) &
                + D4(2)*(q(i,j+2,k,qw)-q(i,j-2,k,qw)) )
          enddo

          j = hi(2)-1
          ! use 3rd-order slightly left-biased stencil
          do i=dlo(1),dhi(1)
             uy(i,j,k) = dxinv(2)*first_deriv_l3(q(i,j-2:j+1,k,qu))
             vy(i,j,k) = dxinv(2)*first_deriv_l3(q(i,j-2:j+1,k,qv))
             wy(i,j,k) = dxinv(2)*first_deriv_l3(q(i,j-2:j+1,k,qw))
          enddo

          j = hi(2)
          ! use completely left-biased stencil
          do i=dlo(1),dhi(1)
             uy(i,j,k) = dxinv(2)*first_deriv_lb(q(i,j-3:j,k,qu))
             vy(i,j,k) = dxinv(2)*first_deriv_lb(q(i,j-3:j,k,qv))
             wy(i,j,k) = dxinv(2)*first_deriv_lb(q(i,j-3:j,k,qw))
          enddo
       end do
    end if

    !
    ! lo-z boundary
    !
    if (physbclo(3)) then
       k = lo(3)
       ! use completely right-biased stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
             uz(i,j,k) = dxinv(3)*first_deriv_rb(q(i,j,k:k+3,qu))
             vz(i,j,k) = dxinv(3)*first_deriv_rb(q(i,j,k:k+3,qv))
             wz(i,j,k) = dxinv(3)*first_deriv_rb(q(i,j,k:k+3,qw))
          enddo
       enddo

       k = lo(3)+1
       ! use 3rd-order slightly right-biased stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
             uz(i,j,k) = dxinv(3)*first_deriv_r3(q(i,j,k-1:k+2,qu))
             vz(i,j,k) = dxinv(3)*first_deriv_r3(q(i,j,k-1:k+2,qv))
             wz(i,j,k) = dxinv(3)*first_deriv_r3(q(i,j,k-1:k+2,qw))
          enddo
       enddo

       k = lo(3)+2
       ! use 4th-order stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
!EXPAND             uz(i,j,k) = dxinv(3)*first_deriv_4(q(i,j,k-2:k+2,qu))
             uz(i,j,k) = dxinv(3) * &
                ( D4(1)*(q(i,j,k+1,qu)-q(i,j,k-1,qu)) &
                + D4(2)*(q(i,j,k+2,qu)-q(i,j,k-2,qu)) )
!EXPAND             vz(i,j,k) = dxinv(3)*first_deriv_4(q(i,j,k-2:k+2,qv))
             vz(i,j,k) = dxinv(3) * &
                ( D4(1)*(q(i,j,k+1,qv)-q(i,j,k-1,qv)) &
                + D4(2)*(q(i,j,k+2,qv)-q(i,j,k-2,qv)) )
!EXPAND             wz(i,j,k) = dxinv(3)*first_deriv_4(q(i,j,k-2:k+2,qw))
             wz(i,j,k) = dxinv(3) * &
                ( D4(1)*(q(i,j,k+1,qw)-q(i,j,k-1,qw)) &
                + D4(2)*(q(i,j,k+2,qw)-q(i,j,k-2,qw)) )
          enddo
       enddo

       k = lo(3)+3
       ! use 6th-order stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
!EXPAND             uz(i,j,k) = dxinv(3)*first_deriv_6(q(i,j,k-3:k+3,qu))
             uz(i,j,k) = dxinv(3) * &
                ( D6(1)*(q(i,j,k+1,qu)-q(i,j,k-1,qu)) &
                + D6(2)*(q(i,j,k+2,qu)-q(i,j,k-2,qu)) &
                + D6(3)*(q(i,j,k+3,qu)-q(i,j,k-3,qu)) )
!EXPAND             vz(i,j,k) = dxinv(3)*first_deriv_6(q(i,j,k-3:k+3,qv))
             vz(i,j,k) = dxinv(3) * &
                ( D6(1)*(q(i,j,k+1,qv)-q(i,j,k-1,qv)) &
                + D6(2)*(q(i,j,k+2,qv)-q(i,j,k-2,qv)) &
                + D6(3)*(q(i,j,k+3,qv)-q(i,j,k-3,qv)) )
!EXPAND             wz(i,j,k) = dxinv(3)*first_deriv_6(q(i,j,k-3:k+3,qw))
             wz(i,j,k) = dxinv(3) * &
                ( D6(1)*(q(i,j,k+1,qw)-q(i,j,k-1,qw)) &
                + D6(2)*(q(i,j,k+2,qw)-q(i,j,k-2,qw)) &
                + D6(3)*(q(i,j,k+3,qw)-q(i,j,k-3,qw)) )
          enddo
       enddo
    end if

    !
    ! hi-z boundary
    !
    if (physbchi(3)) then
       k = hi(3)-3
       ! use 6th-order stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
!EXPAND             uz(i,j,k) = dxinv(3)*first_deriv_6(q(i,j,k-3:k+3,qu))
             uz(i,j,k) = dxinv(3) * &
                ( D6(1)*(q(i,j,k+1,qu)-q(i,j,k-1,qu)) &
                + D6(2)*(q(i,j,k+2,qu)-q(i,j,k-2,qu)) &
                + D6(3)*(q(i,j,k+3,qu)-q(i,j,k-3,qu)) )
!EXPAND             vz(i,j,k) = dxinv(3)*first_deriv_6(q(i,j,k-3:k+3,qv))
             vz(i,j,k) = dxinv(3) * &
                ( D6(1)*(q(i,j,k+1,qv)-q(i,j,k-1,qv)) &
                + D6(2)*(q(i,j,k+2,qv)-q(i,j,k-2,qv)) &
                + D6(3)*(q(i,j,k+3,qv)-q(i,j,k-3,qv)) )
!EXPAND             wz(i,j,k) = dxinv(3)*first_deriv_6(q(i,j,k-3:k+3,qw))
             wz(i,j,k) = dxinv(3) * &
                ( D6(1)*(q(i,j,k+1,qw)-q(i,j,k-1,qw)) &
                + D6(2)*(q(i,j,k+2,qw)-q(i,j,k-2,qw)) &
                + D6(3)*(q(i,j,k+3,qw)-q(i,j,k-3,qw)) )
          enddo
       enddo

       k = hi(3)-2
       ! use 4th-order stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
!EXPAND             uz(i,j,k) = dxinv(3)*first_deriv_4(q(i,j,k-2:k+2,qu))
             uz(i,j,k) = dxinv(3) * &
                ( D4(1)*(q(i,j,k+1,qu)-q(i,j,k-1,qu)) &
                + D4(2)*(q(i,j,k+2,qu)-q(i,j,k-2,qu)) )
!EXPAND             vz(i,j,k) = dxinv(3)*first_deriv_4(q(i,j,k-2:k+2,qv))
             vz(i,j,k) = dxinv(3) * &
                ( D4(1)*(q(i,j,k+1,qv)-q(i,j,k-1,qv)) &
                + D4(2)*(q(i,j,k+2,qv)-q(i,j,k-2,qv)) )
!EXPAND             wz(i,j,k) = dxinv(3)*first_deriv_4(q(i,j,k-2:k+2,qw))
             wz(i,j,k) = dxinv(3) * &
                ( D4(1)*(q(i,j,k+1,qw)-q(i,j,k-1,qw)) &
                + D4(2)*(q(i,j,k+2,qw)-q(i,j,k-2,qw)) )
          enddo
       enddo

       k = hi(3)-1
       ! use 3rd-order slightly left-biased stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
             uz(i,j,k) = dxinv(3)*first_deriv_l3(q(i,j,k-2:k+1,qu))
             vz(i,j,k) = dxinv(3)*first_deriv_l3(q(i,j,k-2:k+1,qv))
             wz(i,j,k) = dxinv(3)*first_deriv_l3(q(i,j,k-2:k+1,qw))
          enddo
       enddo

       k = hi(3)
       ! use completely left-biased stencil
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
             uz(i,j,k) = dxinv(3)*first_deriv_lb(q(i,j,k-3:k,qu))
             vz(i,j,k) = dxinv(3)*first_deriv_lb(q(i,j,k-3:k,qv))
             wz(i,j,k) = dxinv(3)*first_deriv_lb(q(i,j,k-3:k,qw))
          enddo
       enddo
    end if


    !----- mx -----

    !----- mx : d()/dx -----
    do k=lo(3),hi(3)
       do j=lo(2),hi(2)

          do i=dlo(1),dhi(1)
             tmpx(i) = vsm(i,j,k)*(vy(i,j,k)+wz(i,j,k))
          end do

          !
          ! lo-x boundary
          !
          if (physbclo(1)) then
             i = lo(1)
             ! use completely right-biased stencil
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + finlo(1)*dxinv(1)*first_deriv_rb(tmpx(i:i+3))
             
             i = lo(1)+1
             ! use 3rd-order slightly right-biased stencil
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1)*first_deriv_r3(tmpx(i-1:i+2))

             i = lo(1)+2
             ! use 4th-order stencil
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1)*first_deriv_4(tmpx(i-2:i+2))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1) * &
                ( D4(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D4(2)*(tmpx(i+2)-tmpx(i-2)) )

             i = lo(1)+3
             ! use 6th-order stencil
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1)*first_deriv_6(tmpx(i-3:i+3))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1) * &
                ( D6(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D6(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D6(3)*(tmpx(i+3)-tmpx(i-3)) )
          end if

          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1)*first_deriv_8(tmpx(i-4:i+4)) 
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1) * &
                ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
          end do

          !
          ! hi-x boundary
          !
          if (physbchi(1)) then
             i = hi(1)-3
             ! use 6th-order stencil
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1)*first_deriv_6(tmpx(i-3:i+3))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1) * &
                ( D6(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D6(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D6(3)*(tmpx(i+3)-tmpx(i-3)) )

             i = hi(1)-2
             ! use 4th-order stencil
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1)*first_deriv_4(tmpx(i-2:i+2))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1) * &
                ( D4(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D4(2)*(tmpx(i+2)-tmpx(i-2)) )

             i = hi(1)-1
             ! use 3rd-order slightly left-biased stencil
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(1)*first_deriv_l3(tmpx(i-2:i+1))

             i = hi(1)
             ! use completely left-biased stencil
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + finhi(1)*dxinv(1)*first_deriv_lb(tmpx(i-3:i))
          end if
       end do
    end do

    !----- mx : d()/dy -----
    do k=lo(3),hi(3)

       do j=dlo(2),dhi(2)
          do i=lo(1),hi(1)
             tmpy(i,j) = mu(i,j,k)*vx(i,j,k)
          end do
       end do

       !
       ! lo-y boundary
       !
       if (physbclo(2)) then
          j = lo(2)
          ! use completely right-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + foulo(2)*dxinv(2)*first_deriv_rb(tmpy(i,j:j+3))
          end do

          j = lo(2)+1
          ! use 3rd-order slightly right-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2)*first_deriv_r3(tmpy(i,j-1:j+2))
          end do

          j = lo(2)+2
          ! use 4th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2)*first_deriv_4(tmpy(i,j-2:j+2))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2) * &
                ( D4(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D4(2)*(tmpy(i,j+2)-tmpy(i,j-2)) )
          end do

          j = lo(2)+3
          ! use 6th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2)*first_deriv_6(tmpy(i,j-3:j+3))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2) * &
                ( D6(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D6(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D6(3)*(tmpy(i,j+3)-tmpy(i,j-3)) )
          end do
       end if

       !
       ! interior
       !
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2)*first_deriv_8(tmpy(i,j-4:j+4)) 
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2) * &
                ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
          end do
       end do

       !
       ! hi-y boundary
       !
       if (physbchi(2)) then
          j = hi(2)-3
          ! use 6th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2)*first_deriv_6(tmpy(i,j-3:j+3))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2) * &
                ( D6(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D6(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D6(3)*(tmpy(i,j+3)-tmpy(i,j-3)) )
          end do

          j = hi(2)-2
          ! use 4th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2)*first_deriv_4(tmpy(i,j-2:j+2))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2) * &
                ( D4(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D4(2)*(tmpy(i,j+2)-tmpy(i,j-2)) )
          end do

          j = hi(2)-1
          ! use 3rd-order slightly left-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(2)*first_deriv_l3(tmpy(i,j-2:j+1))
          end do

          j = hi(2)
          ! use completely left-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + fouhi(2)*dxinv(2)*first_deriv_lb(tmpy(i,j-3:j))
          end do
       end if
    end do

    ! ----- mx : d()/dz -----

    do k=dlo(3),dhi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             tmpz(i,j,k) = mu(i,j,k)*wx(i,j,k)
          end do
       end do
    end do

    ! lo-z boundary
    if (physbclo(3)) then
       k = lo(3)
       ! use completely right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + foulo(3)*dxinv(3)*first_deriv_rb(tmpz(i,j,k:k+3))
          end do
       end do

       k = lo(3)+1
       ! use 3rd-order slightly right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3)*first_deriv_r3(tmpz(i,j,k-1:k+2))
          end do
       end do

       k = lo(3)+2
       ! use 4th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3)*first_deriv_4(tmpz(i,j,k-2:k+2))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3) * &
                ( D4(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D4(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) )
          end do
       end do

       k = lo(3)+3
       ! use 6th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3)*first_deriv_6(tmpz(i,j,k-3:k+3))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3) * &
                ( D6(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D6(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D6(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) )
          end do
       end do
    end if

    !
    ! interior
    !
    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3)*first_deriv_8(tmpz(i,j,k-4:k+4)) 
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3) * &
                ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
          end do
       end do
    end do

    !
    ! hi-z boundary
    !
    if (physbchi(3)) then
       k = hi(3)-3
       ! use 6th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3)*first_deriv_6(tmpz(i,j,k-3:k+3))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3) * &
                ( D6(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D6(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D6(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) )
          end do
       end do

       k = hi(3)-2
       ! use 4th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3)*first_deriv_4(tmpz(i,j,k-2:k+2))
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3) * &
                ( D4(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D4(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) )
          end do
       end do

       k = hi(3)-1
       ! use 3rd-order slightly left-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + dxinv(3)*first_deriv_l3(tmpz(i,j,k-2:k+1))
          end do
       end do

       k = hi(3)
       ! use completely left-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imx) = rhs(i,j,k,imx) + fouhi(3)*dxinv(3)*first_deriv_lb(tmpz(i,j,k-3:k))
          end do
       end do
    end if

    !----- my -----

    !----- my : d()/dx -----
    do k=lo(3),hi(3)
       do j=lo(2),hi(2)

          do i=dlo(1),dhi(1)
             tmpx(i) = mu(i,j,k)*uy(i,j,k)
          end do

          !
          ! lo-x boundary
          !
          if (physbclo(1)) then
             i = lo(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + foulo(1)*dxinv(1)*first_deriv_rb(tmpx(i:i+3))

             i = lo(1)+1
             ! use 3rd-order slightly right-biased stencil
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1)*first_deriv_r3(tmpx(i-1:i+2))

             i = lo(1)+2
             ! use 4th-order stencil
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1)*first_deriv_4(tmpx(i-2:i+2))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1) * &
                ( D4(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D4(2)*(tmpx(i+2)-tmpx(i-2)) )

             i = lo(1)+3
             ! use 6th-order stencil
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1)*first_deriv_6(tmpx(i-3:i+3))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1) * &
                ( D6(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D6(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D6(3)*(tmpx(i+3)-tmpx(i-3)) )
          end if

          !
          ! interior
          !
          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1)*first_deriv_8(tmpx(i-4:i+4)) 
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1) * &
                ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
          end do

          !
          ! hi-x boundary
          !
          if (physbchi(1)) then
             i = hi(1)-3
             ! use 6th-order stencil
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1)*first_deriv_6(tmpx(i-3:i+3))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1) * &
                ( D6(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D6(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D6(3)*(tmpx(i+3)-tmpx(i-3)) )

             i = hi(1)-2
             ! use 4th-order stencil
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1)*first_deriv_4(tmpx(i-2:i+2))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1) * &
                ( D4(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D4(2)*(tmpx(i+2)-tmpx(i-2)) )

             i = hi(1)-1
             ! use 3rd-order slightly left-biased stencil
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(1)*first_deriv_l3(tmpx(i-2:i+1))

             i = hi(1)
             ! use completely left-biased stencil
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + fouhi(1)*dxinv(1)*first_deriv_lb(tmpx(i-3:i))
          end if
       end do
    end do

    !----- my : d()/dy -----
    do k=lo(3),hi(3)

       do j=dlo(2),dhi(2)
          do i=lo(1),hi(1)
             tmpy(i,j) = vsm(i,j,k)*(ux(i,j,k)+wz(i,j,k))
          end do
       end do

       !
       ! lo-y boundary
       !
       if (physbclo(2)) then
          j = lo(2)
          ! use completely right-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + finlo(2)*dxinv(2)*first_deriv_rb(tmpy(i,j:j+3))
          end do

          j = lo(2)+1
          ! use 3rd-order slightly right-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2)*first_deriv_r3(tmpy(i,j-1:j+2))
          end do

          j = lo(2)+2
          ! use 4th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2)*first_deriv_4(tmpy(i,j-2:j+2))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2) * &
                ( D4(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D4(2)*(tmpy(i,j+2)-tmpy(i,j-2)) )
          end do

          j = lo(2)+3
          ! use 6th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2)*first_deriv_6(tmpy(i,j-3:j+3))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2) * &
                ( D6(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D6(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D6(3)*(tmpy(i,j+3)-tmpy(i,j-3)) )
          end do
       end if

       !
       ! interior
       !
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2)*first_deriv_8(tmpy(i,j-4:j+4)) 
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2) * &
                ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
          end do
       end do

       !
       ! hi-y boundary
       !
       if (physbchi(2)) then
          j = hi(2)-3
          ! use 6th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2)*first_deriv_6(tmpy(i,j-3:j+3))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2) * &
                ( D6(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D6(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D6(3)*(tmpy(i,j+3)-tmpy(i,j-3)) )
          end do

          j = hi(2)-2
          ! use 4th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2)*first_deriv_4(tmpy(i,j-2:j+2))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2) * &
                ( D4(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D4(2)*(tmpy(i,j+2)-tmpy(i,j-2)) )
          end do

          j = hi(2)-1
          ! use 3rd-order slightly left-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(2)*first_deriv_l3(tmpy(i,j-2:j+1))
          end do

          j = hi(2)
          ! use completely left-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + finhi(2)*dxinv(2)*first_deriv_lb(tmpy(i,j-3:j))
          end do
       end if
    end do

    !----- my : d()/dz -----

    do k=dlo(3),dhi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             tmpz(i,j,k) = mu(i,j,k)*wy(i,j,k)
          end do
       end do
    end do

    !
    ! lo-z boundary
    !
    if (physbclo(3)) then
       k = lo(3)
       ! use completely right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + foulo(3)*dxinv(3)*first_deriv_rb(tmpz(i,j,k:k+3))
          end do
       end do

       k = lo(3)+1
       ! use 3rd-order slightly right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3)*first_deriv_r3(tmpz(i,j,k-1:k+2))
          end do
       end do

       k = lo(3)+2
       ! use 4th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3)*first_deriv_4(tmpz(i,j,k-2:k+2))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3) * &
                ( D4(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D4(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) )
          end do
       end do

       k = lo(3)+3
       ! use 6th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3)*first_deriv_6(tmpz(i,j,k-3:k+3))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3) * &
                ( D6(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D6(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D6(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) )
          end do
       end do
    end if

    !
    ! interior
    !
    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3)*first_deriv_8(tmpz(i,j,k-4:k+4)) 
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3) * &
                ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
          end do
       end do
    end do

    !
    ! hi-z boundary
    !
    if (physbchi(3)) then
       k = hi(3)-3
       ! use 6th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3)*first_deriv_6(tmpz(i,j,k-3:k+3))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3) * &
                ( D6(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D6(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D6(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) )
          end do
       end do

       k = hi(3)-2
       ! use 4th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3)*first_deriv_4(tmpz(i,j,k-2:k+2))
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3) * &
                ( D4(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D4(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) )
          end do
       end do

       k = hi(3)-1
       ! use 3rd-order slightly left-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + dxinv(3)*first_deriv_l3(tmpz(i,j,k-2:k+1))
          end do
       end do

       k = hi(3)
       ! use completely left-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imy) = rhs(i,j,k,imy) + fouhi(3)*dxinv(3)*first_deriv_lb(tmpz(i,j,k-3:k))
          end do
       end do
    end if

    !----- mz -----

    !----- mz : d()/dx -------
    do k=lo(3),hi(3)
       do j=lo(2),hi(2)

          do i=dlo(1),dhi(1)
             tmpx(i) = mu(i,j,k)*uz(i,j,k)
          end do

          !
          ! lo-x boundary
          !
          if (physbclo(1)) then
             i = lo(1)
             ! use completely right-biased stencil
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + foulo(1)*dxinv(1)*first_deriv_rb(tmpx(i:i+3))

             i = lo(1)+1
             ! use 3rd-order slightly right-biased stencil
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1)*first_deriv_r3(tmpx(i-1:i+2))

             i = lo(1)+2
             ! use 4th-order stencil
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1)*first_deriv_4(tmpx(i-2:i+2))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1) * &
                ( D4(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D4(2)*(tmpx(i+2)-tmpx(i-2)) )

             i = lo(1)+3
             ! use 6th-order stencil
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1)*first_deriv_6(tmpx(i-3:i+3))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1) * &
                ( D6(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D6(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D6(3)*(tmpx(i+3)-tmpx(i-3)) )
          end if

          !
          ! interior
          !
          do i=slo(1),shi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1) * first_deriv_8(tmpx(i-4:i+4))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1) * &
                ( D8(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D8(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D8(3)*(tmpx(i+3)-tmpx(i-3)) &
                + D8(4)*(tmpx(i+4)-tmpx(i-4)) )
          end do

          !
          ! hi-x boundary
          !
          if (physbchi(1)) then
             i = hi(1)-3
             ! use 6th-order stencil
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1)*first_deriv_6(tmpx(i-3:i+3))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1) * &
                ( D6(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D6(2)*(tmpx(i+2)-tmpx(i-2)) &
                + D6(3)*(tmpx(i+3)-tmpx(i-3)) )

             i = hi(1)-2
             ! use 4th-order stencil
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1)*first_deriv_4(tmpx(i-2:i+2))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1) * &
                ( D4(1)*(tmpx(i+1)-tmpx(i-1)) &
                + D4(2)*(tmpx(i+2)-tmpx(i-2)) )

             i = hi(1)-1
             ! use 3rd-order slightly left-biased stencil
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(1)*first_deriv_l3(tmpx(i-2:i+1))

             i = hi(1)
             ! use completely left-biased stencil
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + fouhi(1)*dxinv(1)*first_deriv_lb(tmpx(i-3:i))
          end if
       end do
    end do

    !----- mz : d()/dy -----
    do k=lo(3),hi(3)

       do j=dlo(2),dhi(2)
          do i=lo(1),hi(1)
             tmpy(i,j) = mu(i,j,k)*vz(i,j,k)
          end do
       end do

       !
       ! lo-y boundary
       !
       if (physbclo(2)) then
          j = lo(2)
          ! use completely right-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + foulo(2)*dxinv(2)*first_deriv_rb(tmpy(i,j:j+3))
          end do

          j = lo(2)+1
          ! use 3rd-order slightly right-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2)*first_deriv_r3(tmpy(i,j-1:j+2))
          end do

          j = lo(2)+2
          ! use 4th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2)*first_deriv_4(tmpy(i,j-2:j+2))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2) * &
                ( D4(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D4(2)*(tmpy(i,j+2)-tmpy(i,j-2)) )
          end do

          j = lo(2)+3
          ! use 6th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2)*first_deriv_6(tmpy(i,j-3:j+3))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2) * &
                ( D6(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D6(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D6(3)*(tmpy(i,j+3)-tmpy(i,j-3)) )
          end do
       end if

       !
       ! interior
       !
       do j=slo(2),shi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2)*first_deriv_8(tmpy(i,j-4:j+4))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2) * &
                ( D8(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D8(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D8(3)*(tmpy(i,j+3)-tmpy(i,j-3)) &
                + D8(4)*(tmpy(i,j+4)-tmpy(i,j-4)) )
          end do
       end do

       !
       ! hi-y boundary
       !
       if (physbchi(2)) then
          j = hi(2)-3
          ! use 6th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2)*first_deriv_6(tmpy(i,j-3:j+3))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2) * &
                ( D6(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D6(2)*(tmpy(i,j+2)-tmpy(i,j-2)) &
                + D6(3)*(tmpy(i,j+3)-tmpy(i,j-3)) )
          end do

          j = hi(2)-2
          ! use 4th-order stencil
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2)*first_deriv_4(tmpy(i,j-2:j+2))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2) * &
                ( D4(1)*(tmpy(i,j+1)-tmpy(i,j-1)) &
                + D4(2)*(tmpy(i,j+2)-tmpy(i,j-2)) )
          end do

          j = hi(2)-1
          ! use 3rd-order slightly left-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(2)*first_deriv_l3(tmpy(i,j-2:j+1))
          end do

          j = hi(2)
          ! use completely left-biased stencil
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + fouhi(2)*dxinv(2)*first_deriv_lb(tmpy(i,j-3:j))
          end do
       end if
    end do

    !----- mz : d()/dy -----

    do k=dlo(3),dhi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             tmpz(i,j,k) = vsm(i,j,k)*(ux(i,j,k)+vy(i,j,k))
          end do
       end do
    end do

    !
    ! lo-z boundary
    !
    if (physbclo(3)) then
       k = lo(3)
       ! use completely right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + finlo(3)*dxinv(3)*first_deriv_rb(tmpz(i,j,k:k+3))
          end do
       end do

       k = lo(3)+1
       ! use 3rd-order slightly right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3)*first_deriv_r3(tmpz(i,j,k-1:k+2))
          end do
       end do

       k = lo(3)+2
       ! use 4th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3)*first_deriv_4(tmpz(i,j,k-2:k+2))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3) * &
                ( D4(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D4(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) )
          end do
       end do

       k = lo(3)+3
       ! use 6th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3)*first_deriv_6(tmpz(i,j,k-3:k+3))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3) * &
                ( D6(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D6(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D6(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) )
          end do
       end do
    end if
    
    !
    ! interior
    !
    do k=slo(3),shi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3)*first_deriv_8(tmpz(i,j,k-4:k+4))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3) * &
                ( D8(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D8(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D8(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) &
                + D8(4)*(tmpz(i,j,k+4)-tmpz(i,j,k-4)) )
          end do
       end do
    end do

    !
    ! hi-z boundary
    !
    if (physbchi(3)) then
       k = hi(3)-3
       ! use 6th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3)*first_deriv_6(tmpz(i,j,k-3:k+3))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3) * &
                ( D6(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D6(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) &
                + D6(3)*(tmpz(i,j,k+3)-tmpz(i,j,k-3)) )
          end do
       end do

       k = hi(3)-2
       ! use 4th-order stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3)*first_deriv_4(tmpz(i,j,k-2:k+2))
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3) * &
                ( D4(1)*(tmpz(i,j,k+1)-tmpz(i,j,k-1)) &
                + D4(2)*(tmpz(i,j,k+2)-tmpz(i,j,k-2)) )
          end do
       end do

       k = hi(3)-1
       ! use 3rd-order slightly left-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + dxinv(3)*first_deriv_l3(tmpz(i,j,k-2:k+1))
          end do
       end do

       k = hi(3)
       ! use completely left-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,imz) = rhs(i,j,k,imz) + finhi(3)*dxinv(3)*first_deriv_lb(tmpz(i,j,k-3:k))
          end do
       end do
    end if

    !----- energy -----

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             divu(i) = (ux(i,j,k)+vy(i,j,k)+wz(i,j,k))*vsm(i,j,k)
             tauxx(i) = 2.d0*mu(i,j,k)*ux(i,j,k) + divu(i)
             tauyy(i) = 2.d0*mu(i,j,k)*vy(i,j,k) + divu(i)
             tauzz(i) = 2.d0*mu(i,j,k)*wz(i,j,k) + divu(i)
             
             ! change in internal energy
             rhs(i,j,k,iene) = rhs(i,j,k,iene) + &
                  tauxx(i)*ux(i,j,k) + tauyy(i)*vy(i,j,k) + tauzz(i)*wz(i,j,k) &
                  + mu(i,j,k)*((uy(i,j,k)+vx(i,j,k))**2 &
                  &          + (wx(i,j,k)+uz(i,j,k))**2 &
                  &          + (vz(i,j,k)+wy(i,j,k))**2 )

          end do
       end do
    end do

    deallocate(tmpx,tmpy,tmpz)
    deallocate(vsm)
    deallocate(ux,uy,uz,vx,vy,vz,wx,wy,wz)

  end subroutine diffterm_1

  
  subroutine diffterm_2(q,qlo,qhi,rhs,rlo,rhi,mu,xi,lam,dxy, &
       lo,hi,slo,shi,dlo,dhi,finlo,finhi,foulo,fouhi,physbclo,physbchi,dx2inv)
    use probin_module, only : reset_N2
    integer,         intent(in):: lo(3),hi(3),slo(3),shi(3),dlo(3),dhi(3)
    integer,         intent(in):: qlo(3),qhi(3),rlo(3),rhi(3)
    logical,         intent(in):: physbclo(3),physbchi(3)
    double precision,intent(in):: finlo(3),finhi(3),foulo(3),fouhi(3)
    double precision,intent(in):: dx2inv(3)
    double precision,intent(in)   :: q (qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3),nprim)
    double precision,intent(in)   :: mu(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(in)   :: xi(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(in)   ::lam(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3))
    double precision,intent(in)   ::dxy(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3),nspecies)
    double precision,intent(inout)::rhs(rlo(1):rhi(1),rlo(2):rhi(2),rlo(3):rhi(3),ncons)

    double precision, allocatable, dimension(:,:,:) :: vsp, dpe
    double precision, allocatable, dimension(:,:,:,:) :: Hg, dpy, dxe
    ! dxy: diffusion coefficient of X in equation for Y
    ! dpy: diffusion coefficient of p in equation for Y
    ! dxe: diffusion coefficient of X in equation for energy
    ! dpe: diffusion coefficient of p in equation for energy

    integer          :: i,j,k,n, qxn, qyn, qhn

    double precision :: Yhalf, hhalf
    double precision :: mmtmp8(8,lo(1):hi(1)+1)
    double precision, allocatable, dimension(:,:,:,:) :: M8p
    double precision, allocatable, dimension(:,:,:) :: Hry

    double precision :: Htot, Htmp(nspecies), Ytmp(nspecies)
    double precision :: M6p(6), M6X(6), mmtmp6(6)
    double precision :: M4p(4), M4X(4), mmtmp4(4)
    double precision :: M2p(2), M2X(2), mmtmp2(2)
    double precision :: BBp(4), BBX(4), mmtmpB(4)
    double precision :: rhstmp(nspecies), rhstot, rhsene
    double precision :: Hcell(0:1,2:ncons)
    integer :: iface

    allocate(vsp(dlo(1):dhi(1),dlo(2):dhi(2),dlo(3):dhi(3)))

    allocate(dpy(dlo(1):dhi(1),dlo(2):dhi(2),dlo(3):dhi(3),nspecies))
    allocate(dxe(dlo(1):dhi(1),dlo(2):dhi(2),dlo(3):dhi(3),nspecies))
    allocate(dpe(dlo(1):dhi(1),dlo(2):dhi(2),dlo(3):dhi(3)))

    allocate(Hg(lo(1):hi(1)+1,lo(2):hi(2)+1,lo(3):hi(3)+1,2:ncons))

    allocate(M8p(8,lo(1):hi(1)+1,lo(2):hi(2)+1,lo(3):hi(3)+1))
    if (.not.reset_N2) then
       allocate(Hry(  lo(1):hi(1)+1,lo(2):hi(2)+1,lo(3):hi(3)+1))
    end if

    do k=dlo(3),dhi(3)
       do j=dlo(2),dhi(2)
          do i=dlo(1),dhi(1)
             vsp(i,j,k) = xi(i,j,k) + FourThirds*mu(i,j,k)
          enddo
       enddo
    enddo

    dpe = 0.d0

    do n=1,nspecies
       qxn = qx1+n-1
       qyn = qy1+n-1
       qhn = qh1+n-1
       do k=dlo(3),dhi(3)
          do j=dlo(2),dhi(2)
             do i=dlo(1),dhi(1)
                dpy(i,j,k,n) = dxy(i,j,k,n)/q(i,j,k,qpres)*(q(i,j,k,qxn)-q(i,j,k,qyn))
                dxe(i,j,k,n) = dxy(i,j,k,n)*q(i,j,k,qhn)
                dpe(i,j,k) = dpe(i,j,k) + dpy(i,j,k,n)*q(i,j,k,qhn)
             end do
          end do
       end do
    end do

    ! ------- BEGIN x-direction -------

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=slo(1),shi(1)+1
!EXPAND             mmtmp8(1:8,i) = matmul(vsp(i-4:i+3,j,k), M8)
             mmtmp8(1,i) = vsp(i-4,j,k) * M8(1,1) &
                         + vsp(i-3,j,k) * M8(2,1) &
                         + vsp(i-2,j,k) * M8(3,1) &
                         + vsp(i-1,j,k) * M8(4,1) &
                         + vsp(i  ,j,k) * M8(5,1)
             mmtmp8(2,i) = vsp(i-4,j,k) * M8(1,2) &
                         + vsp(i-3,j,k) * M8(2,2) &
                         + vsp(i-2,j,k) * M8(3,2) &
                         + vsp(i-1,j,k) * M8(4,2) &
                         + vsp(i  ,j,k) * M8(5,2) &
                         + vsp(i+1,j,k) * M8(6,2)
             mmtmp8(3,i) = vsp(i-4,j,k) * M8(1,3) &
                         + vsp(i-3,j,k) * M8(2,3) &
                         + vsp(i-2,j,k) * M8(3,3) &
                         + vsp(i-1,j,k) * M8(4,3) &
                         + vsp(i  ,j,k) * M8(5,3) &
                         + vsp(i+1,j,k) * M8(6,3) &
                         + vsp(i+2,j,k) * M8(7,3)
             mmtmp8(4,i) = vsp(i-4,j,k) * M8(1,4) &
                         + vsp(i-3,j,k) * M8(2,4) &
                         + vsp(i-2,j,k) * M8(3,4) &
                         + vsp(i-1,j,k) * M8(4,4) &
                         + vsp(i  ,j,k) * M8(5,4) &
                         + vsp(i+1,j,k) * M8(6,4) &
                         + vsp(i+2,j,k) * M8(7,4) &
                         + vsp(i+3,j,k) * M8(8,4)
             mmtmp8(5,i) =-vsp(i-4,j,k) * M8(8,4) &
                         - vsp(i-3,j,k) * M8(7,4) &
                         - vsp(i-2,j,k) * M8(6,4) &
                         - vsp(i-1,j,k) * M8(5,4) &
                         - vsp(i  ,j,k) * M8(4,4) &
                         - vsp(i+1,j,k) * M8(3,4) &
                         - vsp(i+2,j,k) * M8(2,4) &
                         - vsp(i+3,j,k) * M8(1,4)
             mmtmp8(6,i) =-vsp(i-3,j,k) * M8(7,3) &
                         - vsp(i-2,j,k) * M8(6,3) &
                         - vsp(i-1,j,k) * M8(5,3) &
                         - vsp(i  ,j,k) * M8(4,3) &
                         - vsp(i+1,j,k) * M8(3,3) &
                         - vsp(i+2,j,k) * M8(2,3) &
                         - vsp(i+3,j,k) * M8(1,3)
             mmtmp8(7,i) =-vsp(i-2,j,k) * M8(6,2) &
                         - vsp(i-1,j,k) * M8(5,2) &
                         - vsp(i  ,j,k) * M8(4,2) &
                         - vsp(i+1,j,k) * M8(3,2) &
                         - vsp(i+2,j,k) * M8(2,2) &
                         - vsp(i+3,j,k) * M8(1,2)
             mmtmp8(8,i) =-vsp(i-1,j,k) * M8(5,1) &
                         - vsp(i  ,j,k) * M8(4,1) &
                         - vsp(i+1,j,k) * M8(3,1) &
                         - vsp(i+2,j,k) * M8(2,1) &
                         - vsp(i+3,j,k) * M8(1,1)
!EXPAND             Hg(i,j,k,imx) = dot_product(mmtmp8(1:8,i), q(i-4:i+3,j,k,qu))
             Hg(i,j,k,imx) =  &
                ( mmtmp8(1,i)*q(i-4,j,k,qu) + mmtmp8(2,i)*q(i-3,j,k,qu) &
                + mmtmp8(3,i)*q(i-2,j,k,qu) + mmtmp8(4,i)*q(i-1,j,k,qu) &
                + mmtmp8(5,i)*q(i  ,j,k,qu) + mmtmp8(6,i)*q(i+1,j,k,qu) &
                + mmtmp8(7,i)*q(i+2,j,k,qu) + mmtmp8(8,i)*q(i+3,j,k,qu) )
          end do
       end do
    end do

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=slo(1),shi(1)+1
!EXPAND             mmtmp8(1:8,i) = matmul(mu(i-4:i+3,j,k), M8)
             mmtmp8(1,i) = mu(i-4,j,k) * M8(1,1) &
                         + mu(i-3,j,k) * M8(2,1) &
                         + mu(i-2,j,k) * M8(3,1) &
                         + mu(i-1,j,k) * M8(4,1) &
                         + mu(i  ,j,k) * M8(5,1)
             mmtmp8(2,i) = mu(i-4,j,k) * M8(1,2) &
                         + mu(i-3,j,k) * M8(2,2) &
                         + mu(i-2,j,k) * M8(3,2) &
                         + mu(i-1,j,k) * M8(4,2) &
                         + mu(i  ,j,k) * M8(5,2) &
                         + mu(i+1,j,k) * M8(6,2)
             mmtmp8(3,i) = mu(i-4,j,k) * M8(1,3) &
                         + mu(i-3,j,k) * M8(2,3) &
                         + mu(i-2,j,k) * M8(3,3) &
                         + mu(i-1,j,k) * M8(4,3) &
                         + mu(i  ,j,k) * M8(5,3) &
                         + mu(i+1,j,k) * M8(6,3) &
                         + mu(i+2,j,k) * M8(7,3)
             mmtmp8(4,i) = mu(i-4,j,k) * M8(1,4) &
                         + mu(i-3,j,k) * M8(2,4) &
                         + mu(i-2,j,k) * M8(3,4) &
                         + mu(i-1,j,k) * M8(4,4) &
                         + mu(i  ,j,k) * M8(5,4) &
                         + mu(i+1,j,k) * M8(6,4) &
                         + mu(i+2,j,k) * M8(7,4) &
                         + mu(i+3,j,k) * M8(8,4)
             mmtmp8(5,i) =-mu(i-4,j,k) * M8(8,4) &
                         - mu(i-3,j,k) * M8(7,4) &
                         - mu(i-2,j,k) * M8(6,4) &
                         - mu(i-1,j,k) * M8(5,4) &
                         - mu(i  ,j,k) * M8(4,4) &
                         - mu(i+1,j,k) * M8(3,4) &
                         - mu(i+2,j,k) * M8(2,4) &
                         - mu(i+3,j,k) * M8(1,4)
             mmtmp8(6,i) =-mu(i-3,j,k) * M8(7,3) &
                         - mu(i-2,j,k) * M8(6,3) &
                         - mu(i-1,j,k) * M8(5,3) &
                         - mu(i  ,j,k) * M8(4,3) &
                         - mu(i+1,j,k) * M8(3,3) &
                         - mu(i+2,j,k) * M8(2,3) &
                         - mu(i+3,j,k) * M8(1,3)
             mmtmp8(7,i) =-mu(i-2,j,k) * M8(6,2) &
                         - mu(i-1,j,k) * M8(5,2) &
                         - mu(i  ,j,k) * M8(4,2) &
                         - mu(i+1,j,k) * M8(3,2) &
                         - mu(i+2,j,k) * M8(2,2) &
                         - mu(i+3,j,k) * M8(1,2)
             mmtmp8(8,i) =-mu(i-1,j,k) * M8(5,1) &
                         - mu(i  ,j,k) * M8(4,1) &
                         - mu(i+1,j,k) * M8(3,1) &
                         - mu(i+2,j,k) * M8(2,1) &
                         - mu(i+3,j,k) * M8(1,1)
!EXPAND             Hg(i,j,k,imy) = dot_product(mmtmp8(1:8,i), q(i-4:i+3,j,k,qv))
             Hg(i,j,k,imy) =  &
                ( mmtmp8(1,i)*q(i-4,j,k,qv) + mmtmp8(2,i)*q(i-3,j,k,qv) &
                + mmtmp8(3,i)*q(i-2,j,k,qv) + mmtmp8(4,i)*q(i-1,j,k,qv) &
                + mmtmp8(5,i)*q(i  ,j,k,qv) + mmtmp8(6,i)*q(i+1,j,k,qv) &
                + mmtmp8(7,i)*q(i+2,j,k,qv) + mmtmp8(8,i)*q(i+3,j,k,qv) )
!EXPAND             Hg(i,j,k,imz) = dot_product(mmtmp8(1:8,i), q(i-4:i+3,j,k,qw))
             Hg(i,j,k,imz) =  &
                ( mmtmp8(1,i)*q(i-4,j,k,qw) + mmtmp8(2,i)*q(i-3,j,k,qw) &
                + mmtmp8(3,i)*q(i-2,j,k,qw) + mmtmp8(4,i)*q(i-1,j,k,qw) &
                + mmtmp8(5,i)*q(i  ,j,k,qw) + mmtmp8(6,i)*q(i+1,j,k,qw) &
                + mmtmp8(7,i)*q(i+2,j,k,qw) + mmtmp8(8,i)*q(i+3,j,k,qw) )
          end do
       end do
    end do

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=slo(1),shi(1)+1
!EXPAND             mmtmp8(1:8,i) = matmul(lam(i-4:i+3,j,k), M8)
             mmtmp8(1,i) = lam(i-4,j,k) * M8(1,1) &
                         + lam(i-3,j,k) * M8(2,1) &
                         + lam(i-2,j,k) * M8(3,1) &
                         + lam(i-1,j,k) * M8(4,1) &
                         + lam(i  ,j,k) * M8(5,1)
             mmtmp8(2,i) = lam(i-4,j,k) * M8(1,2) &
                         + lam(i-3,j,k) * M8(2,2) &
                         + lam(i-2,j,k) * M8(3,2) &
                         + lam(i-1,j,k) * M8(4,2) &
                         + lam(i  ,j,k) * M8(5,2) &
                         + lam(i+1,j,k) * M8(6,2)
             mmtmp8(3,i) = lam(i-4,j,k) * M8(1,3) &
                         + lam(i-3,j,k) * M8(2,3) &
                         + lam(i-2,j,k) * M8(3,3) &
                         + lam(i-1,j,k) * M8(4,3) &
                         + lam(i  ,j,k) * M8(5,3) &
                         + lam(i+1,j,k) * M8(6,3) &
                         + lam(i+2,j,k) * M8(7,3)
             mmtmp8(4,i) = lam(i-4,j,k) * M8(1,4) &
                         + lam(i-3,j,k) * M8(2,4) &
                         + lam(i-2,j,k) * M8(3,4) &
                         + lam(i-1,j,k) * M8(4,4) &
                         + lam(i  ,j,k) * M8(5,4) &
                         + lam(i+1,j,k) * M8(6,4) &
                         + lam(i+2,j,k) * M8(7,4) &
                         + lam(i+3,j,k) * M8(8,4)
             mmtmp8(5,i) =-lam(i-4,j,k) * M8(8,4) &
                         - lam(i-3,j,k) * M8(7,4) &
                         - lam(i-2,j,k) * M8(6,4) &
                         - lam(i-1,j,k) * M8(5,4) &
                         - lam(i  ,j,k) * M8(4,4) &
                         - lam(i+1,j,k) * M8(3,4) &
                         - lam(i+2,j,k) * M8(2,4) &
                         - lam(i+3,j,k) * M8(1,4)
             mmtmp8(6,i) =-lam(i-3,j,k) * M8(7,3) &
                         - lam(i-2,j,k) * M8(6,3) &
                         - lam(i-1,j,k) * M8(5,3) &
                         - lam(i  ,j,k) * M8(4,3) &
                         - lam(i+1,j,k) * M8(3,3) &
                         - lam(i+2,j,k) * M8(2,3) &
                         - lam(i+3,j,k) * M8(1,3)
             mmtmp8(7,i) =-lam(i-2,j,k) * M8(6,2) &
                         - lam(i-1,j,k) * M8(5,2) &
                         - lam(i  ,j,k) * M8(4,2) &
                         - lam(i+1,j,k) * M8(3,2) &
                         - lam(i+2,j,k) * M8(2,2) &
                         - lam(i+3,j,k) * M8(1,2)
             mmtmp8(8,i) =-lam(i-1,j,k) * M8(5,1) &
                         - lam(i  ,j,k) * M8(4,1) &
                         - lam(i+1,j,k) * M8(3,1) &
                         - lam(i+2,j,k) * M8(2,1) &
                         - lam(i+3,j,k) * M8(1,1)
!EXPAND             Hg(i,j,k,iene) = dot_product(mmtmp8(1:8,i), q(i-4:i+3,j,k,qtemp))
             Hg(i,j,k,iene) =  &
                ( mmtmp8(1,i)*q(i-4,j,k,qtemp) + mmtmp8(2,i)*q(i-3,j,k,qtemp) &
                + mmtmp8(3,i)*q(i-2,j,k,qtemp) + mmtmp8(4,i)*q(i-1,j,k,qtemp) &
                + mmtmp8(5,i)*q(i  ,j,k,qtemp) + mmtmp8(6,i)*q(i+1,j,k,qtemp) &
                + mmtmp8(7,i)*q(i+2,j,k,qtemp) + mmtmp8(8,i)*q(i+3,j,k,qtemp) )
          end do
       end do
    end do

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=slo(1),shi(1)+1
!EXPAND             mmtmp8(1:8,i) = matmul(M8,  q(i-4:i+3,j,k,qpres))
             mmtmp8(1,i) = M8(1,1) * q(i-4,j,k,qpres) &
                         + M8(1,2) * q(i-3,j,k,qpres) &
                         + M8(1,3) * q(i-2,j,k,qpres) &
                         + M8(1,4) * q(i-1,j,k,qpres) &
                         - M8(8,4) * q(i  ,j,k,qpres)
             mmtmp8(2,i) = M8(2,1) * q(i-4,j,k,qpres) &
                         + M8(2,2) * q(i-3,j,k,qpres) &
                         + M8(2,3) * q(i-2,j,k,qpres) &
                         + M8(2,4) * q(i-1,j,k,qpres) &
                         - M8(7,4) * q(i  ,j,k,qpres) &
                         - M8(7,3) * q(i+1,j,k,qpres)
             mmtmp8(3,i) = M8(3,1) * q(i-4,j,k,qpres) &
                         + M8(3,2) * q(i-3,j,k,qpres) &
                         + M8(3,3) * q(i-2,j,k,qpres) &
                         + M8(3,4) * q(i-1,j,k,qpres) &
                         - M8(6,4) * q(i  ,j,k,qpres) &
                         - M8(6,3) * q(i+1,j,k,qpres) &
                         - M8(6,2) * q(i+2,j,k,qpres)
             mmtmp8(4,i) = M8(4,1) * q(i-4,j,k,qpres) &
                         + M8(4,2) * q(i-3,j,k,qpres) &
                         + M8(4,3) * q(i-2,j,k,qpres) &
                         + M8(4,4) * q(i-1,j,k,qpres) &
                         - M8(5,4) * q(i  ,j,k,qpres) &
                         - M8(5,3) * q(i+1,j,k,qpres) &
                         - M8(5,2) * q(i+2,j,k,qpres) &
                         - M8(5,1) * q(i+3,j,k,qpres)
             mmtmp8(5,i) = M8(5,1) * q(i-4,j,k,qpres) &
                         + M8(5,2) * q(i-3,j,k,qpres) &
                         + M8(5,3) * q(i-2,j,k,qpres) &
                         + M8(5,4) * q(i-1,j,k,qpres) &
                         - M8(4,4) * q(i  ,j,k,qpres) &
                         - M8(4,3) * q(i+1,j,k,qpres) &
                         - M8(4,2) * q(i+2,j,k,qpres) &
                         - M8(4,1) * q(i+3,j,k,qpres)
             mmtmp8(6,i) = M8(6,2) * q(i-3,j,k,qpres) &
                         + M8(6,3) * q(i-2,j,k,qpres) &
                         + M8(6,4) * q(i-1,j,k,qpres) &
                         - M8(3,4) * q(i  ,j,k,qpres) &
                         - M8(3,3) * q(i+1,j,k,qpres) &
                         - M8(3,2) * q(i+2,j,k,qpres) &
                         - M8(3,1) * q(i+3,j,k,qpres)
             mmtmp8(7,i) = M8(7,3) * q(i-2,j,k,qpres) &
                         + M8(7,4) * q(i-1,j,k,qpres) &
                         - M8(2,4) * q(i  ,j,k,qpres) &
                         - M8(2,3) * q(i+1,j,k,qpres) &
                         - M8(2,2) * q(i+2,j,k,qpres) &
                         - M8(2,1) * q(i+3,j,k,qpres)
             mmtmp8(8,i) = M8(8,4) * q(i-1,j,k,qpres) &
                         - M8(1,4) * q(i  ,j,k,qpres) &
                         - M8(1,3) * q(i+1,j,k,qpres) &
                         - M8(1,2) * q(i+2,j,k,qpres) &
                         - M8(1,1) * q(i+3,j,k,qpres)
!EXPAND             Hg(i,j,k,iene) = Hg(i,j,k,iene) + dot_product(dpe(i-4:i+3,j,k), mmtmp8(1:8,i))
             Hg(i,j,k,iene) = Hg(i,j,k,iene)+ &
                ( dpe(i-4,j,k)*mmtmp8(1,i) + dpe(i-3,j,k)*mmtmp8(2,i) &
                + dpe(i-2,j,k)*mmtmp8(3,i) + dpe(i-1,j,k)*mmtmp8(4,i) &
                + dpe(i  ,j,k)*mmtmp8(5,i) + dpe(i+1,j,k)*mmtmp8(6,i) &
                + dpe(i+2,j,k)*mmtmp8(7,i) + dpe(i+3,j,k)*mmtmp8(8,i) )
          end do
          do i=slo(1),shi(1)+1
             M8p(:,i,j,k) = mmtmp8(1:8,i)
          end do
       end do
    end do

    do n = 1, nspecies
       qxn = qx1+n-1

       do k=lo(3),hi(3)
          do j=lo(2),hi(2)   
             do i=slo(1),shi(1)+1
!EXPAND                Hg(i,j,k,iry1+n-1) = dot_product(dpy(i-4:i+3,j,k,n), M8p(:,i,j,k))
                Hg(i,j,k,iry1+n-1) =  &
                   ( dpy(i-4,j,k,n)*M8p(1,i,j,k) + dpy(i-3,j,k,n)*M8p(2,i,j,k) &
                   + dpy(i-2,j,k,n)*M8p(3,i,j,k) + dpy(i-1,j,k,n)*M8p(4,i,j,k) &
                   + dpy(i  ,j,k,n)*M8p(5,i,j,k) + dpy(i+1,j,k,n)*M8p(6,i,j,k) &
                   + dpy(i+2,j,k,n)*M8p(7,i,j,k) + dpy(i+3,j,k,n)*M8p(8,i,j,k) )
             end do
          end do
       end do

       do k=lo(3),hi(3)
          do j=lo(2),hi(2)   
             do i=slo(1),shi(1)+1
!EXPAND                mmtmp8(1:8,i) = matmul(M8, q(i-4:i+3,j,k,qxn))
                mmtmp8(1,i) = M8(1,1) * q(i-4,j,k,qxn) &
                            + M8(1,2) * q(i-3,j,k,qxn) &
                            + M8(1,3) * q(i-2,j,k,qxn) &
                            + M8(1,4) * q(i-1,j,k,qxn) &
                            - M8(8,4) * q(i  ,j,k,qxn)
                mmtmp8(2,i) = M8(2,1) * q(i-4,j,k,qxn) &
                            + M8(2,2) * q(i-3,j,k,qxn) &
                            + M8(2,3) * q(i-2,j,k,qxn) &
                            + M8(2,4) * q(i-1,j,k,qxn) &
                            - M8(7,4) * q(i  ,j,k,qxn) &
                            - M8(7,3) * q(i+1,j,k,qxn)
                mmtmp8(3,i) = M8(3,1) * q(i-4,j,k,qxn) &
                            + M8(3,2) * q(i-3,j,k,qxn) &
                            + M8(3,3) * q(i-2,j,k,qxn) &
                            + M8(3,4) * q(i-1,j,k,qxn) &
                            - M8(6,4) * q(i  ,j,k,qxn) &
                            - M8(6,3) * q(i+1,j,k,qxn) &
                            - M8(6,2) * q(i+2,j,k,qxn)
                mmtmp8(4,i) = M8(4,1) * q(i-4,j,k,qxn) &
                            + M8(4,2) * q(i-3,j,k,qxn) &
                            + M8(4,3) * q(i-2,j,k,qxn) &
                            + M8(4,4) * q(i-1,j,k,qxn) &
                            - M8(5,4) * q(i  ,j,k,qxn) &
                            - M8(5,3) * q(i+1,j,k,qxn) &
                            - M8(5,2) * q(i+2,j,k,qxn) &
                            - M8(5,1) * q(i+3,j,k,qxn)
                mmtmp8(5,i) = M8(5,1) * q(i-4,j,k,qxn) &
                            + M8(5,2) * q(i-3,j,k,qxn) &
                            + M8(5,3) * q(i-2,j,k,qxn) &
                            + M8(5,4) * q(i-1,j,k,qxn) &
                            - M8(4,4) * q(i  ,j,k,qxn) &
                            - M8(4,3) * q(i+1,j,k,qxn) &
                            - M8(4,2) * q(i+2,j,k,qxn) &
                            - M8(4,1) * q(i+3,j,k,qxn)
                mmtmp8(6,i) = M8(6,2) * q(i-3,j,k,qxn) &
                            + M8(6,3) * q(i-2,j,k,qxn) &
                            + M8(6,4) * q(i-1,j,k,qxn) &
                            - M8(3,4) * q(i  ,j,k,qxn) &
                            - M8(3,3) * q(i+1,j,k,qxn) &
                            - M8(3,2) * q(i+2,j,k,qxn) &
                            - M8(3,1) * q(i+3,j,k,qxn)
                mmtmp8(7,i) = M8(7,3) * q(i-2,j,k,qxn) &
                            + M8(7,4) * q(i-1,j,k,qxn) &
                            - M8(2,4) * q(i  ,j,k,qxn) &
                            - M8(2,3) * q(i+1,j,k,qxn) &
                            - M8(2,2) * q(i+2,j,k,qxn) &
                            - M8(2,1) * q(i+3,j,k,qxn)
                mmtmp8(8,i) = M8(8,4) * q(i-1,j,k,qxn) &
                            - M8(1,4) * q(i  ,j,k,qxn) &
                            - M8(1,3) * q(i+1,j,k,qxn) &
                            - M8(1,2) * q(i+2,j,k,qxn) &
                            - M8(1,1) * q(i+3,j,k,qxn)
!EXPAND                Hg(i,j,k,iene) = Hg(i,j,k,iene) + dot_product(dxe(i-4:i+3,j,k,n), mmtmp8(1:8,i))
                Hg(i,j,k,iene) = Hg(i,j,k,iene)+ &
                   ( dxe(i-4,j,k,n)*mmtmp8(1,i) + dxe(i-3,j,k,n)*mmtmp8(2,i) &
                   + dxe(i-2,j,k,n)*mmtmp8(3,i) + dxe(i-1,j,k,n)*mmtmp8(4,i) &
                   + dxe(i  ,j,k,n)*mmtmp8(5,i) + dxe(i+1,j,k,n)*mmtmp8(6,i) &
                   + dxe(i+2,j,k,n)*mmtmp8(7,i) + dxe(i+3,j,k,n)*mmtmp8(8,i) )
!EXPAND                Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1) &
!EXPAND                     + dot_product(dxy(i-4:i+3,j,k,n), mmtmp8(1:8,i))
                Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1)+ &
                   ( dxy(i-4,j,k,n)*mmtmp8(1,i) + dxy(i-3,j,k,n)*mmtmp8(2,i) &
                   + dxy(i-2,j,k,n)*mmtmp8(3,i) + dxy(i-1,j,k,n)*mmtmp8(4,i) &
                   + dxy(i  ,j,k,n)*mmtmp8(5,i) + dxy(i+1,j,k,n)*mmtmp8(6,i) &
                   + dxy(i+2,j,k,n)*mmtmp8(7,i) + dxy(i+3,j,k,n)*mmtmp8(8,i) )
             end do

          end do
       end do
    end do

    if (.not.reset_N2) then
       ! correction
       Hry = 0.d0

       do n = 1, nspecies
          do k=lo(3),hi(3)
             do j=lo(2),hi(2)
                do i=slo(1),shi(1)+1
                   Hry(i,j,k) = Hry(i,j,k) + Hg(i,j,k,iry1+n-1)
                end do
             end do
          end do
       end do
    
       do n = 1, nspecies
          qyn = qy1+n-1
          qhn = qh1+n-1
          do k=lo(3),hi(3)
             do j=lo(2),hi(2)
                do i=slo(1),shi(1)+1
                   Yhalf = 0.5d0*(q(i-1,j,k,qyn) + q(i,j,k,qyn))
                   hhalf = 0.5d0*(q(i-1,j,k,qhn) + q(i,j,k,qhn))
                   Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1)- (Yhalf*Hry(i,j,k))
                   Hg(i,j,k,iene) = Hg(i,j,k,iene) - (Yhalf*Hry(i,j,k))*hhalf
                end do
             end do
          end do
       end do
    end if

    ! add x-direction rhs
    do n=2,ncons
       do k=lo(3),hi(3)
          do j=lo(2),hi(2)
             do i=slo(1),shi(1)
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hg(i+1,j,k,n) - Hg(i,j,k,n)) * dx2inv(1)
             end do
          end do
       end do
    end do

    ! ------- END x-direction -------

    ! ------- BEGIN y-direction -------

    do k=lo(3),hi(3)
       do j=slo(2),shi(2)+1
          do i=lo(1),hi(1)             
!EXPAND             mmtmp8(1:8,i) = matmul(mu(i,j-4:j+3,k), M8)
             mmtmp8(1,i) = mu(i,j-4,k) * M8(1,1) &
                         + mu(i,j-3,k) * M8(2,1) &
                         + mu(i,j-2,k) * M8(3,1) &
                         + mu(i,j-1,k) * M8(4,1) &
                         + mu(i,j  ,k) * M8(5,1)
             mmtmp8(2,i) = mu(i,j-4,k) * M8(1,2) &
                         + mu(i,j-3,k) * M8(2,2) &
                         + mu(i,j-2,k) * M8(3,2) &
                         + mu(i,j-1,k) * M8(4,2) &
                         + mu(i,j  ,k) * M8(5,2) &
                         + mu(i,j+1,k) * M8(6,2)
             mmtmp8(3,i) = mu(i,j-4,k) * M8(1,3) &
                         + mu(i,j-3,k) * M8(2,3) &
                         + mu(i,j-2,k) * M8(3,3) &
                         + mu(i,j-1,k) * M8(4,3) &
                         + mu(i,j  ,k) * M8(5,3) &
                         + mu(i,j+1,k) * M8(6,3) &
                         + mu(i,j+2,k) * M8(7,3)
             mmtmp8(4,i) = mu(i,j-4,k) * M8(1,4) &
                         + mu(i,j-3,k) * M8(2,4) &
                         + mu(i,j-2,k) * M8(3,4) &
                         + mu(i,j-1,k) * M8(4,4) &
                         + mu(i,j  ,k) * M8(5,4) &
                         + mu(i,j+1,k) * M8(6,4) &
                         + mu(i,j+2,k) * M8(7,4) &
                         + mu(i,j+3,k) * M8(8,4)
             mmtmp8(5,i) =-mu(i,j-4,k) * M8(8,4) &
                         - mu(i,j-3,k) * M8(7,4) &
                         - mu(i,j-2,k) * M8(6,4) &
                         - mu(i,j-1,k) * M8(5,4) &
                         - mu(i,j  ,k) * M8(4,4) &
                         - mu(i,j+1,k) * M8(3,4) &
                         - mu(i,j+2,k) * M8(2,4) &
                         - mu(i,j+3,k) * M8(1,4)
             mmtmp8(6,i) =-mu(i,j-3,k) * M8(7,3) &
                         - mu(i,j-2,k) * M8(6,3) &
                         - mu(i,j-1,k) * M8(5,3) &
                         - mu(i,j  ,k) * M8(4,3) &
                         - mu(i,j+1,k) * M8(3,3) &
                         - mu(i,j+2,k) * M8(2,3) &
                         - mu(i,j+3,k) * M8(1,3)
             mmtmp8(7,i) =-mu(i,j-2,k) * M8(6,2) &
                         - mu(i,j-1,k) * M8(5,2) &
                         - mu(i,j  ,k) * M8(4,2) &
                         - mu(i,j+1,k) * M8(3,2) &
                         - mu(i,j+2,k) * M8(2,2) &
                         - mu(i,j+3,k) * M8(1,2)
             mmtmp8(8,i) =-mu(i,j-1,k) * M8(5,1) &
                         - mu(i,j  ,k) * M8(4,1) &
                         - mu(i,j+1,k) * M8(3,1) &
                         - mu(i,j+2,k) * M8(2,1) &
                         - mu(i,j+3,k) * M8(1,1)
!EXPAND             Hg(i,j,k,imx) = dot_product(mmtmp8(1:8,i), q(i,j-4:j+3,k,qu))
             Hg(i,j,k,imx) =  &
                ( mmtmp8(1,i)*q(i,j-4,k,qu) + mmtmp8(2,i)*q(i,j-3,k,qu) &
                + mmtmp8(3,i)*q(i,j-2,k,qu) + mmtmp8(4,i)*q(i,j-1,k,qu) &
                + mmtmp8(5,i)*q(i,j  ,k,qu) + mmtmp8(6,i)*q(i,j+1,k,qu) &
                + mmtmp8(7,i)*q(i,j+2,k,qu) + mmtmp8(8,i)*q(i,j+3,k,qu) )
!EXPAND             Hg(i,j,k,imz) = dot_product(mmtmp8(1:8,i), q(i,j-4:j+3,k,qw))
             Hg(i,j,k,imz) =  &
                ( mmtmp8(1,i)*q(i,j-4,k,qw) + mmtmp8(2,i)*q(i,j-3,k,qw) &
                + mmtmp8(3,i)*q(i,j-2,k,qw) + mmtmp8(4,i)*q(i,j-1,k,qw) &
                + mmtmp8(5,i)*q(i,j  ,k,qw) + mmtmp8(6,i)*q(i,j+1,k,qw) &
                + mmtmp8(7,i)*q(i,j+2,k,qw) + mmtmp8(8,i)*q(i,j+3,k,qw) )
          end do
       end do
    end do

    do k=lo(3),hi(3)
       do j=slo(2),shi(2)+1
          do i=lo(1),hi(1)             
!EXPAND             mmtmp8(1:8,i) = matmul(vsp(i,j-4:j+3,k), M8)
             mmtmp8(1,i) = vsp(i,j-4,k) * M8(1,1) &
                         + vsp(i,j-3,k) * M8(2,1) &
                         + vsp(i,j-2,k) * M8(3,1) &
                         + vsp(i,j-1,k) * M8(4,1) &
                         + vsp(i,j  ,k) * M8(5,1)
             mmtmp8(2,i) = vsp(i,j-4,k) * M8(1,2) &
                         + vsp(i,j-3,k) * M8(2,2) &
                         + vsp(i,j-2,k) * M8(3,2) &
                         + vsp(i,j-1,k) * M8(4,2) &
                         + vsp(i,j  ,k) * M8(5,2) &
                         + vsp(i,j+1,k) * M8(6,2)
             mmtmp8(3,i) = vsp(i,j-4,k) * M8(1,3) &
                         + vsp(i,j-3,k) * M8(2,3) &
                         + vsp(i,j-2,k) * M8(3,3) &
                         + vsp(i,j-1,k) * M8(4,3) &
                         + vsp(i,j  ,k) * M8(5,3) &
                         + vsp(i,j+1,k) * M8(6,3) &
                         + vsp(i,j+2,k) * M8(7,3)
             mmtmp8(4,i) = vsp(i,j-4,k) * M8(1,4) &
                         + vsp(i,j-3,k) * M8(2,4) &
                         + vsp(i,j-2,k) * M8(3,4) &
                         + vsp(i,j-1,k) * M8(4,4) &
                         + vsp(i,j  ,k) * M8(5,4) &
                         + vsp(i,j+1,k) * M8(6,4) &
                         + vsp(i,j+2,k) * M8(7,4) &
                         + vsp(i,j+3,k) * M8(8,4)
             mmtmp8(5,i) =-vsp(i,j-4,k) * M8(8,4) &
                         - vsp(i,j-3,k) * M8(7,4) &
                         - vsp(i,j-2,k) * M8(6,4) &
                         - vsp(i,j-1,k) * M8(5,4) &
                         - vsp(i,j  ,k) * M8(4,4) &
                         - vsp(i,j+1,k) * M8(3,4) &
                         - vsp(i,j+2,k) * M8(2,4) &
                         - vsp(i,j+3,k) * M8(1,4)
             mmtmp8(6,i) =-vsp(i,j-3,k) * M8(7,3) &
                         - vsp(i,j-2,k) * M8(6,3) &
                         - vsp(i,j-1,k) * M8(5,3) &
                         - vsp(i,j  ,k) * M8(4,3) &
                         - vsp(i,j+1,k) * M8(3,3) &
                         - vsp(i,j+2,k) * M8(2,3) &
                         - vsp(i,j+3,k) * M8(1,3)
             mmtmp8(7,i) =-vsp(i,j-2,k) * M8(6,2) &
                         - vsp(i,j-1,k) * M8(5,2) &
                         - vsp(i,j  ,k) * M8(4,2) &
                         - vsp(i,j+1,k) * M8(3,2) &
                         - vsp(i,j+2,k) * M8(2,2) &
                         - vsp(i,j+3,k) * M8(1,2)
             mmtmp8(8,i) =-vsp(i,j-1,k) * M8(5,1) &
                         - vsp(i,j  ,k) * M8(4,1) &
                         - vsp(i,j+1,k) * M8(3,1) &
                         - vsp(i,j+2,k) * M8(2,1) &
                         - vsp(i,j+3,k) * M8(1,1)
!EXPAND             Hg(i,j,k,imy) = dot_product(mmtmp8(1:8,i), q(i,j-4:j+3,k,qv))
             Hg(i,j,k,imy) =  &
                ( mmtmp8(1,i)*q(i,j-4,k,qv) + mmtmp8(2,i)*q(i,j-3,k,qv) &
                + mmtmp8(3,i)*q(i,j-2,k,qv) + mmtmp8(4,i)*q(i,j-1,k,qv) &
                + mmtmp8(5,i)*q(i,j  ,k,qv) + mmtmp8(6,i)*q(i,j+1,k,qv) &
                + mmtmp8(7,i)*q(i,j+2,k,qv) + mmtmp8(8,i)*q(i,j+3,k,qv) )
          end do
       end do
    end do

    do k=lo(3),hi(3)
       do j=slo(2),shi(2)+1
          do i=lo(1),hi(1)
!EXPAND             mmtmp8(1:8,i) = matmul(lam(i,j-4:j+3,k), M8)
             mmtmp8(1,i) = lam(i,j-4,k) * M8(1,1) &
                         + lam(i,j-3,k) * M8(2,1) &
                         + lam(i,j-2,k) * M8(3,1) &
                         + lam(i,j-1,k) * M8(4,1) &
                         + lam(i,j  ,k) * M8(5,1)
             mmtmp8(2,i) = lam(i,j-4,k) * M8(1,2) &
                         + lam(i,j-3,k) * M8(2,2) &
                         + lam(i,j-2,k) * M8(3,2) &
                         + lam(i,j-1,k) * M8(4,2) &
                         + lam(i,j  ,k) * M8(5,2) &
                         + lam(i,j+1,k) * M8(6,2)
             mmtmp8(3,i) = lam(i,j-4,k) * M8(1,3) &
                         + lam(i,j-3,k) * M8(2,3) &
                         + lam(i,j-2,k) * M8(3,3) &
                         + lam(i,j-1,k) * M8(4,3) &
                         + lam(i,j  ,k) * M8(5,3) &
                         + lam(i,j+1,k) * M8(6,3) &
                         + lam(i,j+2,k) * M8(7,3)
             mmtmp8(4,i) = lam(i,j-4,k) * M8(1,4) &
                         + lam(i,j-3,k) * M8(2,4) &
                         + lam(i,j-2,k) * M8(3,4) &
                         + lam(i,j-1,k) * M8(4,4) &
                         + lam(i,j  ,k) * M8(5,4) &
                         + lam(i,j+1,k) * M8(6,4) &
                         + lam(i,j+2,k) * M8(7,4) &
                         + lam(i,j+3,k) * M8(8,4)
             mmtmp8(5,i) =-lam(i,j-4,k) * M8(8,4) &
                         - lam(i,j-3,k) * M8(7,4) &
                         - lam(i,j-2,k) * M8(6,4) &
                         - lam(i,j-1,k) * M8(5,4) &
                         - lam(i,j  ,k) * M8(4,4) &
                         - lam(i,j+1,k) * M8(3,4) &
                         - lam(i,j+2,k) * M8(2,4) &
                         - lam(i,j+3,k) * M8(1,4)
             mmtmp8(6,i) =-lam(i,j-3,k) * M8(7,3) &
                         - lam(i,j-2,k) * M8(6,3) &
                         - lam(i,j-1,k) * M8(5,3) &
                         - lam(i,j  ,k) * M8(4,3) &
                         - lam(i,j+1,k) * M8(3,3) &
                         - lam(i,j+2,k) * M8(2,3) &
                         - lam(i,j+3,k) * M8(1,3)
             mmtmp8(7,i) =-lam(i,j-2,k) * M8(6,2) &
                         - lam(i,j-1,k) * M8(5,2) &
                         - lam(i,j  ,k) * M8(4,2) &
                         - lam(i,j+1,k) * M8(3,2) &
                         - lam(i,j+2,k) * M8(2,2) &
                         - lam(i,j+3,k) * M8(1,2)
             mmtmp8(8,i) =-lam(i,j-1,k) * M8(5,1) &
                         - lam(i,j  ,k) * M8(4,1) &
                         - lam(i,j+1,k) * M8(3,1) &
                         - lam(i,j+2,k) * M8(2,1) &
                         - lam(i,j+3,k) * M8(1,1)
!EXPAND             Hg(i,j,k,iene) = dot_product(mmtmp8(1:8,i), q(i,j-4:j+3,k,qtemp))
             Hg(i,j,k,iene) =  &
                ( mmtmp8(1,i)*q(i,j-4,k,qtemp) + mmtmp8(2,i)*q(i,j-3,k,qtemp) &
                + mmtmp8(3,i)*q(i,j-2,k,qtemp) + mmtmp8(4,i)*q(i,j-1,k,qtemp) &
                + mmtmp8(5,i)*q(i,j  ,k,qtemp) + mmtmp8(6,i)*q(i,j+1,k,qtemp) &
                + mmtmp8(7,i)*q(i,j+2,k,qtemp) + mmtmp8(8,i)*q(i,j+3,k,qtemp) )
          end do
       end do
    end do

    do k=lo(3),hi(3)
       do j=slo(2),shi(2)+1
          do i=lo(1),hi(1)
!EXPAND             mmtmp8(1:8,i) = matmul(M8, q(i,j-4:j+3,k,qpres))
             mmtmp8(1,i) = M8(1,1) * q(i,j-4,k,qpres) &
                         + M8(1,2) * q(i,j-3,k,qpres) &
                         + M8(1,3) * q(i,j-2,k,qpres) &
                         + M8(1,4) * q(i,j-1,k,qpres) &
                         - M8(8,4) * q(i,j  ,k,qpres)
             mmtmp8(2,i) = M8(2,1) * q(i,j-4,k,qpres) &
                         + M8(2,2) * q(i,j-3,k,qpres) &
                         + M8(2,3) * q(i,j-2,k,qpres) &
                         + M8(2,4) * q(i,j-1,k,qpres) &
                         - M8(7,4) * q(i,j  ,k,qpres) &
                         - M8(7,3) * q(i,j+1,k,qpres)
             mmtmp8(3,i) = M8(3,1) * q(i,j-4,k,qpres) &
                         + M8(3,2) * q(i,j-3,k,qpres) &
                         + M8(3,3) * q(i,j-2,k,qpres) &
                         + M8(3,4) * q(i,j-1,k,qpres) &
                         - M8(6,4) * q(i,j  ,k,qpres) &
                         - M8(6,3) * q(i,j+1,k,qpres) &
                         - M8(6,2) * q(i,j+2,k,qpres)
             mmtmp8(4,i) = M8(4,1) * q(i,j-4,k,qpres) &
                         + M8(4,2) * q(i,j-3,k,qpres) &
                         + M8(4,3) * q(i,j-2,k,qpres) &
                         + M8(4,4) * q(i,j-1,k,qpres) &
                         - M8(5,4) * q(i,j  ,k,qpres) &
                         - M8(5,3) * q(i,j+1,k,qpres) &
                         - M8(5,2) * q(i,j+2,k,qpres) &
                         - M8(5,1) * q(i,j+3,k,qpres)
             mmtmp8(5,i) = M8(5,1) * q(i,j-4,k,qpres) &
                         + M8(5,2) * q(i,j-3,k,qpres) &
                         + M8(5,3) * q(i,j-2,k,qpres) &
                         + M8(5,4) * q(i,j-1,k,qpres) &
                         - M8(4,4) * q(i,j  ,k,qpres) &
                         - M8(4,3) * q(i,j+1,k,qpres) &
                         - M8(4,2) * q(i,j+2,k,qpres) &
                         - M8(4,1) * q(i,j+3,k,qpres)
             mmtmp8(6,i) = M8(6,2) * q(i,j-3,k,qpres) &
                         + M8(6,3) * q(i,j-2,k,qpres) &
                         + M8(6,4) * q(i,j-1,k,qpres) &
                         - M8(3,4) * q(i,j  ,k,qpres) &
                         - M8(3,3) * q(i,j+1,k,qpres) &
                         - M8(3,2) * q(i,j+2,k,qpres) &
                         - M8(3,1) * q(i,j+3,k,qpres)
             mmtmp8(7,i) = M8(7,3) * q(i,j-2,k,qpres) &
                         + M8(7,4) * q(i,j-1,k,qpres) &
                         - M8(2,4) * q(i,j  ,k,qpres) &
                         - M8(2,3) * q(i,j+1,k,qpres) &
                         - M8(2,2) * q(i,j+2,k,qpres) &
                         - M8(2,1) * q(i,j+3,k,qpres)
             mmtmp8(8,i) = M8(8,4) * q(i,j-1,k,qpres) &
                         - M8(1,4) * q(i,j  ,k,qpres) &
                         - M8(1,3) * q(i,j+1,k,qpres) &
                         - M8(1,2) * q(i,j+2,k,qpres) &
                         - M8(1,1) * q(i,j+3,k,qpres)
!EXPAND             Hg(i,j,k,iene) = Hg(i,j,k,iene) + dot_product(dpe(i,j-4:j+3,k), mmtmp8(1:8,i))
             Hg(i,j,k,iene) = Hg(i,j,k,iene)+ &
                ( dpe(i,j-4,k)*mmtmp8(1,i) + dpe(i,j-3,k)*mmtmp8(2,i) &
                + dpe(i,j-2,k)*mmtmp8(3,i) + dpe(i,j-1,k)*mmtmp8(4,i) &
                + dpe(i,j  ,k)*mmtmp8(5,i) + dpe(i,j+1,k)*mmtmp8(6,i) &
                + dpe(i,j+2,k)*mmtmp8(7,i) + dpe(i,j+3,k)*mmtmp8(8,i) )
          end do
          do i=lo(1),hi(1)
             M8p(:,i,j,k) = mmtmp8(1:8,i)
          end do
       end do
    end do

    do n = 1, nspecies
       qxn = qx1+n-1

       do k=lo(3),hi(3)
          do j=slo(2),shi(2)+1
             do i=lo(1),hi(1)
!EXPAND                Hg(i,j,k,iry1+n-1) = dot_product(dpy(i,j-4:j+3,k,n), M8p(:,i,j,k))
                Hg(i,j,k,iry1+n-1) =  &
                   ( dpy(i,j-4,k,n)*M8p(1,i,j,k) + dpy(i,j-3,k,n)*M8p(2,i,j,k) &
                   + dpy(i,j-2,k,n)*M8p(3,i,j,k) + dpy(i,j-1,k,n)*M8p(4,i,j,k) &
                   + dpy(i,j  ,k,n)*M8p(5,i,j,k) + dpy(i,j+1,k,n)*M8p(6,i,j,k) &
                   + dpy(i,j+2,k,n)*M8p(7,i,j,k) + dpy(i,j+3,k,n)*M8p(8,i,j,k) )
             end do
          end do
       end do

       do k=lo(3),hi(3)
          do j=slo(2),shi(2)+1
             do i=lo(1),hi(1)
!EXPAND                mmtmp8(1:8,i) = matmul(M8, q(i,j-4:j+3,k,qxn))
                mmtmp8(1,i) = M8(1,1) * q(i,j-4,k,qxn) &
                            + M8(1,2) * q(i,j-3,k,qxn) &
                            + M8(1,3) * q(i,j-2,k,qxn) &
                            + M8(1,4) * q(i,j-1,k,qxn) &
                            - M8(8,4) * q(i,j  ,k,qxn)
                mmtmp8(2,i) = M8(2,1) * q(i,j-4,k,qxn) &
                            + M8(2,2) * q(i,j-3,k,qxn) &
                            + M8(2,3) * q(i,j-2,k,qxn) &
                            + M8(2,4) * q(i,j-1,k,qxn) &
                            - M8(7,4) * q(i,j  ,k,qxn) &
                            - M8(7,3) * q(i,j+1,k,qxn)
                mmtmp8(3,i) = M8(3,1) * q(i,j-4,k,qxn) &
                            + M8(3,2) * q(i,j-3,k,qxn) &
                            + M8(3,3) * q(i,j-2,k,qxn) &
                            + M8(3,4) * q(i,j-1,k,qxn) &
                            - M8(6,4) * q(i,j  ,k,qxn) &
                            - M8(6,3) * q(i,j+1,k,qxn) &
                            - M8(6,2) * q(i,j+2,k,qxn)
                mmtmp8(4,i) = M8(4,1) * q(i,j-4,k,qxn) &
                            + M8(4,2) * q(i,j-3,k,qxn) &
                            + M8(4,3) * q(i,j-2,k,qxn) &
                            + M8(4,4) * q(i,j-1,k,qxn) &
                            - M8(5,4) * q(i,j  ,k,qxn) &
                            - M8(5,3) * q(i,j+1,k,qxn) &
                            - M8(5,2) * q(i,j+2,k,qxn) &
                            - M8(5,1) * q(i,j+3,k,qxn)
                mmtmp8(5,i) = M8(5,1) * q(i,j-4,k,qxn) &
                            + M8(5,2) * q(i,j-3,k,qxn) &
                            + M8(5,3) * q(i,j-2,k,qxn) &
                            + M8(5,4) * q(i,j-1,k,qxn) &
                            - M8(4,4) * q(i,j  ,k,qxn) &
                            - M8(4,3) * q(i,j+1,k,qxn) &
                            - M8(4,2) * q(i,j+2,k,qxn) &
                            - M8(4,1) * q(i,j+3,k,qxn)
                mmtmp8(6,i) = M8(6,2) * q(i,j-3,k,qxn) &
                            + M8(6,3) * q(i,j-2,k,qxn) &
                            + M8(6,4) * q(i,j-1,k,qxn) &
                            - M8(3,4) * q(i,j  ,k,qxn) &
                            - M8(3,3) * q(i,j+1,k,qxn) &
                            - M8(3,2) * q(i,j+2,k,qxn) &
                            - M8(3,1) * q(i,j+3,k,qxn)
                mmtmp8(7,i) = M8(7,3) * q(i,j-2,k,qxn) &
                            + M8(7,4) * q(i,j-1,k,qxn) &
                            - M8(2,4) * q(i,j  ,k,qxn) &
                            - M8(2,3) * q(i,j+1,k,qxn) &
                            - M8(2,2) * q(i,j+2,k,qxn) &
                            - M8(2,1) * q(i,j+3,k,qxn)
                mmtmp8(8,i) = M8(8,4) * q(i,j-1,k,qxn) &
                            - M8(1,4) * q(i,j  ,k,qxn) &
                            - M8(1,3) * q(i,j+1,k,qxn) &
                            - M8(1,2) * q(i,j+2,k,qxn) &
                            - M8(1,1) * q(i,j+3,k,qxn)
!EXPAND                Hg(i,j,k,iene) = Hg(i,j,k,iene) + dot_product(dxe(i,j-4:j+3,k,n), mmtmp8(1:8,i))
                Hg(i,j,k,iene) = Hg(i,j,k,iene)+ &
                   ( dxe(i,j-4,k,n)*mmtmp8(1,i) + dxe(i,j-3,k,n)*mmtmp8(2,i) &
                   + dxe(i,j-2,k,n)*mmtmp8(3,i) + dxe(i,j-1,k,n)*mmtmp8(4,i) &
                   + dxe(i,j  ,k,n)*mmtmp8(5,i) + dxe(i,j+1,k,n)*mmtmp8(6,i) &
                   + dxe(i,j+2,k,n)*mmtmp8(7,i) + dxe(i,j+3,k,n)*mmtmp8(8,i) )
!EXPAND                Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1) &
!EXPAND                     + dot_product(dxy(i,j-4:j+3,k,n), mmtmp8(1:8,i))
                Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1)+ &
                   ( dxy(i,j-4,k,n)*mmtmp8(1,i) + dxy(i,j-3,k,n)*mmtmp8(2,i) &
                   + dxy(i,j-2,k,n)*mmtmp8(3,i) + dxy(i,j-1,k,n)*mmtmp8(4,i) &
                   + dxy(i,j  ,k,n)*mmtmp8(5,i) + dxy(i,j+1,k,n)*mmtmp8(6,i) &
                   + dxy(i,j+2,k,n)*mmtmp8(7,i) + dxy(i,j+3,k,n)*mmtmp8(8,i) )
             end do
          end do
       end do

    end do
       
    if (.not.reset_N2) then
       ! correction
       Hry = 0.d0

       do n = 1, nspecies
          do k=lo(3),hi(3)
             do j=slo(2),shi(2)+1
                do i=lo(1),hi(1)
                   Hry(i,j,k) = Hry(i,j,k) + Hg(i,j,k,iry1+n-1)
                end do
             end do
          end do
       end do

       do n = 1, nspecies
          qyn = qy1+n-1
          qhn = qh1+n-1
          do k=lo(3),hi(3)
             do j=slo(2),shi(2)+1
                do i=lo(1),hi(1)
                   Yhalf = 0.5d0*(q(i,j-1,k,qyn) + q(i,j,k,qyn))
                   hhalf = 0.5d0*(q(i,j-1,k,qhn) + q(i,j,k,qhn))
                   Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1)- (Yhalf*Hry(i,j,k))
                   Hg(i,j,k,iene) = Hg(i,j,k,iene) - (Yhalf*Hry(i,j,k))*hhalf
                end do
             end do
          end do
       end do
    end if

    ! add y-direction rhs
    do n=2,ncons
       do k=lo(3),hi(3)
          do j=slo(2),shi(2)
             do i=lo(1),hi(1)
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hg(i,j+1,k,n) - Hg(i,j,k,n)) * dx2inv(2)
             end do
          end do
       end do
    end do

    ! ------- END y-direction -------

    ! ------- BEGIN z-direction -------

    do k=slo(3),shi(3)+1
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             mmtmp8(1:8,i) = matmul(mu(i,j,k-4:k+3), M8)
             mmtmp8(1,i) = mu(i,j,k-4) * M8(1,1) &
                         + mu(i,j,k-3) * M8(2,1) &
                         + mu(i,j,k-2) * M8(3,1) &
                         + mu(i,j,k-1) * M8(4,1) &
                         + mu(i,j,k  ) * M8(5,1)
             mmtmp8(2,i) = mu(i,j,k-4) * M8(1,2) &
                         + mu(i,j,k-3) * M8(2,2) &
                         + mu(i,j,k-2) * M8(3,2) &
                         + mu(i,j,k-1) * M8(4,2) &
                         + mu(i,j,k  ) * M8(5,2) &
                         + mu(i,j,k+1) * M8(6,2)
             mmtmp8(3,i) = mu(i,j,k-4) * M8(1,3) &
                         + mu(i,j,k-3) * M8(2,3) &
                         + mu(i,j,k-2) * M8(3,3) &
                         + mu(i,j,k-1) * M8(4,3) &
                         + mu(i,j,k  ) * M8(5,3) &
                         + mu(i,j,k+1) * M8(6,3) &
                         + mu(i,j,k+2) * M8(7,3)
             mmtmp8(4,i) = mu(i,j,k-4) * M8(1,4) &
                         + mu(i,j,k-3) * M8(2,4) &
                         + mu(i,j,k-2) * M8(3,4) &
                         + mu(i,j,k-1) * M8(4,4) &
                         + mu(i,j,k  ) * M8(5,4) &
                         + mu(i,j,k+1) * M8(6,4) &
                         + mu(i,j,k+2) * M8(7,4) &
                         + mu(i,j,k+3) * M8(8,4)
             mmtmp8(5,i) =-mu(i,j,k-4) * M8(8,4) &
                         - mu(i,j,k-3) * M8(7,4) &
                         - mu(i,j,k-2) * M8(6,4) &
                         - mu(i,j,k-1) * M8(5,4) &
                         - mu(i,j,k  ) * M8(4,4) &
                         - mu(i,j,k+1) * M8(3,4) &
                         - mu(i,j,k+2) * M8(2,4) &
                         - mu(i,j,k+3) * M8(1,4)
             mmtmp8(6,i) =-mu(i,j,k-3) * M8(7,3) &
                         - mu(i,j,k-2) * M8(6,3) &
                         - mu(i,j,k-1) * M8(5,3) &
                         - mu(i,j,k  ) * M8(4,3) &
                         - mu(i,j,k+1) * M8(3,3) &
                         - mu(i,j,k+2) * M8(2,3) &
                         - mu(i,j,k+3) * M8(1,3)
             mmtmp8(7,i) =-mu(i,j,k-2) * M8(6,2) &
                         - mu(i,j,k-1) * M8(5,2) &
                         - mu(i,j,k  ) * M8(4,2) &
                         - mu(i,j,k+1) * M8(3,2) &
                         - mu(i,j,k+2) * M8(2,2) &
                         - mu(i,j,k+3) * M8(1,2)
             mmtmp8(8,i) =-mu(i,j,k-1) * M8(5,1) &
                         - mu(i,j,k  ) * M8(4,1) &
                         - mu(i,j,k+1) * M8(3,1) &
                         - mu(i,j,k+2) * M8(2,1) &
                         - mu(i,j,k+3) * M8(1,1)
!EXPAND             Hg(i,j,k,imx) = dot_product(mmtmp8(1:8,i), q(i,j,k-4:k+3,qu))
             Hg(i,j,k,imx) =  &
                ( mmtmp8(1,i)*q(i,j,k-4,qu) + mmtmp8(2,i)*q(i,j,k-3,qu) &
                + mmtmp8(3,i)*q(i,j,k-2,qu) + mmtmp8(4,i)*q(i,j,k-1,qu) &
                + mmtmp8(5,i)*q(i,j,k  ,qu) + mmtmp8(6,i)*q(i,j,k+1,qu) &
                + mmtmp8(7,i)*q(i,j,k+2,qu) + mmtmp8(8,i)*q(i,j,k+3,qu) )
!EXPAND             Hg(i,j,k,imy) = dot_product(mmtmp8(1:8,i), q(i,j,k-4:k+3,qv))
             Hg(i,j,k,imy) =  &
                ( mmtmp8(1,i)*q(i,j,k-4,qv) + mmtmp8(2,i)*q(i,j,k-3,qv) &
                + mmtmp8(3,i)*q(i,j,k-2,qv) + mmtmp8(4,i)*q(i,j,k-1,qv) &
                + mmtmp8(5,i)*q(i,j,k  ,qv) + mmtmp8(6,i)*q(i,j,k+1,qv) &
                + mmtmp8(7,i)*q(i,j,k+2,qv) + mmtmp8(8,i)*q(i,j,k+3,qv) )
          end do
       end do
    end do

    do k=slo(3),shi(3)+1
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             mmtmp8(1:8,i) = matmul(vsp(i,j,k-4:k+3), M8)
             mmtmp8(1,i) = vsp(i,j,k-4) * M8(1,1) &
                         + vsp(i,j,k-3) * M8(2,1) &
                         + vsp(i,j,k-2) * M8(3,1) &
                         + vsp(i,j,k-1) * M8(4,1) &
                         + vsp(i,j,k  ) * M8(5,1)
             mmtmp8(2,i) = vsp(i,j,k-4) * M8(1,2) &
                         + vsp(i,j,k-3) * M8(2,2) &
                         + vsp(i,j,k-2) * M8(3,2) &
                         + vsp(i,j,k-1) * M8(4,2) &
                         + vsp(i,j,k  ) * M8(5,2) &
                         + vsp(i,j,k+1) * M8(6,2)
             mmtmp8(3,i) = vsp(i,j,k-4) * M8(1,3) &
                         + vsp(i,j,k-3) * M8(2,3) &
                         + vsp(i,j,k-2) * M8(3,3) &
                         + vsp(i,j,k-1) * M8(4,3) &
                         + vsp(i,j,k  ) * M8(5,3) &
                         + vsp(i,j,k+1) * M8(6,3) &
                         + vsp(i,j,k+2) * M8(7,3)
             mmtmp8(4,i) = vsp(i,j,k-4) * M8(1,4) &
                         + vsp(i,j,k-3) * M8(2,4) &
                         + vsp(i,j,k-2) * M8(3,4) &
                         + vsp(i,j,k-1) * M8(4,4) &
                         + vsp(i,j,k  ) * M8(5,4) &
                         + vsp(i,j,k+1) * M8(6,4) &
                         + vsp(i,j,k+2) * M8(7,4) &
                         + vsp(i,j,k+3) * M8(8,4)
             mmtmp8(5,i) =-vsp(i,j,k-4) * M8(8,4) &
                         - vsp(i,j,k-3) * M8(7,4) &
                         - vsp(i,j,k-2) * M8(6,4) &
                         - vsp(i,j,k-1) * M8(5,4) &
                         - vsp(i,j,k  ) * M8(4,4) &
                         - vsp(i,j,k+1) * M8(3,4) &
                         - vsp(i,j,k+2) * M8(2,4) &
                         - vsp(i,j,k+3) * M8(1,4)
             mmtmp8(6,i) =-vsp(i,j,k-3) * M8(7,3) &
                         - vsp(i,j,k-2) * M8(6,3) &
                         - vsp(i,j,k-1) * M8(5,3) &
                         - vsp(i,j,k  ) * M8(4,3) &
                         - vsp(i,j,k+1) * M8(3,3) &
                         - vsp(i,j,k+2) * M8(2,3) &
                         - vsp(i,j,k+3) * M8(1,3)
             mmtmp8(7,i) =-vsp(i,j,k-2) * M8(6,2) &
                         - vsp(i,j,k-1) * M8(5,2) &
                         - vsp(i,j,k  ) * M8(4,2) &
                         - vsp(i,j,k+1) * M8(3,2) &
                         - vsp(i,j,k+2) * M8(2,2) &
                         - vsp(i,j,k+3) * M8(1,2)
             mmtmp8(8,i) =-vsp(i,j,k-1) * M8(5,1) &
                         - vsp(i,j,k  ) * M8(4,1) &
                         - vsp(i,j,k+1) * M8(3,1) &
                         - vsp(i,j,k+2) * M8(2,1) &
                         - vsp(i,j,k+3) * M8(1,1)
!EXPAND             Hg(i,j,k,imz) = dot_product(mmtmp8(1:8,i), q(i,j,k-4:k+3,qw))
             Hg(i,j,k,imz) =  &
                ( mmtmp8(1,i)*q(i,j,k-4,qw) + mmtmp8(2,i)*q(i,j,k-3,qw) &
                + mmtmp8(3,i)*q(i,j,k-2,qw) + mmtmp8(4,i)*q(i,j,k-1,qw) &
                + mmtmp8(5,i)*q(i,j,k  ,qw) + mmtmp8(6,i)*q(i,j,k+1,qw) &
                + mmtmp8(7,i)*q(i,j,k+2,qw) + mmtmp8(8,i)*q(i,j,k+3,qw) )
          end do
       end do
    end do

    do k=slo(3),shi(3)+1
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             mmtmp8(1:8,i) = matmul(lam(i,j,k-4:k+3), M8)
             mmtmp8(1,i) = lam(i,j,k-4) * M8(1,1) &
                         + lam(i,j,k-3) * M8(2,1) &
                         + lam(i,j,k-2) * M8(3,1) &
                         + lam(i,j,k-1) * M8(4,1) &
                         + lam(i,j,k  ) * M8(5,1)
             mmtmp8(2,i) = lam(i,j,k-4) * M8(1,2) &
                         + lam(i,j,k-3) * M8(2,2) &
                         + lam(i,j,k-2) * M8(3,2) &
                         + lam(i,j,k-1) * M8(4,2) &
                         + lam(i,j,k  ) * M8(5,2) &
                         + lam(i,j,k+1) * M8(6,2)
             mmtmp8(3,i) = lam(i,j,k-4) * M8(1,3) &
                         + lam(i,j,k-3) * M8(2,3) &
                         + lam(i,j,k-2) * M8(3,3) &
                         + lam(i,j,k-1) * M8(4,3) &
                         + lam(i,j,k  ) * M8(5,3) &
                         + lam(i,j,k+1) * M8(6,3) &
                         + lam(i,j,k+2) * M8(7,3)
             mmtmp8(4,i) = lam(i,j,k-4) * M8(1,4) &
                         + lam(i,j,k-3) * M8(2,4) &
                         + lam(i,j,k-2) * M8(3,4) &
                         + lam(i,j,k-1) * M8(4,4) &
                         + lam(i,j,k  ) * M8(5,4) &
                         + lam(i,j,k+1) * M8(6,4) &
                         + lam(i,j,k+2) * M8(7,4) &
                         + lam(i,j,k+3) * M8(8,4)
             mmtmp8(5,i) =-lam(i,j,k-4) * M8(8,4) &
                         - lam(i,j,k-3) * M8(7,4) &
                         - lam(i,j,k-2) * M8(6,4) &
                         - lam(i,j,k-1) * M8(5,4) &
                         - lam(i,j,k  ) * M8(4,4) &
                         - lam(i,j,k+1) * M8(3,4) &
                         - lam(i,j,k+2) * M8(2,4) &
                         - lam(i,j,k+3) * M8(1,4)
             mmtmp8(6,i) =-lam(i,j,k-3) * M8(7,3) &
                         - lam(i,j,k-2) * M8(6,3) &
                         - lam(i,j,k-1) * M8(5,3) &
                         - lam(i,j,k  ) * M8(4,3) &
                         - lam(i,j,k+1) * M8(3,3) &
                         - lam(i,j,k+2) * M8(2,3) &
                         - lam(i,j,k+3) * M8(1,3)
             mmtmp8(7,i) =-lam(i,j,k-2) * M8(6,2) &
                         - lam(i,j,k-1) * M8(5,2) &
                         - lam(i,j,k  ) * M8(4,2) &
                         - lam(i,j,k+1) * M8(3,2) &
                         - lam(i,j,k+2) * M8(2,2) &
                         - lam(i,j,k+3) * M8(1,2)
             mmtmp8(8,i) =-lam(i,j,k-1) * M8(5,1) &
                         - lam(i,j,k  ) * M8(4,1) &
                         - lam(i,j,k+1) * M8(3,1) &
                         - lam(i,j,k+2) * M8(2,1) &
                         - lam(i,j,k+3) * M8(1,1)
!EXPAND             Hg(i,j,k,iene) = dot_product(mmtmp8(1:8,i), q(i,j,k-4:k+3,qtemp))
             Hg(i,j,k,iene) =  &
                ( mmtmp8(1,i)*q(i,j,k-4,qtemp) + mmtmp8(2,i)*q(i,j,k-3,qtemp) &
                + mmtmp8(3,i)*q(i,j,k-2,qtemp) + mmtmp8(4,i)*q(i,j,k-1,qtemp) &
                + mmtmp8(5,i)*q(i,j,k  ,qtemp) + mmtmp8(6,i)*q(i,j,k+1,qtemp) &
                + mmtmp8(7,i)*q(i,j,k+2,qtemp) + mmtmp8(8,i)*q(i,j,k+3,qtemp) )
          end do
       end do
    end do

    do k=slo(3),shi(3)+1
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
!EXPAND             mmtmp8(1:8,i) = matmul(M8, q(i,j,k-4:k+3,qpres))
             mmtmp8(1,i) = M8(1,1) * q(i,j,k-4,qpres) &
                         + M8(1,2) * q(i,j,k-3,qpres) &
                         + M8(1,3) * q(i,j,k-2,qpres) &
                         + M8(1,4) * q(i,j,k-1,qpres) &
                         - M8(8,4) * q(i,j,k  ,qpres)
             mmtmp8(2,i) = M8(2,1) * q(i,j,k-4,qpres) &
                         + M8(2,2) * q(i,j,k-3,qpres) &
                         + M8(2,3) * q(i,j,k-2,qpres) &
                         + M8(2,4) * q(i,j,k-1,qpres) &
                         - M8(7,4) * q(i,j,k  ,qpres) &
                         - M8(7,3) * q(i,j,k+1,qpres)
             mmtmp8(3,i) = M8(3,1) * q(i,j,k-4,qpres) &
                         + M8(3,2) * q(i,j,k-3,qpres) &
                         + M8(3,3) * q(i,j,k-2,qpres) &
                         + M8(3,4) * q(i,j,k-1,qpres) &
                         - M8(6,4) * q(i,j,k  ,qpres) &
                         - M8(6,3) * q(i,j,k+1,qpres) &
                         - M8(6,2) * q(i,j,k+2,qpres)
             mmtmp8(4,i) = M8(4,1) * q(i,j,k-4,qpres) &
                         + M8(4,2) * q(i,j,k-3,qpres) &
                         + M8(4,3) * q(i,j,k-2,qpres) &
                         + M8(4,4) * q(i,j,k-1,qpres) &
                         - M8(5,4) * q(i,j,k  ,qpres) &
                         - M8(5,3) * q(i,j,k+1,qpres) &
                         - M8(5,2) * q(i,j,k+2,qpres) &
                         - M8(5,1) * q(i,j,k+3,qpres)
             mmtmp8(5,i) = M8(5,1) * q(i,j,k-4,qpres) &
                         + M8(5,2) * q(i,j,k-3,qpres) &
                         + M8(5,3) * q(i,j,k-2,qpres) &
                         + M8(5,4) * q(i,j,k-1,qpres) &
                         - M8(4,4) * q(i,j,k  ,qpres) &
                         - M8(4,3) * q(i,j,k+1,qpres) &
                         - M8(4,2) * q(i,j,k+2,qpres) &
                         - M8(4,1) * q(i,j,k+3,qpres)
             mmtmp8(6,i) = M8(6,2) * q(i,j,k-3,qpres) &
                         + M8(6,3) * q(i,j,k-2,qpres) &
                         + M8(6,4) * q(i,j,k-1,qpres) &
                         - M8(3,4) * q(i,j,k  ,qpres) &
                         - M8(3,3) * q(i,j,k+1,qpres) &
                         - M8(3,2) * q(i,j,k+2,qpres) &
                         - M8(3,1) * q(i,j,k+3,qpres)
             mmtmp8(7,i) = M8(7,3) * q(i,j,k-2,qpres) &
                         + M8(7,4) * q(i,j,k-1,qpres) &
                         - M8(2,4) * q(i,j,k  ,qpres) &
                         - M8(2,3) * q(i,j,k+1,qpres) &
                         - M8(2,2) * q(i,j,k+2,qpres) &
                         - M8(2,1) * q(i,j,k+3,qpres)
             mmtmp8(8,i) = M8(8,4) * q(i,j,k-1,qpres) &
                         - M8(1,4) * q(i,j,k  ,qpres) &
                         - M8(1,3) * q(i,j,k+1,qpres) &
                         - M8(1,2) * q(i,j,k+2,qpres) &
                         - M8(1,1) * q(i,j,k+3,qpres)
!EXPAND             Hg(i,j,k,iene) = Hg(i,j,k,iene) + dot_product(dpe(i,j,k-4:k+3), mmtmp8(1:8,i))
             Hg(i,j,k,iene) = Hg(i,j,k,iene)+ &
                ( dpe(i,j,k-4)*mmtmp8(1,i) + dpe(i,j,k-3)*mmtmp8(2,i) &
                + dpe(i,j,k-2)*mmtmp8(3,i) + dpe(i,j,k-1)*mmtmp8(4,i) &
                + dpe(i,j,k  )*mmtmp8(5,i) + dpe(i,j,k+1)*mmtmp8(6,i) &
                + dpe(i,j,k+2)*mmtmp8(7,i) + dpe(i,j,k+3)*mmtmp8(8,i) )
          end do
          do i=lo(1),hi(1)
             M8p(:,i,j,k) = mmtmp8(1:8,i)
          end do
       end do
    end do

    do n = 1, nspecies
       qxn = qx1+n-1

       do k=slo(3),shi(3)+1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
!EXPAND                Hg(i,j,k,iry1+n-1) = dot_product(dpy(i,j,k-4:k+3,n), M8p(:,i,j,k))
                Hg(i,j,k,iry1+n-1) =  &
                   ( dpy(i,j,k-4,n)*M8p(1,i,j,k) + dpy(i,j,k-3,n)*M8p(2,i,j,k) &
                   + dpy(i,j,k-2,n)*M8p(3,i,j,k) + dpy(i,j,k-1,n)*M8p(4,i,j,k) &
                   + dpy(i,j,k  ,n)*M8p(5,i,j,k) + dpy(i,j,k+1,n)*M8p(6,i,j,k) &
                   + dpy(i,j,k+2,n)*M8p(7,i,j,k) + dpy(i,j,k+3,n)*M8p(8,i,j,k) )
             end do
          end do
       end do

       do k=slo(3),shi(3)+1
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
!EXPAND                mmtmp8(1:8,i) = matmul(M8, q(i,j,k-4:k+3,qxn))
                mmtmp8(1,i) = M8(1,1) * q(i,j,k-4,qxn) &
                            + M8(1,2) * q(i,j,k-3,qxn) &
                            + M8(1,3) * q(i,j,k-2,qxn) &
                            + M8(1,4) * q(i,j,k-1,qxn) &
                            - M8(8,4) * q(i,j,k  ,qxn)
                mmtmp8(2,i) = M8(2,1) * q(i,j,k-4,qxn) &
                            + M8(2,2) * q(i,j,k-3,qxn) &
                            + M8(2,3) * q(i,j,k-2,qxn) &
                            + M8(2,4) * q(i,j,k-1,qxn) &
                            - M8(7,4) * q(i,j,k  ,qxn) &
                            - M8(7,3) * q(i,j,k+1,qxn)
                mmtmp8(3,i) = M8(3,1) * q(i,j,k-4,qxn) &
                            + M8(3,2) * q(i,j,k-3,qxn) &
                            + M8(3,3) * q(i,j,k-2,qxn) &
                            + M8(3,4) * q(i,j,k-1,qxn) &
                            - M8(6,4) * q(i,j,k  ,qxn) &
                            - M8(6,3) * q(i,j,k+1,qxn) &
                            - M8(6,2) * q(i,j,k+2,qxn)
                mmtmp8(4,i) = M8(4,1) * q(i,j,k-4,qxn) &
                            + M8(4,2) * q(i,j,k-3,qxn) &
                            + M8(4,3) * q(i,j,k-2,qxn) &
                            + M8(4,4) * q(i,j,k-1,qxn) &
                            - M8(5,4) * q(i,j,k  ,qxn) &
                            - M8(5,3) * q(i,j,k+1,qxn) &
                            - M8(5,2) * q(i,j,k+2,qxn) &
                            - M8(5,1) * q(i,j,k+3,qxn)
                mmtmp8(5,i) = M8(5,1) * q(i,j,k-4,qxn) &
                            + M8(5,2) * q(i,j,k-3,qxn) &
                            + M8(5,3) * q(i,j,k-2,qxn) &
                            + M8(5,4) * q(i,j,k-1,qxn) &
                            - M8(4,4) * q(i,j,k  ,qxn) &
                            - M8(4,3) * q(i,j,k+1,qxn) &
                            - M8(4,2) * q(i,j,k+2,qxn) &
                            - M8(4,1) * q(i,j,k+3,qxn)
                mmtmp8(6,i) = M8(6,2) * q(i,j,k-3,qxn) &
                            + M8(6,3) * q(i,j,k-2,qxn) &
                            + M8(6,4) * q(i,j,k-1,qxn) &
                            - M8(3,4) * q(i,j,k  ,qxn) &
                            - M8(3,3) * q(i,j,k+1,qxn) &
                            - M8(3,2) * q(i,j,k+2,qxn) &
                            - M8(3,1) * q(i,j,k+3,qxn)
                mmtmp8(7,i) = M8(7,3) * q(i,j,k-2,qxn) &
                            + M8(7,4) * q(i,j,k-1,qxn) &
                            - M8(2,4) * q(i,j,k  ,qxn) &
                            - M8(2,3) * q(i,j,k+1,qxn) &
                            - M8(2,2) * q(i,j,k+2,qxn) &
                            - M8(2,1) * q(i,j,k+3,qxn)
                mmtmp8(8,i) = M8(8,4) * q(i,j,k-1,qxn) &
                            - M8(1,4) * q(i,j,k  ,qxn) &
                            - M8(1,3) * q(i,j,k+1,qxn) &
                            - M8(1,2) * q(i,j,k+2,qxn) &
                            - M8(1,1) * q(i,j,k+3,qxn)
!EXPAND                Hg(i,j,k,iene) = Hg(i,j,k,iene) + dot_product(dxe(i,j,k-4:k+3,n), mmtmp8(1:8,i))
                Hg(i,j,k,iene) = Hg(i,j,k,iene)+ &
                   ( dxe(i,j,k-4,n)*mmtmp8(1,i) + dxe(i,j,k-3,n)*mmtmp8(2,i) &
                   + dxe(i,j,k-2,n)*mmtmp8(3,i) + dxe(i,j,k-1,n)*mmtmp8(4,i) &
                   + dxe(i,j,k  ,n)*mmtmp8(5,i) + dxe(i,j,k+1,n)*mmtmp8(6,i) &
                   + dxe(i,j,k+2,n)*mmtmp8(7,i) + dxe(i,j,k+3,n)*mmtmp8(8,i) )
!EXPAND                Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1) &
!EXPAND                     + dot_product(dxy(i,j,k-4:k+3,n), mmtmp8(1:8,i))
                Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1)+ &
                   ( dxy(i,j,k-4,n)*mmtmp8(1,i) + dxy(i,j,k-3,n)*mmtmp8(2,i) &
                   + dxy(i,j,k-2,n)*mmtmp8(3,i) + dxy(i,j,k-1,n)*mmtmp8(4,i) &
                   + dxy(i,j,k  ,n)*mmtmp8(5,i) + dxy(i,j,k+1,n)*mmtmp8(6,i) &
                   + dxy(i,j,k+2,n)*mmtmp8(7,i) + dxy(i,j,k+3,n)*mmtmp8(8,i) )
             end do
          end do
       end do
    end do

    if (.not.reset_N2) then
       ! correction
       Hry = 0.d0

       do n = 1, nspecies
          do k=slo(3),shi(3)+1
             do j=lo(2),hi(2)
                do i=lo(1),hi(1)
                   Hry(i,j,k) = Hry(i,j,k) + Hg(i,j,k,iry1+n-1)
                end do
             end do
          end do
       end do

       do n = 1, nspecies
          qyn = qy1+n-1
          qhn = qh1+n-1
          do k=slo(3),shi(3)+1
             do j=lo(2),hi(2)
                do i=lo(1),hi(1)
                   Yhalf = 0.5d0*(q(i,j,k-1,qyn) + q(i,j,k,qyn))
                   hhalf = 0.5d0*(q(i,j,k-1,qhn) + q(i,j,k,qhn))
                   Hg(i,j,k,iry1+n-1) = Hg(i,j,k,iry1+n-1)- (Yhalf*Hry(i,j,k))
                   Hg(i,j,k,iene) = Hg(i,j,k,iene) - (Yhalf*Hry(i,j,k))*hhalf
                end do
             end do
          end do
       end do
    end if
    
    ! add z-direction rhs
    do n=2,ncons
       do k=slo(3),shi(3)
          do j=lo(2),hi(2)
             do i=lo(1),hi(1)
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hg(i,j,k+1,n) - Hg(i,j,k,n)) * dx2inv(3)
             end do
          end do
       end do
    end do
    
    ! ------- END z-direction -------

    !
    ! lo-x boundary
    !
    if (physbclo(1)) then
       do k=lo(3),hi(3)
          do j=lo(2),hi(2)
             i = lo(1)
             ! use completely right-biased stencil
             mmtmpB = matmul(vsp(i:i+3,j,k), BRB)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx)+finlo(1)*dx2inv(1)*dot_product(mmtmpB,q(i:i+3,j,k,qu))
             rhs(i,j,k,imx) = rhs(i,j,k,imx)+finlo(1)*dx2inv(1)* &
                ( q(i  ,j,k,qu)*mmtmpB(1) + q(i+1,j,k,qu)*mmtmpB(2) &
                + q(i+2,j,k,qu)*mmtmpB(3) + q(i+3,j,k,qu)*mmtmpB(4) )

             mmtmpB = matmul(mu(i:i+3,j,k), BRB)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy)+foulo(1)*dx2inv(1)*dot_product(mmtmpB,q(i:i+3,j,k,qv))
             rhs(i,j,k,imy) = rhs(i,j,k,imy)+foulo(1)*dx2inv(1)* &
                ( q(i  ,j,k,qv)*mmtmpB(1) + q(i+1,j,k,qv)*mmtmpB(2) &
                + q(i+2,j,k,qv)*mmtmpB(3) + q(i+3,j,k,qv)*mmtmpB(4) )
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz)+foulo(1)*dx2inv(1)*dot_product(mmtmpB,q(i:i+3,j,k,qw))
             rhs(i,j,k,imz) = rhs(i,j,k,imz)+foulo(1)*dx2inv(1)* &
                ( q(i  ,j,k,qw)*mmtmpB(1) + q(i+1,j,k,qw)*mmtmpB(2) &
                + q(i+2,j,k,qw)*mmtmpB(3) + q(i+3,j,k,qw)*mmtmpB(4) )

             mmtmpB = matmul(lam(i:i+3,j,k), BRB)
             BBp = matmul(BRB, q(i:i+3,j,k,qpres))
!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) + foulo(1)*dx2inv(1) * &
!EXPAND                  ( dot_product(mmtmpB, q(i:i+3,j,k,qtemp)) &
!EXPAND                  + dot_product(      dpe(i:i+3,j,k), BBp) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene)+foulo(1)*dx2inv(1)* &
                ( ( q(i  ,j,k,qtemp)*mmtmpB(1) + q(i+1,j,k,qtemp)*mmtmpB(2) &
                  + q(i+2,j,k,qtemp)*mmtmpB(3) + q(i+3,j,k,qtemp)*mmtmpB(4) ) &
                + ( dpe(i  ,j,k)*BBp(1) + dpe(i+1,j,k)*BBp(2) &
                  + dpe(i+2,j,k)*BBp(3) + dpe(i+3,j,k)*BBp(4) ) )
             
             rhstot = 0.d0
             rhsene = 0.d0
             do n = 1, nspecies
                qxn = qx1+n-1
                qyn = qy1+n-1
                
                BBX = matmul(BRB, q(i:i+3,j,k,qxn))
                
!EXPAND                rhstmp(n) = dot_product(dpy(i:i+3,j,k,n), BBp) &
!EXPAND                     +      dot_product(dxy(i:i+3,j,k,n), BBX)
                rhstmp(n) =  &
                   ( ( dpy(i  ,j,k,n)*BBp(1) + dpy(i+1,j,k,n)*BBp(2) &
                     + dpy(i+2,j,k,n)*BBp(3) + dpy(i+3,j,k,n)*BBp(4) ) &
                   + ( dxy(i  ,j,k,n)*BBX(1) + dxy(i+1,j,k,n)*BBX(2) &
                     + dxy(i+2,j,k,n)*BBX(3) + dxy(i+3,j,k,n)*BBX(4) ) )
                
!EXPAND                rhsene = rhsene &
!EXPAND                     +      dot_product(dxe(i:i+3,j,k,n), BBX)
                rhsene = rhsene+ &
                   ( dxe(i  ,j,k,n)*BBX(1) + dxe(i+1,j,k,n)*BBX(2) &
                   + dxe(i+2,j,k,n)*BBX(3) + dxe(i+3,j,k,n)*BBX(4) )
                
                rhstot = rhstot + rhstmp(n)
                Ytmp(n) = q(i,j,k,qyn)
             end do
             
             do n = 1, nspecies
                rhs(i,j,k,iry1+n-1) =  rhs(i,j,k,iry1+n-1) + &
                     foulo(1)*dx2inv(1) * (rhstmp(n) - Ytmp(n)*rhstot)
             end do
             
             do n = 1, nspecies
                qhn = qh1+n-1
                rhsene = rhsene - Ytmp(n) * q(i,j,k,qhn) * rhstot
             end do
             rhs(i,j,k,iene) = rhs(i,j,k,iene) + foulo(1)*dx2inv(1) * rhsene


             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
             ! use 2nd-order stencil for cell lo(1)+1,j,k
             do iface=0,1 
                i = lo(1)+1 + iface

                mmtmp2 = matmul(vsp(i-1:i,j,k), M2)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp2, q(i-1:i,j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i-1,j,k,qu)*mmtmp2(1) + q(i  ,j,k,qu)*mmtmp2(2) )

                mmtmp2 = matmul(mu(i-1:i,j,k), M2)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp2, q(i-1:i,j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i-1,j,k,qv)*mmtmp2(1) + q(i  ,j,k,qv)*mmtmp2(2) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp2, q(i-1:i,j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i-1,j,k,qw)*mmtmp2(1) + q(i  ,j,k,qw)*mmtmp2(2) )

                mmtmp2 = matmul(lam(i-1:i,j,k), M2)
                M2p = matmul(M2,  q(i-1:i,j,k,qpres))
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp2, q(i-1:i,j,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i-1:i,j,k), M2p)
                Hcell(iface,iene) =  &
                   ( ( q(i-1,j,k,qtemp)*mmtmp2(1) + q(i  ,j,k,qtemp)*mmtmp2(2) ) &
                   + ( dpe(i-1,j,k)*M2p(1) + dpe(i  ,j,k)*M2p(2) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

                   M2X = matmul(M2, q(i-1:i,j,k,qxn))
                
!EXPAND                   Htmp(n) = dot_product(dpy(i-1:i,j,k,n), M2p) &
!EXPAND                        +    dot_product(dxy(i-1:i,j,k,n), M2X)
                   Htmp(n) =  &
                      ( ( dpy(i-1,j,k,n)*M2p(1) + dpy(i  ,j,k,n)*M2p(2) ) &
                      + ( dxy(i-1,j,k,n)*M2X(1) + dxy(i  ,j,k,n)*M2X(2) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i-1:i,j,k,n), M2X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i-1,j,k,n)*M2X(1) + dxe(i  ,j,k,n)*M2X(2) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i-1,j,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i-1,j,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf 
                end do
             end do

             i = lo(1)+1
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(1)
             end do

             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
             ! use 4th-order stencil for cell lo(1)+2,j,k
             do iface=0,1 
                i = lo(1)+2 + iface

!EXPAND                mmtmp4 = matmul(vsp(i-2:i+1,j,k), M4)
                mmtmp4(1) = vsp(i-2,j,k) * M4(1,1) &
                          + vsp(i-1,j,k) * M4(2,1) &
                          + vsp(i  ,j,k) * M4(3,1)
                mmtmp4(2) = vsp(i-2,j,k) * M4(1,2) &
                          + vsp(i-1,j,k) * M4(2,2) &
                          + vsp(i  ,j,k) * M4(3,2) &
                          + vsp(i+1,j,k) * M4(4,2)
                mmtmp4(3) =-vsp(i-2,j,k) * M4(4,2) &
                          - vsp(i-1,j,k) * M4(3,2) &
                          - vsp(i  ,j,k) * M4(2,2) &
                          - vsp(i+1,j,k) * M4(1,2)
                mmtmp4(4) =-vsp(i-1,j,k) * M4(3,1) &
                          - vsp(i  ,j,k) * M4(2,1) &
                          - vsp(i+1,j,k) * M4(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp4, q(i-2:i+1,j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i-2,j,k,qu)*mmtmp4(1) + q(i-1,j,k,qu)*mmtmp4(2) &
                   + q(i  ,j,k,qu)*mmtmp4(3) + q(i+1,j,k,qu)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(mu(i-2:i+1,j,k), M4)
                mmtmp4(1) = mu(i-2,j,k) * M4(1,1) &
                          + mu(i-1,j,k) * M4(2,1) &
                          + mu(i  ,j,k) * M4(3,1)
                mmtmp4(2) = mu(i-2,j,k) * M4(1,2) &
                          + mu(i-1,j,k) * M4(2,2) &
                          + mu(i  ,j,k) * M4(3,2) &
                          + mu(i+1,j,k) * M4(4,2)
                mmtmp4(3) =-mu(i-2,j,k) * M4(4,2) &
                          - mu(i-1,j,k) * M4(3,2) &
                          - mu(i  ,j,k) * M4(2,2) &
                          - mu(i+1,j,k) * M4(1,2)
                mmtmp4(4) =-mu(i-1,j,k) * M4(3,1) &
                          - mu(i  ,j,k) * M4(2,1) &
                          - mu(i+1,j,k) * M4(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp4, q(i-2:i+1,j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i-2,j,k,qv)*mmtmp4(1) + q(i-1,j,k,qv)*mmtmp4(2) &
                   + q(i  ,j,k,qv)*mmtmp4(3) + q(i+1,j,k,qv)*mmtmp4(4) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp4, q(i-2:i+1,j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i-2,j,k,qw)*mmtmp4(1) + q(i-1,j,k,qw)*mmtmp4(2) &
                   + q(i  ,j,k,qw)*mmtmp4(3) + q(i+1,j,k,qw)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(lam(i-2:i+1,j,k), M4)
                mmtmp4(1) = lam(i-2,j,k) * M4(1,1) &
                          + lam(i-1,j,k) * M4(2,1) &
                          + lam(i  ,j,k) * M4(3,1)
                mmtmp4(2) = lam(i-2,j,k) * M4(1,2) &
                          + lam(i-1,j,k) * M4(2,2) &
                          + lam(i  ,j,k) * M4(3,2) &
                          + lam(i+1,j,k) * M4(4,2)
                mmtmp4(3) =-lam(i-2,j,k) * M4(4,2) &
                          - lam(i-1,j,k) * M4(3,2) &
                          - lam(i  ,j,k) * M4(2,2) &
                          - lam(i+1,j,k) * M4(1,2)
                mmtmp4(4) =-lam(i-1,j,k) * M4(3,1) &
                          - lam(i  ,j,k) * M4(2,1) &
                          - lam(i+1,j,k) * M4(1,1)
!EXPAND                M4p = matmul(M4,  q(i-2:i+1,j,k,qpres))
                M4p(1) = M4(1,1) * q(i-2,j,k,qpres) &
                       + M4(1,2) * q(i-1,j,k,qpres) &
                       - M4(4,2) * q(i  ,j,k,qpres)
                M4p(2) = M4(2,1) * q(i-2,j,k,qpres) &
                       + M4(2,2) * q(i-1,j,k,qpres) &
                       - M4(3,2) * q(i  ,j,k,qpres) &
                       - M4(3,1) * q(i+1,j,k,qpres)
                M4p(3) = M4(3,1) * q(i-2,j,k,qpres) &
                       + M4(3,2) * q(i-1,j,k,qpres) &
                       - M4(2,2) * q(i  ,j,k,qpres) &
                       - M4(2,1) * q(i+1,j,k,qpres)
                M4p(4) = M4(4,2) * q(i-1,j,k,qpres) &
                       - M4(1,2) * q(i  ,j,k,qpres) &
                       - M4(1,1) * q(i+1,j,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp4, q(i-2:i+1,j,k,qtemp))      &
!EXPAND                     &            + dot_product(      dpe(i-2:i+1,j,k), M4p)
                Hcell(iface,iene) =  &
                   ( ( q(i-2,j,k,qtemp)*mmtmp4(1) + q(i-1,j,k,qtemp)*mmtmp4(2) &
                     + q(i  ,j,k,qtemp)*mmtmp4(3) + q(i+1,j,k,qtemp)*mmtmp4(4) ) &
                   + ( dpe(i-2,j,k)*M4p(1) + dpe(i-1,j,k)*M4p(2) &
                     + dpe(i  ,j,k)*M4p(3) + dpe(i+1,j,k)*M4p(4) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M4X = matmul(M4, q(i-2:i+1,j,k,qxn))
                   M4X(1) = M4(1,1) * q(i-2,j,k,qxn) &
                          + M4(1,2) * q(i-1,j,k,qxn) &
                          - M4(4,2) * q(i  ,j,k,qxn)
                   M4X(2) = M4(2,1) * q(i-2,j,k,qxn) &
                          + M4(2,2) * q(i-1,j,k,qxn) &
                          - M4(3,2) * q(i  ,j,k,qxn) &
                          - M4(3,1) * q(i+1,j,k,qxn)
                   M4X(3) = M4(3,1) * q(i-2,j,k,qxn) &
                          + M4(3,2) * q(i-1,j,k,qxn) &
                          - M4(2,2) * q(i  ,j,k,qxn) &
                          - M4(2,1) * q(i+1,j,k,qxn)
                   M4X(4) = M4(4,2) * q(i-1,j,k,qxn) &
                          - M4(1,2) * q(i  ,j,k,qxn) &
                          - M4(1,1) * q(i+1,j,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i-2:i+1,j,k,n), M4p) &
!EXPAND                        +    dot_product(dxy(i-2:i+1,j,k,n), M4X)
                   Htmp(n) =  &
                      ( ( dpy(i-2,j,k,n)*M4p(1) + dpy(i-1,j,k,n)*M4p(2) &
                        + dpy(i  ,j,k,n)*M4p(3) + dpy(i+1,j,k,n)*M4p(4) ) &
                      + ( dxy(i-2,j,k,n)*M4X(1) + dxy(i-1,j,k,n)*M4X(2) &
                        + dxy(i  ,j,k,n)*M4X(3) + dxy(i+1,j,k,n)*M4X(4) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i-2:i+1,j,k,n), M4X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i-2,j,k,n)*M4X(1) + dxe(i-1,j,k,n)*M4X(2) &
                      + dxe(i  ,j,k,n)*M4X(3) + dxe(i+1,j,k,n)*M4X(4) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i-1,j,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i-1,j,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             i = lo(1)+2
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(1)
             end do

             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
             ! use 6th-order stencil for cell lo(1)+3,j,k
             do iface=0,1 
                i = lo(1)+3 + iface

!EXPAND                mmtmp6 = matmul(vsp(i-3:i+2,j,k), M6)
                mmtmp6(1) = vsp(i-3,j,k) * M6(1,1) &
                          + vsp(i-2,j,k) * M6(2,1) &
                          + vsp(i-1,j,k) * M6(3,1) &
                          + vsp(i  ,j,k) * M6(4,1)
                mmtmp6(2) = vsp(i-3,j,k) * M6(1,2) &
                          + vsp(i-2,j,k) * M6(2,2) &
                          + vsp(i-1,j,k) * M6(3,2) &
                          + vsp(i  ,j,k) * M6(4,2) &
                          + vsp(i+1,j,k) * M6(5,2)
                mmtmp6(3) = vsp(i-3,j,k) * M6(1,3) &
                          + vsp(i-2,j,k) * M6(2,3) &
                          + vsp(i-1,j,k) * M6(3,3) &
                          + vsp(i  ,j,k) * M6(4,3) &
                          + vsp(i+1,j,k) * M6(5,3) &
                          + vsp(i+2,j,k) * M6(6,3)
                mmtmp6(4) =-vsp(i-3,j,k) * M6(6,3) &
                          - vsp(i-2,j,k) * M6(5,3) &
                          - vsp(i-1,j,k) * M6(4,3) &
                          - vsp(i  ,j,k) * M6(3,3) &
                          - vsp(i+1,j,k) * M6(2,3) &
                          - vsp(i+2,j,k) * M6(1,3)
                mmtmp6(5) =-vsp(i-2,j,k) * M6(5,2) &
                          - vsp(i-1,j,k) * M6(4,2) &
                          - vsp(i  ,j,k) * M6(3,2) &
                          - vsp(i+1,j,k) * M6(2,2) &
                          - vsp(i+2,j,k) * M6(1,2)
                mmtmp6(6) =-vsp(i-1,j,k) * M6(4,1) &
                          - vsp(i  ,j,k) * M6(3,1) &
                          - vsp(i+1,j,k) * M6(2,1) &
                          - vsp(i+2,j,k) * M6(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp6, q(i-3:i+2,j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i-3,j,k,qu)*mmtmp6(1) + q(i-2,j,k,qu)*mmtmp6(2) &
                   + q(i-1,j,k,qu)*mmtmp6(3) + q(i  ,j,k,qu)*mmtmp6(4) &
                   + q(i+1,j,k,qu)*mmtmp6(5) + q(i+2,j,k,qu)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(mu(i-3:i+2,j,k), M6)
                mmtmp6(1) = mu(i-3,j,k) * M6(1,1) &
                          + mu(i-2,j,k) * M6(2,1) &
                          + mu(i-1,j,k) * M6(3,1) &
                          + mu(i  ,j,k) * M6(4,1)
                mmtmp6(2) = mu(i-3,j,k) * M6(1,2) &
                          + mu(i-2,j,k) * M6(2,2) &
                          + mu(i-1,j,k) * M6(3,2) &
                          + mu(i  ,j,k) * M6(4,2) &
                          + mu(i+1,j,k) * M6(5,2)
                mmtmp6(3) = mu(i-3,j,k) * M6(1,3) &
                          + mu(i-2,j,k) * M6(2,3) &
                          + mu(i-1,j,k) * M6(3,3) &
                          + mu(i  ,j,k) * M6(4,3) &
                          + mu(i+1,j,k) * M6(5,3) &
                          + mu(i+2,j,k) * M6(6,3)
                mmtmp6(4) =-mu(i-3,j,k) * M6(6,3) &
                          - mu(i-2,j,k) * M6(5,3) &
                          - mu(i-1,j,k) * M6(4,3) &
                          - mu(i  ,j,k) * M6(3,3) &
                          - mu(i+1,j,k) * M6(2,3) &
                          - mu(i+2,j,k) * M6(1,3)
                mmtmp6(5) =-mu(i-2,j,k) * M6(5,2) &
                          - mu(i-1,j,k) * M6(4,2) &
                          - mu(i  ,j,k) * M6(3,2) &
                          - mu(i+1,j,k) * M6(2,2) &
                          - mu(i+2,j,k) * M6(1,2)
                mmtmp6(6) =-mu(i-1,j,k) * M6(4,1) &
                          - mu(i  ,j,k) * M6(3,1) &
                          - mu(i+1,j,k) * M6(2,1) &
                          - mu(i+2,j,k) * M6(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp6, q(i-3:i+2,j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i-3,j,k,qv)*mmtmp6(1) + q(i-2,j,k,qv)*mmtmp6(2) &
                   + q(i-1,j,k,qv)*mmtmp6(3) + q(i  ,j,k,qv)*mmtmp6(4) &
                   + q(i+1,j,k,qv)*mmtmp6(5) + q(i+2,j,k,qv)*mmtmp6(6) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp6, q(i-3:i+2,j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i-3,j,k,qw)*mmtmp6(1) + q(i-2,j,k,qw)*mmtmp6(2) &
                   + q(i-1,j,k,qw)*mmtmp6(3) + q(i  ,j,k,qw)*mmtmp6(4) &
                   + q(i+1,j,k,qw)*mmtmp6(5) + q(i+2,j,k,qw)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(lam(i-3:i+2,j,k), M6)
                mmtmp6(1) = lam(i-3,j,k) * M6(1,1) &
                          + lam(i-2,j,k) * M6(2,1) &
                          + lam(i-1,j,k) * M6(3,1) &
                          + lam(i  ,j,k) * M6(4,1)
                mmtmp6(2) = lam(i-3,j,k) * M6(1,2) &
                          + lam(i-2,j,k) * M6(2,2) &
                          + lam(i-1,j,k) * M6(3,2) &
                          + lam(i  ,j,k) * M6(4,2) &
                          + lam(i+1,j,k) * M6(5,2)
                mmtmp6(3) = lam(i-3,j,k) * M6(1,3) &
                          + lam(i-2,j,k) * M6(2,3) &
                          + lam(i-1,j,k) * M6(3,3) &
                          + lam(i  ,j,k) * M6(4,3) &
                          + lam(i+1,j,k) * M6(5,3) &
                          + lam(i+2,j,k) * M6(6,3)
                mmtmp6(4) =-lam(i-3,j,k) * M6(6,3) &
                          - lam(i-2,j,k) * M6(5,3) &
                          - lam(i-1,j,k) * M6(4,3) &
                          - lam(i  ,j,k) * M6(3,3) &
                          - lam(i+1,j,k) * M6(2,3) &
                          - lam(i+2,j,k) * M6(1,3)
                mmtmp6(5) =-lam(i-2,j,k) * M6(5,2) &
                          - lam(i-1,j,k) * M6(4,2) &
                          - lam(i  ,j,k) * M6(3,2) &
                          - lam(i+1,j,k) * M6(2,2) &
                          - lam(i+2,j,k) * M6(1,2)
                mmtmp6(6) =-lam(i-1,j,k) * M6(4,1) &
                          - lam(i  ,j,k) * M6(3,1) &
                          - lam(i+1,j,k) * M6(2,1) &
                          - lam(i+2,j,k) * M6(1,1)
!EXPAND                M6p = matmul(M6,  q(i-3:i+2,j,k,qpres))
                M6p(1) = M6(1,1) * q(i-3,j,k,qpres) &
                       + M6(1,2) * q(i-2,j,k,qpres) &
                       + M6(1,3) * q(i-1,j,k,qpres) &
                       - M6(6,3) * q(i  ,j,k,qpres)
                M6p(2) = M6(2,1) * q(i-3,j,k,qpres) &
                       + M6(2,2) * q(i-2,j,k,qpres) &
                       + M6(2,3) * q(i-1,j,k,qpres) &
                       - M6(5,3) * q(i  ,j,k,qpres) &
                       - M6(5,2) * q(i+1,j,k,qpres)
                M6p(3) = M6(3,1) * q(i-3,j,k,qpres) &
                       + M6(3,2) * q(i-2,j,k,qpres) &
                       + M6(3,3) * q(i-1,j,k,qpres) &
                       - M6(4,3) * q(i  ,j,k,qpres) &
                       - M6(4,2) * q(i+1,j,k,qpres) &
                       - M6(4,1) * q(i+2,j,k,qpres)
                M6p(4) = M6(4,1) * q(i-3,j,k,qpres) &
                       + M6(4,2) * q(i-2,j,k,qpres) &
                       + M6(4,3) * q(i-1,j,k,qpres) &
                       - M6(3,3) * q(i  ,j,k,qpres) &
                       - M6(3,2) * q(i+1,j,k,qpres) &
                       - M6(3,1) * q(i+2,j,k,qpres)
                M6p(5) = M6(5,2) * q(i-2,j,k,qpres) &
                       + M6(5,3) * q(i-1,j,k,qpres) &
                       - M6(2,3) * q(i  ,j,k,qpres) &
                       - M6(2,2) * q(i+1,j,k,qpres) &
                       - M6(2,1) * q(i+2,j,k,qpres)
                M6p(6) = M6(6,3) * q(i-1,j,k,qpres) &
                       - M6(1,3) * q(i  ,j,k,qpres) &
                       - M6(1,2) * q(i+1,j,k,qpres) &
                       - M6(1,1) * q(i+2,j,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp6, q(i-3:i+2,j,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i-3:i+2,j,k), M6p)
                Hcell(iface,iene) =  &
                   ( ( q(i-3,j,k,qtemp)*mmtmp6(1) + q(i-2,j,k,qtemp)*mmtmp6(2) &
                     + q(i-1,j,k,qtemp)*mmtmp6(3) + q(i  ,j,k,qtemp)*mmtmp6(4) &
                     + q(i+1,j,k,qtemp)*mmtmp6(5) + q(i+2,j,k,qtemp)*mmtmp6(6) ) &
                   + ( dpe(i-3,j,k)*M6p(1) + dpe(i-2,j,k)*M6p(2) &
                     + dpe(i-1,j,k)*M6p(3) + dpe(i  ,j,k)*M6p(4) &
                     + dpe(i+1,j,k)*M6p(5) + dpe(i+2,j,k)*M6p(6) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M6X = matmul(M6, q(i-3:i+2,j,k,qxn))
                   M6X(1) = M6(1,1) * q(i-3,j,k,qxn) &
                          + M6(1,2) * q(i-2,j,k,qxn) &
                          + M6(1,3) * q(i-1,j,k,qxn) &
                          - M6(6,3) * q(i  ,j,k,qxn)
                   M6X(2) = M6(2,1) * q(i-3,j,k,qxn) &
                          + M6(2,2) * q(i-2,j,k,qxn) &
                          + M6(2,3) * q(i-1,j,k,qxn) &
                          - M6(5,3) * q(i  ,j,k,qxn) &
                          - M6(5,2) * q(i+1,j,k,qxn)
                   M6X(3) = M6(3,1) * q(i-3,j,k,qxn) &
                          + M6(3,2) * q(i-2,j,k,qxn) &
                          + M6(3,3) * q(i-1,j,k,qxn) &
                          - M6(4,3) * q(i  ,j,k,qxn) &
                          - M6(4,2) * q(i+1,j,k,qxn) &
                          - M6(4,1) * q(i+2,j,k,qxn)
                   M6X(4) = M6(4,1) * q(i-3,j,k,qxn) &
                          + M6(4,2) * q(i-2,j,k,qxn) &
                          + M6(4,3) * q(i-1,j,k,qxn) &
                          - M6(3,3) * q(i  ,j,k,qxn) &
                          - M6(3,2) * q(i+1,j,k,qxn) &
                          - M6(3,1) * q(i+2,j,k,qxn)
                   M6X(5) = M6(5,2) * q(i-2,j,k,qxn) &
                          + M6(5,3) * q(i-1,j,k,qxn) &
                          - M6(2,3) * q(i  ,j,k,qxn) &
                          - M6(2,2) * q(i+1,j,k,qxn) &
                          - M6(2,1) * q(i+2,j,k,qxn)
                   M6X(6) = M6(6,3) * q(i-1,j,k,qxn) &
                          - M6(1,3) * q(i  ,j,k,qxn) &
                          - M6(1,2) * q(i+1,j,k,qxn) &
                          - M6(1,1) * q(i+2,j,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i-3:i+2,j,k,n), M6p) &
!EXPAND                        +    dot_product(dxy(i-3:i+2,j,k,n), M6X)
                   Htmp(n) =  &
                      ( ( dpy(i-3,j,k,n)*M6p(1) + dpy(i-2,j,k,n)*M6p(2) &
                        + dpy(i-1,j,k,n)*M6p(3) + dpy(i  ,j,k,n)*M6p(4) &
                        + dpy(i+1,j,k,n)*M6p(5) + dpy(i+2,j,k,n)*M6p(6) ) &
                      + ( dxy(i-3,j,k,n)*M6X(1) + dxy(i-2,j,k,n)*M6X(2) &
                        + dxy(i-1,j,k,n)*M6X(3) + dxy(i  ,j,k,n)*M6X(4) &
                        + dxy(i+1,j,k,n)*M6X(5) + dxy(i+2,j,k,n)*M6X(6) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i-3:i+2,j,k,n), M6X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i-3,j,k,n)*M6X(1) + dxe(i-2,j,k,n)*M6X(2) &
                      + dxe(i-1,j,k,n)*M6X(3) + dxe(i  ,j,k,n)*M6X(4) &
                      + dxe(i+1,j,k,n)*M6X(5) + dxe(i+2,j,k,n)*M6X(6) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i-1,j,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i-1,j,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf 
                end do
             end do

             i = lo(1)+3
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(1)
             end do
          end do
       end do
    end if

    !
    ! hi-x boundary
    !
    if (physbchi(1)) then
       do k=lo(3),hi(3)
          do j=lo(2),hi(2)
             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
             ! use 6th-order stencil for cell hi(1)-3,j,k
             do iface=0,1  ! two faces of 
                i = hi(1)-3 + iface

!EXPAND                mmtmp6 = matmul(vsp(i-3:i+2,j,k), M6)
                mmtmp6(1) = vsp(i-3,j,k) * M6(1,1) &
                          + vsp(i-2,j,k) * M6(2,1) &
                          + vsp(i-1,j,k) * M6(3,1) &
                          + vsp(i  ,j,k) * M6(4,1)
                mmtmp6(2) = vsp(i-3,j,k) * M6(1,2) &
                          + vsp(i-2,j,k) * M6(2,2) &
                          + vsp(i-1,j,k) * M6(3,2) &
                          + vsp(i  ,j,k) * M6(4,2) &
                          + vsp(i+1,j,k) * M6(5,2)
                mmtmp6(3) = vsp(i-3,j,k) * M6(1,3) &
                          + vsp(i-2,j,k) * M6(2,3) &
                          + vsp(i-1,j,k) * M6(3,3) &
                          + vsp(i  ,j,k) * M6(4,3) &
                          + vsp(i+1,j,k) * M6(5,3) &
                          + vsp(i+2,j,k) * M6(6,3)
                mmtmp6(4) =-vsp(i-3,j,k) * M6(6,3) &
                          - vsp(i-2,j,k) * M6(5,3) &
                          - vsp(i-1,j,k) * M6(4,3) &
                          - vsp(i  ,j,k) * M6(3,3) &
                          - vsp(i+1,j,k) * M6(2,3) &
                          - vsp(i+2,j,k) * M6(1,3)
                mmtmp6(5) =-vsp(i-2,j,k) * M6(5,2) &
                          - vsp(i-1,j,k) * M6(4,2) &
                          - vsp(i  ,j,k) * M6(3,2) &
                          - vsp(i+1,j,k) * M6(2,2) &
                          - vsp(i+2,j,k) * M6(1,2)
                mmtmp6(6) =-vsp(i-1,j,k) * M6(4,1) &
                          - vsp(i  ,j,k) * M6(3,1) &
                          - vsp(i+1,j,k) * M6(2,1) &
                          - vsp(i+2,j,k) * M6(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp6, q(i-3:i+2,j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i-3,j,k,qu)*mmtmp6(1) + q(i-2,j,k,qu)*mmtmp6(2) &
                   + q(i-1,j,k,qu)*mmtmp6(3) + q(i  ,j,k,qu)*mmtmp6(4) &
                   + q(i+1,j,k,qu)*mmtmp6(5) + q(i+2,j,k,qu)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(mu(i-3:i+2,j,k), M6)
                mmtmp6(1) = mu(i-3,j,k) * M6(1,1) &
                          + mu(i-2,j,k) * M6(2,1) &
                          + mu(i-1,j,k) * M6(3,1) &
                          + mu(i  ,j,k) * M6(4,1)
                mmtmp6(2) = mu(i-3,j,k) * M6(1,2) &
                          + mu(i-2,j,k) * M6(2,2) &
                          + mu(i-1,j,k) * M6(3,2) &
                          + mu(i  ,j,k) * M6(4,2) &
                          + mu(i+1,j,k) * M6(5,2)
                mmtmp6(3) = mu(i-3,j,k) * M6(1,3) &
                          + mu(i-2,j,k) * M6(2,3) &
                          + mu(i-1,j,k) * M6(3,3) &
                          + mu(i  ,j,k) * M6(4,3) &
                          + mu(i+1,j,k) * M6(5,3) &
                          + mu(i+2,j,k) * M6(6,3)
                mmtmp6(4) =-mu(i-3,j,k) * M6(6,3) &
                          - mu(i-2,j,k) * M6(5,3) &
                          - mu(i-1,j,k) * M6(4,3) &
                          - mu(i  ,j,k) * M6(3,3) &
                          - mu(i+1,j,k) * M6(2,3) &
                          - mu(i+2,j,k) * M6(1,3)
                mmtmp6(5) =-mu(i-2,j,k) * M6(5,2) &
                          - mu(i-1,j,k) * M6(4,2) &
                          - mu(i  ,j,k) * M6(3,2) &
                          - mu(i+1,j,k) * M6(2,2) &
                          - mu(i+2,j,k) * M6(1,2)
                mmtmp6(6) =-mu(i-1,j,k) * M6(4,1) &
                          - mu(i  ,j,k) * M6(3,1) &
                          - mu(i+1,j,k) * M6(2,1) &
                          - mu(i+2,j,k) * M6(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp6, q(i-3:i+2,j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i-3,j,k,qv)*mmtmp6(1) + q(i-2,j,k,qv)*mmtmp6(2) &
                   + q(i-1,j,k,qv)*mmtmp6(3) + q(i  ,j,k,qv)*mmtmp6(4) &
                   + q(i+1,j,k,qv)*mmtmp6(5) + q(i+2,j,k,qv)*mmtmp6(6) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp6, q(i-3:i+2,j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i-3,j,k,qw)*mmtmp6(1) + q(i-2,j,k,qw)*mmtmp6(2) &
                   + q(i-1,j,k,qw)*mmtmp6(3) + q(i  ,j,k,qw)*mmtmp6(4) &
                   + q(i+1,j,k,qw)*mmtmp6(5) + q(i+2,j,k,qw)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(lam(i-3:i+2,j,k), M6)
                mmtmp6(1) = lam(i-3,j,k) * M6(1,1) &
                          + lam(i-2,j,k) * M6(2,1) &
                          + lam(i-1,j,k) * M6(3,1) &
                          + lam(i  ,j,k) * M6(4,1)
                mmtmp6(2) = lam(i-3,j,k) * M6(1,2) &
                          + lam(i-2,j,k) * M6(2,2) &
                          + lam(i-1,j,k) * M6(3,2) &
                          + lam(i  ,j,k) * M6(4,2) &
                          + lam(i+1,j,k) * M6(5,2)
                mmtmp6(3) = lam(i-3,j,k) * M6(1,3) &
                          + lam(i-2,j,k) * M6(2,3) &
                          + lam(i-1,j,k) * M6(3,3) &
                          + lam(i  ,j,k) * M6(4,3) &
                          + lam(i+1,j,k) * M6(5,3) &
                          + lam(i+2,j,k) * M6(6,3)
                mmtmp6(4) =-lam(i-3,j,k) * M6(6,3) &
                          - lam(i-2,j,k) * M6(5,3) &
                          - lam(i-1,j,k) * M6(4,3) &
                          - lam(i  ,j,k) * M6(3,3) &
                          - lam(i+1,j,k) * M6(2,3) &
                          - lam(i+2,j,k) * M6(1,3)
                mmtmp6(5) =-lam(i-2,j,k) * M6(5,2) &
                          - lam(i-1,j,k) * M6(4,2) &
                          - lam(i  ,j,k) * M6(3,2) &
                          - lam(i+1,j,k) * M6(2,2) &
                          - lam(i+2,j,k) * M6(1,2)
                mmtmp6(6) =-lam(i-1,j,k) * M6(4,1) &
                          - lam(i  ,j,k) * M6(3,1) &
                          - lam(i+1,j,k) * M6(2,1) &
                          - lam(i+2,j,k) * M6(1,1)
!EXPAND                M6p = matmul(M6,  q(i-3:i+2,j,k,qpres))
                M6p(1) = M6(1,1) * q(i-3,j,k,qpres) &
                       + M6(1,2) * q(i-2,j,k,qpres) &
                       + M6(1,3) * q(i-1,j,k,qpres) &
                       - M6(6,3) * q(i  ,j,k,qpres)
                M6p(2) = M6(2,1) * q(i-3,j,k,qpres) &
                       + M6(2,2) * q(i-2,j,k,qpres) &
                       + M6(2,3) * q(i-1,j,k,qpres) &
                       - M6(5,3) * q(i  ,j,k,qpres) &
                       - M6(5,2) * q(i+1,j,k,qpres)
                M6p(3) = M6(3,1) * q(i-3,j,k,qpres) &
                       + M6(3,2) * q(i-2,j,k,qpres) &
                       + M6(3,3) * q(i-1,j,k,qpres) &
                       - M6(4,3) * q(i  ,j,k,qpres) &
                       - M6(4,2) * q(i+1,j,k,qpres) &
                       - M6(4,1) * q(i+2,j,k,qpres)
                M6p(4) = M6(4,1) * q(i-3,j,k,qpres) &
                       + M6(4,2) * q(i-2,j,k,qpres) &
                       + M6(4,3) * q(i-1,j,k,qpres) &
                       - M6(3,3) * q(i  ,j,k,qpres) &
                       - M6(3,2) * q(i+1,j,k,qpres) &
                       - M6(3,1) * q(i+2,j,k,qpres)
                M6p(5) = M6(5,2) * q(i-2,j,k,qpres) &
                       + M6(5,3) * q(i-1,j,k,qpres) &
                       - M6(2,3) * q(i  ,j,k,qpres) &
                       - M6(2,2) * q(i+1,j,k,qpres) &
                       - M6(2,1) * q(i+2,j,k,qpres)
                M6p(6) = M6(6,3) * q(i-1,j,k,qpres) &
                       - M6(1,3) * q(i  ,j,k,qpres) &
                       - M6(1,2) * q(i+1,j,k,qpres) &
                       - M6(1,1) * q(i+2,j,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp6, q(i-3:i+2,j,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i-3:i+2,j,k), M6p)
                Hcell(iface,iene) =  &
                   ( ( q(i-3,j,k,qtemp)*mmtmp6(1) + q(i-2,j,k,qtemp)*mmtmp6(2) &
                     + q(i-1,j,k,qtemp)*mmtmp6(3) + q(i  ,j,k,qtemp)*mmtmp6(4) &
                     + q(i+1,j,k,qtemp)*mmtmp6(5) + q(i+2,j,k,qtemp)*mmtmp6(6) ) &
                   + ( dpe(i-3,j,k)*M6p(1) + dpe(i-2,j,k)*M6p(2) &
                     + dpe(i-1,j,k)*M6p(3) + dpe(i  ,j,k)*M6p(4) &
                     + dpe(i+1,j,k)*M6p(5) + dpe(i+2,j,k)*M6p(6) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M6X = matmul(M6, q(i-3:i+2,j,k,qxn))
                   M6X(1) = M6(1,1) * q(i-3,j,k,qxn) &
                          + M6(1,2) * q(i-2,j,k,qxn) &
                          + M6(1,3) * q(i-1,j,k,qxn) &
                          - M6(6,3) * q(i  ,j,k,qxn)
                   M6X(2) = M6(2,1) * q(i-3,j,k,qxn) &
                          + M6(2,2) * q(i-2,j,k,qxn) &
                          + M6(2,3) * q(i-1,j,k,qxn) &
                          - M6(5,3) * q(i  ,j,k,qxn) &
                          - M6(5,2) * q(i+1,j,k,qxn)
                   M6X(3) = M6(3,1) * q(i-3,j,k,qxn) &
                          + M6(3,2) * q(i-2,j,k,qxn) &
                          + M6(3,3) * q(i-1,j,k,qxn) &
                          - M6(4,3) * q(i  ,j,k,qxn) &
                          - M6(4,2) * q(i+1,j,k,qxn) &
                          - M6(4,1) * q(i+2,j,k,qxn)
                   M6X(4) = M6(4,1) * q(i-3,j,k,qxn) &
                          + M6(4,2) * q(i-2,j,k,qxn) &
                          + M6(4,3) * q(i-1,j,k,qxn) &
                          - M6(3,3) * q(i  ,j,k,qxn) &
                          - M6(3,2) * q(i+1,j,k,qxn) &
                          - M6(3,1) * q(i+2,j,k,qxn)
                   M6X(5) = M6(5,2) * q(i-2,j,k,qxn) &
                          + M6(5,3) * q(i-1,j,k,qxn) &
                          - M6(2,3) * q(i  ,j,k,qxn) &
                          - M6(2,2) * q(i+1,j,k,qxn) &
                          - M6(2,1) * q(i+2,j,k,qxn)
                   M6X(6) = M6(6,3) * q(i-1,j,k,qxn) &
                          - M6(1,3) * q(i  ,j,k,qxn) &
                          - M6(1,2) * q(i+1,j,k,qxn) &
                          - M6(1,1) * q(i+2,j,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i-3:i+2,j,k,n), M6p) &
!EXPAND                        +    dot_product(dxy(i-3:i+2,j,k,n), M6X)
                   Htmp(n) =  &
                      ( ( dpy(i-3,j,k,n)*M6p(1) + dpy(i-2,j,k,n)*M6p(2) &
                        + dpy(i-1,j,k,n)*M6p(3) + dpy(i  ,j,k,n)*M6p(4) &
                        + dpy(i+1,j,k,n)*M6p(5) + dpy(i+2,j,k,n)*M6p(6) ) &
                      + ( dxy(i-3,j,k,n)*M6X(1) + dxy(i-2,j,k,n)*M6X(2) &
                        + dxy(i-1,j,k,n)*M6X(3) + dxy(i  ,j,k,n)*M6X(4) &
                        + dxy(i+1,j,k,n)*M6X(5) + dxy(i+2,j,k,n)*M6X(6) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i-3:i+2,j,k,n), M6X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i-3,j,k,n)*M6X(1) + dxe(i-2,j,k,n)*M6X(2) &
                      + dxe(i-1,j,k,n)*M6X(3) + dxe(i  ,j,k,n)*M6X(4) &
                      + dxe(i+1,j,k,n)*M6X(5) + dxe(i+2,j,k,n)*M6X(6) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i-1,j,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i-1,j,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             i = hi(1)-3
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(1)
             end do

             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
             ! use 4th-order stencil for cell hi(1)-2,j,k
             do iface=0,1 
                i = hi(1)-2 + iface

!EXPAND                mmtmp4 = matmul(vsp(i-2:i+1,j,k), M4)
                mmtmp4(1) = vsp(i-2,j,k) * M4(1,1) &
                          + vsp(i-1,j,k) * M4(2,1) &
                          + vsp(i  ,j,k) * M4(3,1)
                mmtmp4(2) = vsp(i-2,j,k) * M4(1,2) &
                          + vsp(i-1,j,k) * M4(2,2) &
                          + vsp(i  ,j,k) * M4(3,2) &
                          + vsp(i+1,j,k) * M4(4,2)
                mmtmp4(3) =-vsp(i-2,j,k) * M4(4,2) &
                          - vsp(i-1,j,k) * M4(3,2) &
                          - vsp(i  ,j,k) * M4(2,2) &
                          - vsp(i+1,j,k) * M4(1,2)
                mmtmp4(4) =-vsp(i-1,j,k) * M4(3,1) &
                          - vsp(i  ,j,k) * M4(2,1) &
                          - vsp(i+1,j,k) * M4(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp4, q(i-2:i+1,j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i-2,j,k,qu)*mmtmp4(1) + q(i-1,j,k,qu)*mmtmp4(2) &
                   + q(i  ,j,k,qu)*mmtmp4(3) + q(i+1,j,k,qu)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(mu(i-2:i+1,j,k), M4)
                mmtmp4(1) = mu(i-2,j,k) * M4(1,1) &
                          + mu(i-1,j,k) * M4(2,1) &
                          + mu(i  ,j,k) * M4(3,1)
                mmtmp4(2) = mu(i-2,j,k) * M4(1,2) &
                          + mu(i-1,j,k) * M4(2,2) &
                          + mu(i  ,j,k) * M4(3,2) &
                          + mu(i+1,j,k) * M4(4,2)
                mmtmp4(3) =-mu(i-2,j,k) * M4(4,2) &
                          - mu(i-1,j,k) * M4(3,2) &
                          - mu(i  ,j,k) * M4(2,2) &
                          - mu(i+1,j,k) * M4(1,2)
                mmtmp4(4) =-mu(i-1,j,k) * M4(3,1) &
                          - mu(i  ,j,k) * M4(2,1) &
                          - mu(i+1,j,k) * M4(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp4, q(i-2:i+1,j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i-2,j,k,qv)*mmtmp4(1) + q(i-1,j,k,qv)*mmtmp4(2) &
                   + q(i  ,j,k,qv)*mmtmp4(3) + q(i+1,j,k,qv)*mmtmp4(4) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp4, q(i-2:i+1,j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i-2,j,k,qw)*mmtmp4(1) + q(i-1,j,k,qw)*mmtmp4(2) &
                   + q(i  ,j,k,qw)*mmtmp4(3) + q(i+1,j,k,qw)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(lam(i-2:i+1,j,k), M4)
                mmtmp4(1) = lam(i-2,j,k) * M4(1,1) &
                          + lam(i-1,j,k) * M4(2,1) &
                          + lam(i  ,j,k) * M4(3,1)
                mmtmp4(2) = lam(i-2,j,k) * M4(1,2) &
                          + lam(i-1,j,k) * M4(2,2) &
                          + lam(i  ,j,k) * M4(3,2) &
                          + lam(i+1,j,k) * M4(4,2)
                mmtmp4(3) =-lam(i-2,j,k) * M4(4,2) &
                          - lam(i-1,j,k) * M4(3,2) &
                          - lam(i  ,j,k) * M4(2,2) &
                          - lam(i+1,j,k) * M4(1,2)
                mmtmp4(4) =-lam(i-1,j,k) * M4(3,1) &
                          - lam(i  ,j,k) * M4(2,1) &
                          - lam(i+1,j,k) * M4(1,1)
!EXPAND                M4p = matmul(M4,  q(i-2:i+1,j,k,qpres))
                M4p(1) = M4(1,1) * q(i-2,j,k,qpres) &
                       + M4(1,2) * q(i-1,j,k,qpres) &
                       - M4(4,2) * q(i  ,j,k,qpres)
                M4p(2) = M4(2,1) * q(i-2,j,k,qpres) &
                       + M4(2,2) * q(i-1,j,k,qpres) &
                       - M4(3,2) * q(i  ,j,k,qpres) &
                       - M4(3,1) * q(i+1,j,k,qpres)
                M4p(3) = M4(3,1) * q(i-2,j,k,qpres) &
                       + M4(3,2) * q(i-1,j,k,qpres) &
                       - M4(2,2) * q(i  ,j,k,qpres) &
                       - M4(2,1) * q(i+1,j,k,qpres)
                M4p(4) = M4(4,2) * q(i-1,j,k,qpres) &
                       - M4(1,2) * q(i  ,j,k,qpres) &
                       - M4(1,1) * q(i+1,j,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp4, q(i-2:i+1,j,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i-2:i+1,j,k), M4p)
                Hcell(iface,iene) =  &
                   ( ( q(i-2,j,k,qtemp)*mmtmp4(1) + q(i-1,j,k,qtemp)*mmtmp4(2) &
                     + q(i  ,j,k,qtemp)*mmtmp4(3) + q(i+1,j,k,qtemp)*mmtmp4(4) ) &
                   + ( dpe(i-2,j,k)*M4p(1) + dpe(i-1,j,k)*M4p(2) &
                     + dpe(i  ,j,k)*M4p(3) + dpe(i+1,j,k)*M4p(4) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M4X = matmul(M4, q(i-2:i+1,j,k,qxn))
                   M4X(1) = M4(1,1) * q(i-2,j,k,qxn) &
                          + M4(1,2) * q(i-1,j,k,qxn) &
                          - M4(4,2) * q(i  ,j,k,qxn)
                   M4X(2) = M4(2,1) * q(i-2,j,k,qxn) &
                          + M4(2,2) * q(i-1,j,k,qxn) &
                          - M4(3,2) * q(i  ,j,k,qxn) &
                          - M4(3,1) * q(i+1,j,k,qxn)
                   M4X(3) = M4(3,1) * q(i-2,j,k,qxn) &
                          + M4(3,2) * q(i-1,j,k,qxn) &
                          - M4(2,2) * q(i  ,j,k,qxn) &
                          - M4(2,1) * q(i+1,j,k,qxn)
                   M4X(4) = M4(4,2) * q(i-1,j,k,qxn) &
                          - M4(1,2) * q(i  ,j,k,qxn) &
                          - M4(1,1) * q(i+1,j,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i-2:i+1,j,k,n), M4p) &
!EXPAND                        +    dot_product(dxy(i-2:i+1,j,k,n), M4X)
                   Htmp(n) =  &
                      ( ( dpy(i-2,j,k,n)*M4p(1) + dpy(i-1,j,k,n)*M4p(2) &
                        + dpy(i  ,j,k,n)*M4p(3) + dpy(i+1,j,k,n)*M4p(4) ) &
                      + ( dxy(i-2,j,k,n)*M4X(1) + dxy(i-1,j,k,n)*M4X(2) &
                        + dxy(i  ,j,k,n)*M4X(3) + dxy(i+1,j,k,n)*M4X(4) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i-2:i+1,j,k,n), M4X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i-2,j,k,n)*M4X(1) + dxe(i-1,j,k,n)*M4X(2) &
                      + dxe(i  ,j,k,n)*M4X(3) + dxe(i+1,j,k,n)*M4X(4) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i-1,j,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i-1,j,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             i = hi(1)-2
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(1)
             end do

             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
             ! use 2nd-order stencil for cell hi(1)-1,j,k
             do iface=0,1 
                i = hi(1)-1 + iface

                mmtmp2 = matmul(vsp(i-1:i,j,k), M2)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp2, q(i-1:i,j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i-1,j,k,qu)*mmtmp2(1) + q(i  ,j,k,qu)*mmtmp2(2) )

                mmtmp2 = matmul(mu(i-1:i,j,k), M2)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp2, q(i-1:i,j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i-1,j,k,qv)*mmtmp2(1) + q(i  ,j,k,qv)*mmtmp2(2) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp2, q(i-1:i,j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i-1,j,k,qw)*mmtmp2(1) + q(i  ,j,k,qw)*mmtmp2(2) )

                mmtmp2 = matmul(lam(i-1:i,j,k), M2)
                M2p = matmul(M2,  q(i-1:i,j,k,qpres))
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp2, q(i-1:i,j,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i-1:i,j,k), M2p)
                Hcell(iface,iene) =  &
                   ( ( q(i-1,j,k,qtemp)*mmtmp2(1) + q(i  ,j,k,qtemp)*mmtmp2(2) ) &
                   + ( dpe(i-1,j,k)*M2p(1) + dpe(i  ,j,k)*M2p(2) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

                   M2X = matmul(M2, q(i-1:i,j,k,qxn))
                
!EXPAND                   Htmp(n) = dot_product(dpy(i-1:i,j,k,n), M2p) &
!EXPAND                        +    dot_product(dxy(i-1:i,j,k,n), M2X)
                   Htmp(n) =  &
                      ( ( dpy(i-1,j,k,n)*M2p(1) + dpy(i  ,j,k,n)*M2p(2) ) &
                      + ( dxy(i-1,j,k,n)*M2X(1) + dxy(i  ,j,k,n)*M2X(2) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i-1:i,j,k,n), M2X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i-1,j,k,n)*M2X(1) + dxe(i  ,j,k,n)*M2X(2) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i-1,j,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i-1,j,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             i = hi(1)-1
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(1)
             end do

             !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
             i = hi(1)
             ! use completely left-biased stencil
             mmtmpB = matmul(vsp(i-3:i,j,k), BLB)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx)+finhi(1)*dx2inv(1)*dot_product(mmtmpB,q(i-3:i,j,k,qu))
             rhs(i,j,k,imx) = rhs(i,j,k,imx)+finhi(1)*dx2inv(1)* &
                ( q(i-3,j,k,qu)*mmtmpB(1) + q(i-2,j,k,qu)*mmtmpB(2) &
                + q(i-1,j,k,qu)*mmtmpB(3) + q(i  ,j,k,qu)*mmtmpB(4) )

             mmtmpB= matmul(mu(i-3:i,j,k), BLB)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy)+fouhi(1)*dx2inv(1)*dot_product(mmtmpB,q(i-3:i,j,k,qv))
             rhs(i,j,k,imy) = rhs(i,j,k,imy)+fouhi(1)*dx2inv(1)* &
                ( q(i-3,j,k,qv)*mmtmpB(1) + q(i-2,j,k,qv)*mmtmpB(2) &
                + q(i-1,j,k,qv)*mmtmpB(3) + q(i  ,j,k,qv)*mmtmpB(4) )
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz)+fouhi(1)*dx2inv(1)*dot_product(mmtmpB,q(i-3:i,j,k,qw))
             rhs(i,j,k,imz) = rhs(i,j,k,imz)+fouhi(1)*dx2inv(1)* &
                ( q(i-3,j,k,qw)*mmtmpB(1) + q(i-2,j,k,qw)*mmtmpB(2) &
                + q(i-1,j,k,qw)*mmtmpB(3) + q(i  ,j,k,qw)*mmtmpB(4) )

             mmtmpB = matmul(lam(i-3:i,j,k), BLB)
             BBp = matmul(BLB, q(i-3:i,j,k,qpres))
!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) + fouhi(1)*dx2inv(1) * &
!EXPAND                  ( dot_product(mmtmpB, q(i-3:i,j,k,qtemp)) &
!EXPAND                  + dot_product(      dpe(i-3:i,j,k), BBp) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene)+fouhi(1)*dx2inv(1)* &
                ( ( q(i-3,j,k,qtemp)*mmtmpB(1) + q(i-2,j,k,qtemp)*mmtmpB(2) &
                  + q(i-1,j,k,qtemp)*mmtmpB(3) + q(i  ,j,k,qtemp)*mmtmpB(4) ) &
                + ( dpe(i-3,j,k)*BBp(1) + dpe(i-2,j,k)*BBp(2) &
                  + dpe(i-1,j,k)*BBp(3) + dpe(i  ,j,k)*BBp(4) ) )
             
             rhstot = 0.d0
             rhsene = 0.d0
             do n = 1, nspecies
                qxn = qx1+n-1
                qyn = qy1+n-1

                BBX = matmul(BLB, q(i-3:i,j,k,qxn))
                
!EXPAND                rhstmp(n) = dot_product(dpy(i-3:i,j,k,n), BBp) &
!EXPAND                     +      dot_product(dxy(i-3:i,j,k,n), BBX)
                rhstmp(n) =  &
                   ( ( dpy(i-3,j,k,n)*BBp(1) + dpy(i-2,j,k,n)*BBp(2) &
                     + dpy(i-1,j,k,n)*BBp(3) + dpy(i  ,j,k,n)*BBp(4) ) &
                   + ( dxy(i-3,j,k,n)*BBX(1) + dxy(i-2,j,k,n)*BBX(2) &
                     + dxy(i-1,j,k,n)*BBX(3) + dxy(i  ,j,k,n)*BBX(4) ) )
                
!EXPAND                rhsene = rhsene &
!EXPAND                     +      dot_product(dxe(i-3:i,j,k,n), BBX)
                rhsene = rhsene+ &
                   ( dxe(i-3,j,k,n)*BBX(1) + dxe(i-2,j,k,n)*BBX(2) &
                   + dxe(i-1,j,k,n)*BBX(3) + dxe(i  ,j,k,n)*BBX(4) )

                rhstot = rhstot + rhstmp(n)
                Ytmp(n) = q(i,j,k,qyn)
             end do
             
             do n = 1, nspecies
                rhs(i,j,k,iry1+n-1) =  rhs(i,j,k,iry1+n-1) + &
                     fouhi(1)*dx2inv(1) * (rhstmp(n) - Ytmp(n)*rhstot)
             end do

             do n = 1, nspecies
                qhn = qh1+n-1
                rhsene = rhsene - Ytmp(n) * q(i,j,k,qhn) * rhstot
             end do
             rhs(i,j,k,iene) = rhs(i,j,k,iene) + fouhi(1)*dx2inv(1) * rhsene
          end do
       end do
    end if

    !
    ! lo-y boundary
    !
    if (physbclo(2)) then
       do k=lo(3),hi(3)
          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          j = lo(2)
          ! use completely right-biased stencil
          do i=lo(1),hi(1)

             mmtmpB = matmul(mu(i,j:j+3,k), BRB)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx)+foulo(2)*dx2inv(2)*dot_product(mmtmpB,q(i,j:j+3,k,qu))
             rhs(i,j,k,imx) = rhs(i,j,k,imx)+foulo(2)*dx2inv(2)* &
                ( q(i,j  ,k,qu)*mmtmpB(1) + q(i,j+1,k,qu)*mmtmpB(2) &
                + q(i,j+2,k,qu)*mmtmpB(3) + q(i,j+3,k,qu)*mmtmpB(4) )
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz)+foulo(2)*dx2inv(2)*dot_product(mmtmpB,q(i,j:j+3,k,qw))
             rhs(i,j,k,imz) = rhs(i,j,k,imz)+foulo(2)*dx2inv(2)* &
                ( q(i,j  ,k,qw)*mmtmpB(1) + q(i,j+1,k,qw)*mmtmpB(2) &
                + q(i,j+2,k,qw)*mmtmpB(3) + q(i,j+3,k,qw)*mmtmpB(4) )

             mmtmpB = matmul(vsp(i,j:j+3,k), BRB)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy)+finlo(2)*dx2inv(2)*dot_product(mmtmpB,q(i,j:j+3,k,qv))
             rhs(i,j,k,imy) = rhs(i,j,k,imy)+finlo(2)*dx2inv(2)* &
                ( q(i,j  ,k,qv)*mmtmpB(1) + q(i,j+1,k,qv)*mmtmpB(2) &
                + q(i,j+2,k,qv)*mmtmpB(3) + q(i,j+3,k,qv)*mmtmpB(4) )

             mmtmpB = matmul(lam(i,j:j+3,k), BRB)
             BBp = matmul(BRB, q(i,j:j+3,k,qpres))
!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) + foulo(2)*dx2inv(2) * &
!EXPAND                  ( dot_product(mmtmpB, q(i,j:j+3,k,qtemp)) &
!EXPAND                  + dot_product(      dpe(i,j:j+3,k), BBp) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene)+foulo(2)*dx2inv(2)* &
                ( ( q(i,j  ,k,qtemp)*mmtmpB(1) + q(i,j+1,k,qtemp)*mmtmpB(2) &
                  + q(i,j+2,k,qtemp)*mmtmpB(3) + q(i,j+3,k,qtemp)*mmtmpB(4) ) &
                + ( dpe(i,j  ,k)*BBp(1) + dpe(i,j+1,k)*BBp(2) &
                  + dpe(i,j+2,k)*BBp(3) + dpe(i,j+3,k)*BBp(4) ) )
             
             rhstot = 0.d0
             rhsene = 0.d0
             do n = 1, nspecies
                qxn = qx1+n-1
                qyn = qy1+n-1

                BBX = matmul(BRB, q(i,j:j+3,k,qxn))
                
!EXPAND                rhstmp(n) = dot_product(dpy(i,j:j+3,k,n), BBp) &
!EXPAND                     +      dot_product(dxy(i,j:j+3,k,n), BBX)
                rhstmp(n) =  &
                   ( ( dpy(i,j  ,k,n)*BBp(1) + dpy(i,j+1,k,n)*BBp(2) &
                     + dpy(i,j+2,k,n)*BBp(3) + dpy(i,j+3,k,n)*BBp(4) ) &
                   + ( dxy(i,j  ,k,n)*BBX(1) + dxy(i,j+1,k,n)*BBX(2) &
                     + dxy(i,j+2,k,n)*BBX(3) + dxy(i,j+3,k,n)*BBX(4) ) )
                
!EXPAND                rhsene = rhsene &
!EXPAND                     +      dot_product(dxe(i,j:j+3,k,n), BBX)
                rhsene = rhsene+ &
                   ( dxe(i,j  ,k,n)*BBX(1) + dxe(i,j+1,k,n)*BBX(2) &
                   + dxe(i,j+2,k,n)*BBX(3) + dxe(i,j+3,k,n)*BBX(4) )

                rhstot = rhstot + rhstmp(n)
                Ytmp(n) = q(i,j,k,qyn)
             end do
             
             do n = 1, nspecies
                rhs(i,j,k,iry1+n-1) =  rhs(i,j,k,iry1+n-1) + &
                     foulo(2)*dx2inv(2) * (rhstmp(n) - Ytmp(n)*rhstot)
             end do

             do n = 1, nspecies
                qhn = qh1+n-1
                rhsene = rhsene - Ytmp(n) * q(i,j,k,qhn) * rhstot
             end do
             rhs(i,j,k,iene) = rhs(i,j,k,iene) + foulo(2)*dx2inv(2) * rhsene
          end do

          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          ! use 2nd-order stencil for cell i,lo(2)+1,k
          do i=lo(1),hi(1)
             do iface=0,1 
                j = lo(2)+1 + iface

                mmtmp2 = matmul(mu(i,j-1:j,k), M2)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp2, q(i,j-1:j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j-1,k,qu)*mmtmp2(1) + q(i,j  ,k,qu)*mmtmp2(2) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp2, q(i,j-1:j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j-1,k,qw)*mmtmp2(1) + q(i,j  ,k,qw)*mmtmp2(2) )

                mmtmp2 = matmul(vsp(i,j-1:j,k), M2)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp2, q(i,j-1:j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j-1,k,qv)*mmtmp2(1) + q(i,j  ,k,qv)*mmtmp2(2) )

                mmtmp2 = matmul(lam(i,j-1:j,k), M2)
                M2p = matmul(M2,  q(i,j-1:j,k,qpres))
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp2, q(i,j-1:j,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j-1:j,k), M2p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j-1,k,qtemp)*mmtmp2(1) + q(i,j  ,k,qtemp)*mmtmp2(2) ) &
                   + ( dpe(i,j-1,k)*M2p(1) + dpe(i,j  ,k)*M2p(2) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

                   M2X = matmul(M2, q(i,j-1:j,k,qxn))
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j-1:j,k,n), M2p) &
!EXPAND                        +    dot_product(dxy(i,j-1:j,k,n), M2X)
                   Htmp(n) =  &
                      ( ( dpy(i,j-1,k,n)*M2p(1) + dpy(i,j  ,k,n)*M2p(2) ) &
                      + ( dxy(i,j-1,k,n)*M2X(1) + dxy(i,j  ,k,n)*M2X(2) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j-1:j,k,n), M2X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j-1,k,n)*M2X(1) + dxe(i,j  ,k,n)*M2X(2) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j-1,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j-1,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             j = lo(2)+1
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(2)
             end do
          end do

          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          ! use 4th-order stencil for cell i,lo(2)+2,k
          do i=lo(1),hi(1)
             do iface=0,1 
                j = lo(2)+2 + iface

!EXPAND                mmtmp4 = matmul(mu(i,j-2:j+1,k), M4)
                mmtmp4(1) = mu(i,j-2,k) * M4(1,1) &
                          + mu(i,j-1,k) * M4(2,1) &
                          + mu(i,j  ,k) * M4(3,1)
                mmtmp4(2) = mu(i,j-2,k) * M4(1,2) &
                          + mu(i,j-1,k) * M4(2,2) &
                          + mu(i,j  ,k) * M4(3,2) &
                          + mu(i,j+1,k) * M4(4,2)
                mmtmp4(3) =-mu(i,j-2,k) * M4(4,2) &
                          - mu(i,j-1,k) * M4(3,2) &
                          - mu(i,j  ,k) * M4(2,2) &
                          - mu(i,j+1,k) * M4(1,2)
                mmtmp4(4) =-mu(i,j-1,k) * M4(3,1) &
                          - mu(i,j  ,k) * M4(2,1) &
                          - mu(i,j+1,k) * M4(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp4, q(i,j-2:j+1,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j-2,k,qu)*mmtmp4(1) + q(i,j-1,k,qu)*mmtmp4(2) &
                   + q(i,j  ,k,qu)*mmtmp4(3) + q(i,j+1,k,qu)*mmtmp4(4) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp4, q(i,j-2:j+1,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j-2,k,qw)*mmtmp4(1) + q(i,j-1,k,qw)*mmtmp4(2) &
                   + q(i,j  ,k,qw)*mmtmp4(3) + q(i,j+1,k,qw)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(vsp(i,j-2:j+1,k), M4)
                mmtmp4(1) = vsp(i,j-2,k) * M4(1,1) &
                          + vsp(i,j-1,k) * M4(2,1) &
                          + vsp(i,j  ,k) * M4(3,1)
                mmtmp4(2) = vsp(i,j-2,k) * M4(1,2) &
                          + vsp(i,j-1,k) * M4(2,2) &
                          + vsp(i,j  ,k) * M4(3,2) &
                          + vsp(i,j+1,k) * M4(4,2)
                mmtmp4(3) =-vsp(i,j-2,k) * M4(4,2) &
                          - vsp(i,j-1,k) * M4(3,2) &
                          - vsp(i,j  ,k) * M4(2,2) &
                          - vsp(i,j+1,k) * M4(1,2)
                mmtmp4(4) =-vsp(i,j-1,k) * M4(3,1) &
                          - vsp(i,j  ,k) * M4(2,1) &
                          - vsp(i,j+1,k) * M4(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp4, q(i,j-2:j+1,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j-2,k,qv)*mmtmp4(1) + q(i,j-1,k,qv)*mmtmp4(2) &
                   + q(i,j  ,k,qv)*mmtmp4(3) + q(i,j+1,k,qv)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(lam(i,j-2:j+1,k), M4)
                mmtmp4(1) = lam(i,j-2,k) * M4(1,1) &
                          + lam(i,j-1,k) * M4(2,1) &
                          + lam(i,j  ,k) * M4(3,1)
                mmtmp4(2) = lam(i,j-2,k) * M4(1,2) &
                          + lam(i,j-1,k) * M4(2,2) &
                          + lam(i,j  ,k) * M4(3,2) &
                          + lam(i,j+1,k) * M4(4,2)
                mmtmp4(3) =-lam(i,j-2,k) * M4(4,2) &
                          - lam(i,j-1,k) * M4(3,2) &
                          - lam(i,j  ,k) * M4(2,2) &
                          - lam(i,j+1,k) * M4(1,2)
                mmtmp4(4) =-lam(i,j-1,k) * M4(3,1) &
                          - lam(i,j  ,k) * M4(2,1) &
                          - lam(i,j+1,k) * M4(1,1)
!EXPAND                M4p = matmul(M4,  q(i,j-2:j+1,k,qpres))
                M4p(1) = M4(1,1) * q(i,j-2,k,qpres) &
                       + M4(1,2) * q(i,j-1,k,qpres) &
                       - M4(4,2) * q(i,j  ,k,qpres)
                M4p(2) = M4(2,1) * q(i,j-2,k,qpres) &
                       + M4(2,2) * q(i,j-1,k,qpres) &
                       - M4(3,2) * q(i,j  ,k,qpres) &
                       - M4(3,1) * q(i,j+1,k,qpres)
                M4p(3) = M4(3,1) * q(i,j-2,k,qpres) &
                       + M4(3,2) * q(i,j-1,k,qpres) &
                       - M4(2,2) * q(i,j  ,k,qpres) &
                       - M4(2,1) * q(i,j+1,k,qpres)
                M4p(4) = M4(4,2) * q(i,j-1,k,qpres) &
                       - M4(1,2) * q(i,j  ,k,qpres) &
                       - M4(1,1) * q(i,j+1,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp4, q(i,j-2:j+1,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j-2:j+1,k), M4p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j-2,k,qtemp)*mmtmp4(1) + q(i,j-1,k,qtemp)*mmtmp4(2) &
                     + q(i,j  ,k,qtemp)*mmtmp4(3) + q(i,j+1,k,qtemp)*mmtmp4(4) ) &
                   + ( dpe(i,j-2,k)*M4p(1) + dpe(i,j-1,k)*M4p(2) &
                     + dpe(i,j  ,k)*M4p(3) + dpe(i,j+1,k)*M4p(4) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M4X = matmul(M4, q(i,j-2:j+1,k,qxn))
                   M4X(1) = M4(1,1) * q(i,j-2,k,qxn) &
                          + M4(1,2) * q(i,j-1,k,qxn) &
                          - M4(4,2) * q(i,j  ,k,qxn)
                   M4X(2) = M4(2,1) * q(i,j-2,k,qxn) &
                          + M4(2,2) * q(i,j-1,k,qxn) &
                          - M4(3,2) * q(i,j  ,k,qxn) &
                          - M4(3,1) * q(i,j+1,k,qxn)
                   M4X(3) = M4(3,1) * q(i,j-2,k,qxn) &
                          + M4(3,2) * q(i,j-1,k,qxn) &
                          - M4(2,2) * q(i,j  ,k,qxn) &
                          - M4(2,1) * q(i,j+1,k,qxn)
                   M4X(4) = M4(4,2) * q(i,j-1,k,qxn) &
                          - M4(1,2) * q(i,j  ,k,qxn) &
                          - M4(1,1) * q(i,j+1,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j-2:j+1,k,n), M4p) &
!EXPAND                        +    dot_product(dxy(i,j-2:j+1,k,n), M4X)
                   Htmp(n) =  &
                      ( ( dpy(i,j-2,k,n)*M4p(1) + dpy(i,j-1,k,n)*M4p(2) &
                        + dpy(i,j  ,k,n)*M4p(3) + dpy(i,j+1,k,n)*M4p(4) ) &
                      + ( dxy(i,j-2,k,n)*M4X(1) + dxy(i,j-1,k,n)*M4X(2) &
                        + dxy(i,j  ,k,n)*M4X(3) + dxy(i,j+1,k,n)*M4X(4) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j-2:j+1,k,n), M4X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j-2,k,n)*M4X(1) + dxe(i,j-1,k,n)*M4X(2) &
                      + dxe(i,j  ,k,n)*M4X(3) + dxe(i,j+1,k,n)*M4X(4) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j-1,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j-1,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             j = lo(2)+2
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(2)
             end do
          end do

          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          ! use 6th-order stencil for cell i,lo(2)+3,k
          do i=lo(1),hi(1)
             do iface=0,1 
                j = lo(2)+3 + iface

!EXPAND                mmtmp6 = matmul(mu(i,j-3:j+2,k), M6)
                mmtmp6(1) = mu(i,j-3,k) * M6(1,1) &
                          + mu(i,j-2,k) * M6(2,1) &
                          + mu(i,j-1,k) * M6(3,1) &
                          + mu(i,j  ,k) * M6(4,1)
                mmtmp6(2) = mu(i,j-3,k) * M6(1,2) &
                          + mu(i,j-2,k) * M6(2,2) &
                          + mu(i,j-1,k) * M6(3,2) &
                          + mu(i,j  ,k) * M6(4,2) &
                          + mu(i,j+1,k) * M6(5,2)
                mmtmp6(3) = mu(i,j-3,k) * M6(1,3) &
                          + mu(i,j-2,k) * M6(2,3) &
                          + mu(i,j-1,k) * M6(3,3) &
                          + mu(i,j  ,k) * M6(4,3) &
                          + mu(i,j+1,k) * M6(5,3) &
                          + mu(i,j+2,k) * M6(6,3)
                mmtmp6(4) =-mu(i,j-3,k) * M6(6,3) &
                          - mu(i,j-2,k) * M6(5,3) &
                          - mu(i,j-1,k) * M6(4,3) &
                          - mu(i,j  ,k) * M6(3,3) &
                          - mu(i,j+1,k) * M6(2,3) &
                          - mu(i,j+2,k) * M6(1,3)
                mmtmp6(5) =-mu(i,j-2,k) * M6(5,2) &
                          - mu(i,j-1,k) * M6(4,2) &
                          - mu(i,j  ,k) * M6(3,2) &
                          - mu(i,j+1,k) * M6(2,2) &
                          - mu(i,j+2,k) * M6(1,2)
                mmtmp6(6) =-mu(i,j-1,k) * M6(4,1) &
                          - mu(i,j  ,k) * M6(3,1) &
                          - mu(i,j+1,k) * M6(2,1) &
                          - mu(i,j+2,k) * M6(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp6, q(i,j-3:j+2,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j-3,k,qu)*mmtmp6(1) + q(i,j-2,k,qu)*mmtmp6(2) &
                   + q(i,j-1,k,qu)*mmtmp6(3) + q(i,j  ,k,qu)*mmtmp6(4) &
                   + q(i,j+1,k,qu)*mmtmp6(5) + q(i,j+2,k,qu)*mmtmp6(6) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp6, q(i,j-3:j+2,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j-3,k,qw)*mmtmp6(1) + q(i,j-2,k,qw)*mmtmp6(2) &
                   + q(i,j-1,k,qw)*mmtmp6(3) + q(i,j  ,k,qw)*mmtmp6(4) &
                   + q(i,j+1,k,qw)*mmtmp6(5) + q(i,j+2,k,qw)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(vsp(i,j-3:j+2,k), M6)
                mmtmp6(1) = vsp(i,j-3,k) * M6(1,1) &
                          + vsp(i,j-2,k) * M6(2,1) &
                          + vsp(i,j-1,k) * M6(3,1) &
                          + vsp(i,j  ,k) * M6(4,1)
                mmtmp6(2) = vsp(i,j-3,k) * M6(1,2) &
                          + vsp(i,j-2,k) * M6(2,2) &
                          + vsp(i,j-1,k) * M6(3,2) &
                          + vsp(i,j  ,k) * M6(4,2) &
                          + vsp(i,j+1,k) * M6(5,2)
                mmtmp6(3) = vsp(i,j-3,k) * M6(1,3) &
                          + vsp(i,j-2,k) * M6(2,3) &
                          + vsp(i,j-1,k) * M6(3,3) &
                          + vsp(i,j  ,k) * M6(4,3) &
                          + vsp(i,j+1,k) * M6(5,3) &
                          + vsp(i,j+2,k) * M6(6,3)
                mmtmp6(4) =-vsp(i,j-3,k) * M6(6,3) &
                          - vsp(i,j-2,k) * M6(5,3) &
                          - vsp(i,j-1,k) * M6(4,3) &
                          - vsp(i,j  ,k) * M6(3,3) &
                          - vsp(i,j+1,k) * M6(2,3) &
                          - vsp(i,j+2,k) * M6(1,3)
                mmtmp6(5) =-vsp(i,j-2,k) * M6(5,2) &
                          - vsp(i,j-1,k) * M6(4,2) &
                          - vsp(i,j  ,k) * M6(3,2) &
                          - vsp(i,j+1,k) * M6(2,2) &
                          - vsp(i,j+2,k) * M6(1,2)
                mmtmp6(6) =-vsp(i,j-1,k) * M6(4,1) &
                          - vsp(i,j  ,k) * M6(3,1) &
                          - vsp(i,j+1,k) * M6(2,1) &
                          - vsp(i,j+2,k) * M6(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp6, q(i,j-3:j+2,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j-3,k,qv)*mmtmp6(1) + q(i,j-2,k,qv)*mmtmp6(2) &
                   + q(i,j-1,k,qv)*mmtmp6(3) + q(i,j  ,k,qv)*mmtmp6(4) &
                   + q(i,j+1,k,qv)*mmtmp6(5) + q(i,j+2,k,qv)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(lam(i,j-3:j+2,k), M6)
                mmtmp6(1) = lam(i,j-3,k) * M6(1,1) &
                          + lam(i,j-2,k) * M6(2,1) &
                          + lam(i,j-1,k) * M6(3,1) &
                          + lam(i,j  ,k) * M6(4,1)
                mmtmp6(2) = lam(i,j-3,k) * M6(1,2) &
                          + lam(i,j-2,k) * M6(2,2) &
                          + lam(i,j-1,k) * M6(3,2) &
                          + lam(i,j  ,k) * M6(4,2) &
                          + lam(i,j+1,k) * M6(5,2)
                mmtmp6(3) = lam(i,j-3,k) * M6(1,3) &
                          + lam(i,j-2,k) * M6(2,3) &
                          + lam(i,j-1,k) * M6(3,3) &
                          + lam(i,j  ,k) * M6(4,3) &
                          + lam(i,j+1,k) * M6(5,3) &
                          + lam(i,j+2,k) * M6(6,3)
                mmtmp6(4) =-lam(i,j-3,k) * M6(6,3) &
                          - lam(i,j-2,k) * M6(5,3) &
                          - lam(i,j-1,k) * M6(4,3) &
                          - lam(i,j  ,k) * M6(3,3) &
                          - lam(i,j+1,k) * M6(2,3) &
                          - lam(i,j+2,k) * M6(1,3)
                mmtmp6(5) =-lam(i,j-2,k) * M6(5,2) &
                          - lam(i,j-1,k) * M6(4,2) &
                          - lam(i,j  ,k) * M6(3,2) &
                          - lam(i,j+1,k) * M6(2,2) &
                          - lam(i,j+2,k) * M6(1,2)
                mmtmp6(6) =-lam(i,j-1,k) * M6(4,1) &
                          - lam(i,j  ,k) * M6(3,1) &
                          - lam(i,j+1,k) * M6(2,1) &
                          - lam(i,j+2,k) * M6(1,1)
!EXPAND                M6p = matmul(M6,  q(i,j-3:j+2,k,qpres))
                M6p(1) = M6(1,1) * q(i,j-3,k,qpres) &
                       + M6(1,2) * q(i,j-2,k,qpres) &
                       + M6(1,3) * q(i,j-1,k,qpres) &
                       - M6(6,3) * q(i,j  ,k,qpres)
                M6p(2) = M6(2,1) * q(i,j-3,k,qpres) &
                       + M6(2,2) * q(i,j-2,k,qpres) &
                       + M6(2,3) * q(i,j-1,k,qpres) &
                       - M6(5,3) * q(i,j  ,k,qpres) &
                       - M6(5,2) * q(i,j+1,k,qpres)
                M6p(3) = M6(3,1) * q(i,j-3,k,qpres) &
                       + M6(3,2) * q(i,j-2,k,qpres) &
                       + M6(3,3) * q(i,j-1,k,qpres) &
                       - M6(4,3) * q(i,j  ,k,qpres) &
                       - M6(4,2) * q(i,j+1,k,qpres) &
                       - M6(4,1) * q(i,j+2,k,qpres)
                M6p(4) = M6(4,1) * q(i,j-3,k,qpres) &
                       + M6(4,2) * q(i,j-2,k,qpres) &
                       + M6(4,3) * q(i,j-1,k,qpres) &
                       - M6(3,3) * q(i,j  ,k,qpres) &
                       - M6(3,2) * q(i,j+1,k,qpres) &
                       - M6(3,1) * q(i,j+2,k,qpres)
                M6p(5) = M6(5,2) * q(i,j-2,k,qpres) &
                       + M6(5,3) * q(i,j-1,k,qpres) &
                       - M6(2,3) * q(i,j  ,k,qpres) &
                       - M6(2,2) * q(i,j+1,k,qpres) &
                       - M6(2,1) * q(i,j+2,k,qpres)
                M6p(6) = M6(6,3) * q(i,j-1,k,qpres) &
                       - M6(1,3) * q(i,j  ,k,qpres) &
                       - M6(1,2) * q(i,j+1,k,qpres) &
                       - M6(1,1) * q(i,j+2,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp6, q(i,j-3:j+2,k,qtemp))      &
!EXPAND                     &            + dot_product(      dpe(i,j-3:j+2,k), M6p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j-3,k,qtemp)*mmtmp6(1) + q(i,j-2,k,qtemp)*mmtmp6(2) &
                     + q(i,j-1,k,qtemp)*mmtmp6(3) + q(i,j  ,k,qtemp)*mmtmp6(4) &
                     + q(i,j+1,k,qtemp)*mmtmp6(5) + q(i,j+2,k,qtemp)*mmtmp6(6) ) &
                   + ( dpe(i,j-3,k)*M6p(1) + dpe(i,j-2,k)*M6p(2) &
                     + dpe(i,j-1,k)*M6p(3) + dpe(i,j  ,k)*M6p(4) &
                     + dpe(i,j+1,k)*M6p(5) + dpe(i,j+2,k)*M6p(6) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M6X = matmul(M6, q(i,j-3:j+2,k,qxn))
                   M6X(1) = M6(1,1) * q(i,j-3,k,qxn) &
                          + M6(1,2) * q(i,j-2,k,qxn) &
                          + M6(1,3) * q(i,j-1,k,qxn) &
                          - M6(6,3) * q(i,j  ,k,qxn)
                   M6X(2) = M6(2,1) * q(i,j-3,k,qxn) &
                          + M6(2,2) * q(i,j-2,k,qxn) &
                          + M6(2,3) * q(i,j-1,k,qxn) &
                          - M6(5,3) * q(i,j  ,k,qxn) &
                          - M6(5,2) * q(i,j+1,k,qxn)
                   M6X(3) = M6(3,1) * q(i,j-3,k,qxn) &
                          + M6(3,2) * q(i,j-2,k,qxn) &
                          + M6(3,3) * q(i,j-1,k,qxn) &
                          - M6(4,3) * q(i,j  ,k,qxn) &
                          - M6(4,2) * q(i,j+1,k,qxn) &
                          - M6(4,1) * q(i,j+2,k,qxn)
                   M6X(4) = M6(4,1) * q(i,j-3,k,qxn) &
                          + M6(4,2) * q(i,j-2,k,qxn) &
                          + M6(4,3) * q(i,j-1,k,qxn) &
                          - M6(3,3) * q(i,j  ,k,qxn) &
                          - M6(3,2) * q(i,j+1,k,qxn) &
                          - M6(3,1) * q(i,j+2,k,qxn)
                   M6X(5) = M6(5,2) * q(i,j-2,k,qxn) &
                          + M6(5,3) * q(i,j-1,k,qxn) &
                          - M6(2,3) * q(i,j  ,k,qxn) &
                          - M6(2,2) * q(i,j+1,k,qxn) &
                          - M6(2,1) * q(i,j+2,k,qxn)
                   M6X(6) = M6(6,3) * q(i,j-1,k,qxn) &
                          - M6(1,3) * q(i,j  ,k,qxn) &
                          - M6(1,2) * q(i,j+1,k,qxn) &
                          - M6(1,1) * q(i,j+2,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j-3:j+2,k,n), M6p) &
!EXPAND                        +    dot_product(dxy(i,j-3:j+2,k,n), M6X)
                   Htmp(n) =  &
                      ( ( dpy(i,j-3,k,n)*M6p(1) + dpy(i,j-2,k,n)*M6p(2) &
                        + dpy(i,j-1,k,n)*M6p(3) + dpy(i,j  ,k,n)*M6p(4) &
                        + dpy(i,j+1,k,n)*M6p(5) + dpy(i,j+2,k,n)*M6p(6) ) &
                      + ( dxy(i,j-3,k,n)*M6X(1) + dxy(i,j-2,k,n)*M6X(2) &
                        + dxy(i,j-1,k,n)*M6X(3) + dxy(i,j  ,k,n)*M6X(4) &
                        + dxy(i,j+1,k,n)*M6X(5) + dxy(i,j+2,k,n)*M6X(6) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j-3:j+2,k,n), M6X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j-3,k,n)*M6X(1) + dxe(i,j-2,k,n)*M6X(2) &
                      + dxe(i,j-1,k,n)*M6X(3) + dxe(i,j  ,k,n)*M6X(4) &
                      + dxe(i,j+1,k,n)*M6X(5) + dxe(i,j+2,k,n)*M6X(6) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j-1,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j-1,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             j = lo(2)+3
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(2)
             end do
          end do
       end do
    end if

    !
    ! hi-y boundary
    !
    if (physbchi(2)) then
       do k=lo(3),hi(3)
          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          ! use 6th-order stencil for cell i,hi(2)-3,k
          do i=lo(1),hi(1)
             do iface=0,1 
                j = hi(2)-3 + iface

!EXPAND                mmtmp6 = matmul(mu(i,j-3:j+2,k), M6)
                mmtmp6(1) = mu(i,j-3,k) * M6(1,1) &
                          + mu(i,j-2,k) * M6(2,1) &
                          + mu(i,j-1,k) * M6(3,1) &
                          + mu(i,j  ,k) * M6(4,1)
                mmtmp6(2) = mu(i,j-3,k) * M6(1,2) &
                          + mu(i,j-2,k) * M6(2,2) &
                          + mu(i,j-1,k) * M6(3,2) &
                          + mu(i,j  ,k) * M6(4,2) &
                          + mu(i,j+1,k) * M6(5,2)
                mmtmp6(3) = mu(i,j-3,k) * M6(1,3) &
                          + mu(i,j-2,k) * M6(2,3) &
                          + mu(i,j-1,k) * M6(3,3) &
                          + mu(i,j  ,k) * M6(4,3) &
                          + mu(i,j+1,k) * M6(5,3) &
                          + mu(i,j+2,k) * M6(6,3)
                mmtmp6(4) =-mu(i,j-3,k) * M6(6,3) &
                          - mu(i,j-2,k) * M6(5,3) &
                          - mu(i,j-1,k) * M6(4,3) &
                          - mu(i,j  ,k) * M6(3,3) &
                          - mu(i,j+1,k) * M6(2,3) &
                          - mu(i,j+2,k) * M6(1,3)
                mmtmp6(5) =-mu(i,j-2,k) * M6(5,2) &
                          - mu(i,j-1,k) * M6(4,2) &
                          - mu(i,j  ,k) * M6(3,2) &
                          - mu(i,j+1,k) * M6(2,2) &
                          - mu(i,j+2,k) * M6(1,2)
                mmtmp6(6) =-mu(i,j-1,k) * M6(4,1) &
                          - mu(i,j  ,k) * M6(3,1) &
                          - mu(i,j+1,k) * M6(2,1) &
                          - mu(i,j+2,k) * M6(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp6, q(i,j-3:j+2,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j-3,k,qu)*mmtmp6(1) + q(i,j-2,k,qu)*mmtmp6(2) &
                   + q(i,j-1,k,qu)*mmtmp6(3) + q(i,j  ,k,qu)*mmtmp6(4) &
                   + q(i,j+1,k,qu)*mmtmp6(5) + q(i,j+2,k,qu)*mmtmp6(6) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp6, q(i,j-3:j+2,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j-3,k,qw)*mmtmp6(1) + q(i,j-2,k,qw)*mmtmp6(2) &
                   + q(i,j-1,k,qw)*mmtmp6(3) + q(i,j  ,k,qw)*mmtmp6(4) &
                   + q(i,j+1,k,qw)*mmtmp6(5) + q(i,j+2,k,qw)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(vsp(i,j-3:j+2,k), M6)
                mmtmp6(1) = vsp(i,j-3,k) * M6(1,1) &
                          + vsp(i,j-2,k) * M6(2,1) &
                          + vsp(i,j-1,k) * M6(3,1) &
                          + vsp(i,j  ,k) * M6(4,1)
                mmtmp6(2) = vsp(i,j-3,k) * M6(1,2) &
                          + vsp(i,j-2,k) * M6(2,2) &
                          + vsp(i,j-1,k) * M6(3,2) &
                          + vsp(i,j  ,k) * M6(4,2) &
                          + vsp(i,j+1,k) * M6(5,2)
                mmtmp6(3) = vsp(i,j-3,k) * M6(1,3) &
                          + vsp(i,j-2,k) * M6(2,3) &
                          + vsp(i,j-1,k) * M6(3,3) &
                          + vsp(i,j  ,k) * M6(4,3) &
                          + vsp(i,j+1,k) * M6(5,3) &
                          + vsp(i,j+2,k) * M6(6,3)
                mmtmp6(4) =-vsp(i,j-3,k) * M6(6,3) &
                          - vsp(i,j-2,k) * M6(5,3) &
                          - vsp(i,j-1,k) * M6(4,3) &
                          - vsp(i,j  ,k) * M6(3,3) &
                          - vsp(i,j+1,k) * M6(2,3) &
                          - vsp(i,j+2,k) * M6(1,3)
                mmtmp6(5) =-vsp(i,j-2,k) * M6(5,2) &
                          - vsp(i,j-1,k) * M6(4,2) &
                          - vsp(i,j  ,k) * M6(3,2) &
                          - vsp(i,j+1,k) * M6(2,2) &
                          - vsp(i,j+2,k) * M6(1,2)
                mmtmp6(6) =-vsp(i,j-1,k) * M6(4,1) &
                          - vsp(i,j  ,k) * M6(3,1) &
                          - vsp(i,j+1,k) * M6(2,1) &
                          - vsp(i,j+2,k) * M6(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp6, q(i,j-3:j+2,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j-3,k,qv)*mmtmp6(1) + q(i,j-2,k,qv)*mmtmp6(2) &
                   + q(i,j-1,k,qv)*mmtmp6(3) + q(i,j  ,k,qv)*mmtmp6(4) &
                   + q(i,j+1,k,qv)*mmtmp6(5) + q(i,j+2,k,qv)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(lam(i,j-3:j+2,k), M6)
                mmtmp6(1) = lam(i,j-3,k) * M6(1,1) &
                          + lam(i,j-2,k) * M6(2,1) &
                          + lam(i,j-1,k) * M6(3,1) &
                          + lam(i,j  ,k) * M6(4,1)
                mmtmp6(2) = lam(i,j-3,k) * M6(1,2) &
                          + lam(i,j-2,k) * M6(2,2) &
                          + lam(i,j-1,k) * M6(3,2) &
                          + lam(i,j  ,k) * M6(4,2) &
                          + lam(i,j+1,k) * M6(5,2)
                mmtmp6(3) = lam(i,j-3,k) * M6(1,3) &
                          + lam(i,j-2,k) * M6(2,3) &
                          + lam(i,j-1,k) * M6(3,3) &
                          + lam(i,j  ,k) * M6(4,3) &
                          + lam(i,j+1,k) * M6(5,3) &
                          + lam(i,j+2,k) * M6(6,3)
                mmtmp6(4) =-lam(i,j-3,k) * M6(6,3) &
                          - lam(i,j-2,k) * M6(5,3) &
                          - lam(i,j-1,k) * M6(4,3) &
                          - lam(i,j  ,k) * M6(3,3) &
                          - lam(i,j+1,k) * M6(2,3) &
                          - lam(i,j+2,k) * M6(1,3)
                mmtmp6(5) =-lam(i,j-2,k) * M6(5,2) &
                          - lam(i,j-1,k) * M6(4,2) &
                          - lam(i,j  ,k) * M6(3,2) &
                          - lam(i,j+1,k) * M6(2,2) &
                          - lam(i,j+2,k) * M6(1,2)
                mmtmp6(6) =-lam(i,j-1,k) * M6(4,1) &
                          - lam(i,j  ,k) * M6(3,1) &
                          - lam(i,j+1,k) * M6(2,1) &
                          - lam(i,j+2,k) * M6(1,1)
!EXPAND                M6p = matmul(M6,  q(i,j-3:j+2,k,qpres))
                M6p(1) = M6(1,1) * q(i,j-3,k,qpres) &
                       + M6(1,2) * q(i,j-2,k,qpres) &
                       + M6(1,3) * q(i,j-1,k,qpres) &
                       - M6(6,3) * q(i,j  ,k,qpres)
                M6p(2) = M6(2,1) * q(i,j-3,k,qpres) &
                       + M6(2,2) * q(i,j-2,k,qpres) &
                       + M6(2,3) * q(i,j-1,k,qpres) &
                       - M6(5,3) * q(i,j  ,k,qpres) &
                       - M6(5,2) * q(i,j+1,k,qpres)
                M6p(3) = M6(3,1) * q(i,j-3,k,qpres) &
                       + M6(3,2) * q(i,j-2,k,qpres) &
                       + M6(3,3) * q(i,j-1,k,qpres) &
                       - M6(4,3) * q(i,j  ,k,qpres) &
                       - M6(4,2) * q(i,j+1,k,qpres) &
                       - M6(4,1) * q(i,j+2,k,qpres)
                M6p(4) = M6(4,1) * q(i,j-3,k,qpres) &
                       + M6(4,2) * q(i,j-2,k,qpres) &
                       + M6(4,3) * q(i,j-1,k,qpres) &
                       - M6(3,3) * q(i,j  ,k,qpres) &
                       - M6(3,2) * q(i,j+1,k,qpres) &
                       - M6(3,1) * q(i,j+2,k,qpres)
                M6p(5) = M6(5,2) * q(i,j-2,k,qpres) &
                       + M6(5,3) * q(i,j-1,k,qpres) &
                       - M6(2,3) * q(i,j  ,k,qpres) &
                       - M6(2,2) * q(i,j+1,k,qpres) &
                       - M6(2,1) * q(i,j+2,k,qpres)
                M6p(6) = M6(6,3) * q(i,j-1,k,qpres) &
                       - M6(1,3) * q(i,j  ,k,qpres) &
                       - M6(1,2) * q(i,j+1,k,qpres) &
                       - M6(1,1) * q(i,j+2,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp6, q(i,j-3:j+2,k,qtemp))      &
!EXPAND                     &            + dot_product(      dpe(i,j-3:j+2,k), M6p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j-3,k,qtemp)*mmtmp6(1) + q(i,j-2,k,qtemp)*mmtmp6(2) &
                     + q(i,j-1,k,qtemp)*mmtmp6(3) + q(i,j  ,k,qtemp)*mmtmp6(4) &
                     + q(i,j+1,k,qtemp)*mmtmp6(5) + q(i,j+2,k,qtemp)*mmtmp6(6) ) &
                   + ( dpe(i,j-3,k)*M6p(1) + dpe(i,j-2,k)*M6p(2) &
                     + dpe(i,j-1,k)*M6p(3) + dpe(i,j  ,k)*M6p(4) &
                     + dpe(i,j+1,k)*M6p(5) + dpe(i,j+2,k)*M6p(6) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M6X = matmul(M6, q(i,j-3:j+2,k,qxn))
                   M6X(1) = M6(1,1) * q(i,j-3,k,qxn) &
                          + M6(1,2) * q(i,j-2,k,qxn) &
                          + M6(1,3) * q(i,j-1,k,qxn) &
                          - M6(6,3) * q(i,j  ,k,qxn)
                   M6X(2) = M6(2,1) * q(i,j-3,k,qxn) &
                          + M6(2,2) * q(i,j-2,k,qxn) &
                          + M6(2,3) * q(i,j-1,k,qxn) &
                          - M6(5,3) * q(i,j  ,k,qxn) &
                          - M6(5,2) * q(i,j+1,k,qxn)
                   M6X(3) = M6(3,1) * q(i,j-3,k,qxn) &
                          + M6(3,2) * q(i,j-2,k,qxn) &
                          + M6(3,3) * q(i,j-1,k,qxn) &
                          - M6(4,3) * q(i,j  ,k,qxn) &
                          - M6(4,2) * q(i,j+1,k,qxn) &
                          - M6(4,1) * q(i,j+2,k,qxn)
                   M6X(4) = M6(4,1) * q(i,j-3,k,qxn) &
                          + M6(4,2) * q(i,j-2,k,qxn) &
                          + M6(4,3) * q(i,j-1,k,qxn) &
                          - M6(3,3) * q(i,j  ,k,qxn) &
                          - M6(3,2) * q(i,j+1,k,qxn) &
                          - M6(3,1) * q(i,j+2,k,qxn)
                   M6X(5) = M6(5,2) * q(i,j-2,k,qxn) &
                          + M6(5,3) * q(i,j-1,k,qxn) &
                          - M6(2,3) * q(i,j  ,k,qxn) &
                          - M6(2,2) * q(i,j+1,k,qxn) &
                          - M6(2,1) * q(i,j+2,k,qxn)
                   M6X(6) = M6(6,3) * q(i,j-1,k,qxn) &
                          - M6(1,3) * q(i,j  ,k,qxn) &
                          - M6(1,2) * q(i,j+1,k,qxn) &
                          - M6(1,1) * q(i,j+2,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j-3:j+2,k,n), M6p) &
!EXPAND                        +    dot_product(dxy(i,j-3:j+2,k,n), M6X)
                   Htmp(n) =  &
                      ( ( dpy(i,j-3,k,n)*M6p(1) + dpy(i,j-2,k,n)*M6p(2) &
                        + dpy(i,j-1,k,n)*M6p(3) + dpy(i,j  ,k,n)*M6p(4) &
                        + dpy(i,j+1,k,n)*M6p(5) + dpy(i,j+2,k,n)*M6p(6) ) &
                      + ( dxy(i,j-3,k,n)*M6X(1) + dxy(i,j-2,k,n)*M6X(2) &
                        + dxy(i,j-1,k,n)*M6X(3) + dxy(i,j  ,k,n)*M6X(4) &
                        + dxy(i,j+1,k,n)*M6X(5) + dxy(i,j+2,k,n)*M6X(6) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j-3:j+2,k,n), M6X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j-3,k,n)*M6X(1) + dxe(i,j-2,k,n)*M6X(2) &
                      + dxe(i,j-1,k,n)*M6X(3) + dxe(i,j  ,k,n)*M6X(4) &
                      + dxe(i,j+1,k,n)*M6X(5) + dxe(i,j+2,k,n)*M6X(6) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j-1,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j-1,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             j = hi(2)-3
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(2)
             end do
          end do

          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          ! use 4th-order stencil for cell i,hi(2)-2,k
          do i=lo(1),hi(1)
             do iface=0,1 
                j = hi(2)-2 + iface

!EXPAND                mmtmp4 = matmul(mu(i,j-2:j+1,k), M4)
                mmtmp4(1) = mu(i,j-2,k) * M4(1,1) &
                          + mu(i,j-1,k) * M4(2,1) &
                          + mu(i,j  ,k) * M4(3,1)
                mmtmp4(2) = mu(i,j-2,k) * M4(1,2) &
                          + mu(i,j-1,k) * M4(2,2) &
                          + mu(i,j  ,k) * M4(3,2) &
                          + mu(i,j+1,k) * M4(4,2)
                mmtmp4(3) =-mu(i,j-2,k) * M4(4,2) &
                          - mu(i,j-1,k) * M4(3,2) &
                          - mu(i,j  ,k) * M4(2,2) &
                          - mu(i,j+1,k) * M4(1,2)
                mmtmp4(4) =-mu(i,j-1,k) * M4(3,1) &
                          - mu(i,j  ,k) * M4(2,1) &
                          - mu(i,j+1,k) * M4(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp4, q(i,j-2:j+1,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j-2,k,qu)*mmtmp4(1) + q(i,j-1,k,qu)*mmtmp4(2) &
                   + q(i,j  ,k,qu)*mmtmp4(3) + q(i,j+1,k,qu)*mmtmp4(4) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp4, q(i,j-2:j+1,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j-2,k,qw)*mmtmp4(1) + q(i,j-1,k,qw)*mmtmp4(2) &
                   + q(i,j  ,k,qw)*mmtmp4(3) + q(i,j+1,k,qw)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(vsp(i,j-2:j+1,k), M4)
                mmtmp4(1) = vsp(i,j-2,k) * M4(1,1) &
                          + vsp(i,j-1,k) * M4(2,1) &
                          + vsp(i,j  ,k) * M4(3,1)
                mmtmp4(2) = vsp(i,j-2,k) * M4(1,2) &
                          + vsp(i,j-1,k) * M4(2,2) &
                          + vsp(i,j  ,k) * M4(3,2) &
                          + vsp(i,j+1,k) * M4(4,2)
                mmtmp4(3) =-vsp(i,j-2,k) * M4(4,2) &
                          - vsp(i,j-1,k) * M4(3,2) &
                          - vsp(i,j  ,k) * M4(2,2) &
                          - vsp(i,j+1,k) * M4(1,2)
                mmtmp4(4) =-vsp(i,j-1,k) * M4(3,1) &
                          - vsp(i,j  ,k) * M4(2,1) &
                          - vsp(i,j+1,k) * M4(1,1)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp4, q(i,j-2:j+1,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j-2,k,qv)*mmtmp4(1) + q(i,j-1,k,qv)*mmtmp4(2) &
                   + q(i,j  ,k,qv)*mmtmp4(3) + q(i,j+1,k,qv)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(lam(i,j-2:j+1,k), M4)
                mmtmp4(1) = lam(i,j-2,k) * M4(1,1) &
                          + lam(i,j-1,k) * M4(2,1) &
                          + lam(i,j  ,k) * M4(3,1)
                mmtmp4(2) = lam(i,j-2,k) * M4(1,2) &
                          + lam(i,j-1,k) * M4(2,2) &
                          + lam(i,j  ,k) * M4(3,2) &
                          + lam(i,j+1,k) * M4(4,2)
                mmtmp4(3) =-lam(i,j-2,k) * M4(4,2) &
                          - lam(i,j-1,k) * M4(3,2) &
                          - lam(i,j  ,k) * M4(2,2) &
                          - lam(i,j+1,k) * M4(1,2)
                mmtmp4(4) =-lam(i,j-1,k) * M4(3,1) &
                          - lam(i,j  ,k) * M4(2,1) &
                          - lam(i,j+1,k) * M4(1,1)
!EXPAND                M4p = matmul(M4,  q(i,j-2:j+1,k,qpres))
                M4p(1) = M4(1,1) * q(i,j-2,k,qpres) &
                       + M4(1,2) * q(i,j-1,k,qpres) &
                       - M4(4,2) * q(i,j  ,k,qpres)
                M4p(2) = M4(2,1) * q(i,j-2,k,qpres) &
                       + M4(2,2) * q(i,j-1,k,qpres) &
                       - M4(3,2) * q(i,j  ,k,qpres) &
                       - M4(3,1) * q(i,j+1,k,qpres)
                M4p(3) = M4(3,1) * q(i,j-2,k,qpres) &
                       + M4(3,2) * q(i,j-1,k,qpres) &
                       - M4(2,2) * q(i,j  ,k,qpres) &
                       - M4(2,1) * q(i,j+1,k,qpres)
                M4p(4) = M4(4,2) * q(i,j-1,k,qpres) &
                       - M4(1,2) * q(i,j  ,k,qpres) &
                       - M4(1,1) * q(i,j+1,k,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp4, q(i,j-2:j+1,k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j-2:j+1,k), M4p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j-2,k,qtemp)*mmtmp4(1) + q(i,j-1,k,qtemp)*mmtmp4(2) &
                     + q(i,j  ,k,qtemp)*mmtmp4(3) + q(i,j+1,k,qtemp)*mmtmp4(4) ) &
                   + ( dpe(i,j-2,k)*M4p(1) + dpe(i,j-1,k)*M4p(2) &
                     + dpe(i,j  ,k)*M4p(3) + dpe(i,j+1,k)*M4p(4) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M4X = matmul(M4, q(i,j-2:j+1,k,qxn))
                   M4X(1) = M4(1,1) * q(i,j-2,k,qxn) &
                          + M4(1,2) * q(i,j-1,k,qxn) &
                          - M4(4,2) * q(i,j  ,k,qxn)
                   M4X(2) = M4(2,1) * q(i,j-2,k,qxn) &
                          + M4(2,2) * q(i,j-1,k,qxn) &
                          - M4(3,2) * q(i,j  ,k,qxn) &
                          - M4(3,1) * q(i,j+1,k,qxn)
                   M4X(3) = M4(3,1) * q(i,j-2,k,qxn) &
                          + M4(3,2) * q(i,j-1,k,qxn) &
                          - M4(2,2) * q(i,j  ,k,qxn) &
                          - M4(2,1) * q(i,j+1,k,qxn)
                   M4X(4) = M4(4,2) * q(i,j-1,k,qxn) &
                          - M4(1,2) * q(i,j  ,k,qxn) &
                          - M4(1,1) * q(i,j+1,k,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j-2:j+1,k,n), M4p) &
!EXPAND                        +    dot_product(dxy(i,j-2:j+1,k,n), M4X)
                   Htmp(n) =  &
                      ( ( dpy(i,j-2,k,n)*M4p(1) + dpy(i,j-1,k,n)*M4p(2) &
                        + dpy(i,j  ,k,n)*M4p(3) + dpy(i,j+1,k,n)*M4p(4) ) &
                      + ( dxy(i,j-2,k,n)*M4X(1) + dxy(i,j-1,k,n)*M4X(2) &
                        + dxy(i,j  ,k,n)*M4X(3) + dxy(i,j+1,k,n)*M4X(4) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j-2:j+1,k,n), M4X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j-2,k,n)*M4X(1) + dxe(i,j-1,k,n)*M4X(2) &
                      + dxe(i,j  ,k,n)*M4X(3) + dxe(i,j+1,k,n)*M4X(4) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j-1,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j-1,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             j = hi(2)-2
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(2)
             end do
          end do

          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          ! use 2nd-order stencil for cell i,hi(2)-1,k
          do i=lo(1),hi(1)
             do iface=0,1 
                j = hi(2)-1 + iface

                mmtmp2 = matmul(mu(i,j-1:j,k), M2)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp2, q(i,j-1:j,k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j-1,k,qu)*mmtmp2(1) + q(i,j  ,k,qu)*mmtmp2(2) )
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp2, q(i,j-1:j,k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j-1,k,qw)*mmtmp2(1) + q(i,j  ,k,qw)*mmtmp2(2) )

                mmtmp2 = matmul(vsp(i,j-1:j,k), M2)
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp2, q(i,j-1:j,k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j-1,k,qv)*mmtmp2(1) + q(i,j  ,k,qv)*mmtmp2(2) )

                mmtmp2 = matmul(lam(i,j-1:j,k), M2)
                M2p = matmul(M2,  q(i,j-1:j,k,qpres))
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp2, q(i,j-1:j,k,qtemp))      &
!EXPAND                     &            + dot_product(      dpe(i,j-1:j,k), M2p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j-1,k,qtemp)*mmtmp2(1) + q(i,j  ,k,qtemp)*mmtmp2(2) ) &
                   + ( dpe(i,j-1,k)*M2p(1) + dpe(i,j  ,k)*M2p(2) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

                   M2X = matmul(M2, q(i,j-1:j,k,qxn))
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j-1:j,k,n), M2p) &
!EXPAND                        +    dot_product(dxy(i,j-1:j,k,n), M2X)
                   Htmp(n) =  &
                      ( ( dpy(i,j-1,k,n)*M2p(1) + dpy(i,j  ,k,n)*M2p(2) ) &
                      + ( dxy(i,j-1,k,n)*M2X(1) + dxy(i,j  ,k,n)*M2X(2) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j-1:j,k,n), M2X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j-1,k,n)*M2X(1) + dxe(i,j  ,k,n)*M2X(2) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j-1,k,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j-1,k,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             j = hi(2)-1
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(2)
             end do
          end do

          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          j = hi(2)
          ! use completely right-biased stencil
          do i=lo(1),hi(1)

             mmtmpB = matmul(mu(i,j-3:j,k), BLB)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx)+fouhi(2)*dx2inv(2)*dot_product(mmtmpB,q(i,j-3:j,k,qu))
             rhs(i,j,k,imx) = rhs(i,j,k,imx)+fouhi(2)*dx2inv(2)* &
                ( q(i,j-3,k,qu)*mmtmpB(1) + q(i,j-2,k,qu)*mmtmpB(2) &
                + q(i,j-1,k,qu)*mmtmpB(3) + q(i,j  ,k,qu)*mmtmpB(4) )
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz)+fouhi(2)*dx2inv(2)*dot_product(mmtmpB,q(i,j-3:j,k,qw))
             rhs(i,j,k,imz) = rhs(i,j,k,imz)+fouhi(2)*dx2inv(2)* &
                ( q(i,j-3,k,qw)*mmtmpB(1) + q(i,j-2,k,qw)*mmtmpB(2) &
                + q(i,j-1,k,qw)*mmtmpB(3) + q(i,j  ,k,qw)*mmtmpB(4) )

             mmtmpB = matmul(vsp(i,j-3:j,k), BLB)
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy)+finhi(2)*dx2inv(2)*dot_product(mmtmpB,q(i,j-3:j,k,qv))
             rhs(i,j,k,imy) = rhs(i,j,k,imy)+finhi(2)*dx2inv(2)* &
                ( q(i,j-3,k,qv)*mmtmpB(1) + q(i,j-2,k,qv)*mmtmpB(2) &
                + q(i,j-1,k,qv)*mmtmpB(3) + q(i,j  ,k,qv)*mmtmpB(4) )

             mmtmpB = matmul(lam(i,j-3:j,k), BLB)
             BBp = matmul(BLB, q(i,j-3:j,k,qpres))
!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) + fouhi(2)*dx2inv(2) * &
!EXPAND                  ( dot_product(mmtmpB, q(i,j-3:j,k,qtemp)) &
!EXPAND                  + dot_product(      dpe(i,j-3:j,k), BBp) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene)+fouhi(2)*dx2inv(2)* &
                ( ( q(i,j-3,k,qtemp)*mmtmpB(1) + q(i,j-2,k,qtemp)*mmtmpB(2) &
                  + q(i,j-1,k,qtemp)*mmtmpB(3) + q(i,j  ,k,qtemp)*mmtmpB(4) ) &
                + ( dpe(i,j-3,k)*BBp(1) + dpe(i,j-2,k)*BBp(2) &
                  + dpe(i,j-1,k)*BBp(3) + dpe(i,j  ,k)*BBp(4) ) )
             
             rhstot = 0.d0
             rhsene = 0.d0
             do n = 1, nspecies
                qxn = qx1+n-1
                qyn = qy1+n-1

                BBX = matmul(BLB, q(i,j-3:j,k,qxn))
                
!EXPAND                rhstmp(n) = dot_product(dpy(i,j-3:j,k,n), BBp) &
!EXPAND                     +      dot_product(dxy(i,j-3:j,k,n), BBX)
                rhstmp(n) =  &
                   ( ( dpy(i,j-3,k,n)*BBp(1) + dpy(i,j-2,k,n)*BBp(2) &
                     + dpy(i,j-1,k,n)*BBp(3) + dpy(i,j  ,k,n)*BBp(4) ) &
                   + ( dxy(i,j-3,k,n)*BBX(1) + dxy(i,j-2,k,n)*BBX(2) &
                     + dxy(i,j-1,k,n)*BBX(3) + dxy(i,j  ,k,n)*BBX(4) ) )
                
!EXPAND                rhsene = rhsene &
!EXPAND                     +      dot_product(dxe(i,j-3:j,k,n), BBX)
                rhsene = rhsene+ &
                   ( dxe(i,j-3,k,n)*BBX(1) + dxe(i,j-2,k,n)*BBX(2) &
                   + dxe(i,j-1,k,n)*BBX(3) + dxe(i,j  ,k,n)*BBX(4) )

                rhstot = rhstot + rhstmp(n)
                Ytmp(n) = q(i,j,k,qyn)
             end do
             
             do n = 1, nspecies
                rhs(i,j,k,iry1+n-1) =  rhs(i,j,k,iry1+n-1) + &
                     fouhi(2)*dx2inv(2) * (rhstmp(n) - Ytmp(n)*rhstot)
             end do

             do n = 1, nspecies
                qhn = qh1+n-1
                rhsene = rhsene - Ytmp(n) * q(i,j,k,qhn) * rhstot
             end do
             rhs(i,j,k,iene) = rhs(i,j,k,iene) + fouhi(2)*dx2inv(2) * rhsene
          end do
       end do
    end if

    !
    ! lo-z boundary
    !
    if (physbclo(3)) then
       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       k = lo(3)
       ! use completely right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             mmtmpB = matmul(mu(i,j,k:k+3), BRB)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx)+foulo(3)*dx2inv(3)*dot_product(mmtmpB,q(i,j,k:k+3,qu))
             rhs(i,j,k,imx) = rhs(i,j,k,imx)+foulo(3)*dx2inv(3)* &
                ( q(i,j,k  ,qu)*mmtmpB(1) + q(i,j,k+1,qu)*mmtmpB(2) &
                + q(i,j,k+2,qu)*mmtmpB(3) + q(i,j,k+3,qu)*mmtmpB(4) )
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy)+foulo(3)*dx2inv(3)*dot_product(mmtmpB,q(i,j,k:k+3,qv))
             rhs(i,j,k,imy) = rhs(i,j,k,imy)+foulo(3)*dx2inv(3)* &
                ( q(i,j,k  ,qv)*mmtmpB(1) + q(i,j,k+1,qv)*mmtmpB(2) &
                + q(i,j,k+2,qv)*mmtmpB(3) + q(i,j,k+3,qv)*mmtmpB(4) )

             mmtmpB = matmul(vsp(i,j,k:k+3), BRB)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz)+finlo(3)*dx2inv(3)*dot_product(mmtmpB,q(i,j,k:k+3,qw) )
             rhs(i,j,k,imz) = rhs(i,j,k,imz)+finlo(3)*dx2inv(3)* &
                ( q(i,j,k  ,qw)*mmtmpB(1) + q(i,j,k+1,qw)*mmtmpB(2) &
                + q(i,j,k+2,qw)*mmtmpB(3) + q(i,j,k+3,qw)*mmtmpB(4) )

             mmtmpB = matmul(lam(i,j,k:k+3), BRB)
             BBp = matmul(BRB, q(i,j,k:k+3,qpres))
!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) + foulo(3)*dx2inv(3) * &
!EXPAND                  ( dot_product(mmtmpB, q(i,j,k:k+3,qtemp)) &
!EXPAND                  + dot_product(      dpe(i,j,k:k+3), BBp) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene)+foulo(3)*dx2inv(3)* &
                ( ( q(i,j,k  ,qtemp)*mmtmpB(1) + q(i,j,k+1,qtemp)*mmtmpB(2) &
                  + q(i,j,k+2,qtemp)*mmtmpB(3) + q(i,j,k+3,qtemp)*mmtmpB(4) ) &
                + ( dpe(i,j,k  )*BBp(1) + dpe(i,j,k+1)*BBp(2) &
                  + dpe(i,j,k+2)*BBp(3) + dpe(i,j,k+3)*BBp(4) ) )
             
             rhstot = 0.d0
             rhsene = 0.d0
             do n = 1, nspecies
                qxn = qx1+n-1
                qyn = qy1+n-1

                BBX = matmul(BRB, q(i,j,k:k+3,qxn))
                
!EXPAND                rhstmp(n) = dot_product(dpy(i,j,k:k+3,n), BBp) &
!EXPAND                     +      dot_product(dxy(i,j,k:k+3,n), BBX)
                rhstmp(n) =  &
                   ( ( dpy(i,j,k  ,n)*BBp(1) + dpy(i,j,k+1,n)*BBp(2) &
                     + dpy(i,j,k+2,n)*BBp(3) + dpy(i,j,k+3,n)*BBp(4) ) &
                   + ( dxy(i,j,k  ,n)*BBX(1) + dxy(i,j,k+1,n)*BBX(2) &
                     + dxy(i,j,k+2,n)*BBX(3) + dxy(i,j,k+3,n)*BBX(4) ) )
                
!EXPAND                rhsene = rhsene &
!EXPAND                     +      dot_product(dxe(i,j,k:k+3,n), BBX)
                rhsene = rhsene+ &
                   ( dxe(i,j,k  ,n)*BBX(1) + dxe(i,j,k+1,n)*BBX(2) &
                   + dxe(i,j,k+2,n)*BBX(3) + dxe(i,j,k+3,n)*BBX(4) )

                rhstot = rhstot + rhstmp(n)
                Ytmp(n) = q(i,j,k,qyn)
             end do
             
             do n = 1, nspecies
                rhs(i,j,k,iry1+n-1) =  rhs(i,j,k,iry1+n-1) + &
                     foulo(3)*dx2inv(3) * (rhstmp(n) - Ytmp(n)*rhstot)
             end do

             do n = 1, nspecies
                qhn = qh1+n-1
                rhsene = rhsene - Ytmp(n) * q(i,j,k,qhn) * rhstot
             end do
             rhs(i,j,k,iene) = rhs(i,j,k,iene) + foulo(3)*dx2inv(3) * rhsene
             
          end do
       end do

       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       ! use 2nd-order stencil for cell i,j,lo(3)+1
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             do iface=0,1 
                k = lo(3)+1 + iface

                mmtmp2 = matmul(mu(i,j,k-1:k), M2)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp2, q(i,j,k-1:k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j,k-1,qu)*mmtmp2(1) + q(i,j,k  ,qu)*mmtmp2(2) )
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp2, q(i,j,k-1:k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j,k-1,qv)*mmtmp2(1) + q(i,j,k  ,qv)*mmtmp2(2) )

                mmtmp2 = matmul(vsp(i,j,k-1:k), M2)
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp2, q(i,j,k-1:k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j,k-1,qw)*mmtmp2(1) + q(i,j,k  ,qw)*mmtmp2(2) )

                mmtmp2 = matmul(lam(i,j,k-1:k), M2)
                M2p = matmul(M2,  q(i,j,k-1:k,qpres))
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp2, q(i,j,k-1:k,qtemp)) &
!EXPAND                     &            + dot_product(       dpe(i,j,k-1:k), M2p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j,k-1,qtemp)*mmtmp2(1) + q(i,j,k  ,qtemp)*mmtmp2(2) ) &
                   + ( dpe(i,j,k-1)*M2p(1) + dpe(i,j,k  )*M2p(2) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

                   M2X = matmul(M2, q(i,j,k-1:k,qxn))
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j,k-1:k,n), M2p) &
!EXPAND                        +    dot_product(dxy(i,j,k-1:k,n), M2X)
                   Htmp(n) =  &
                      ( ( dpy(i,j,k-1,n)*M2p(1) + dpy(i,j,k  ,n)*M2p(2) ) &
                      + ( dxy(i,j,k-1,n)*M2X(1) + dxy(i,j,k  ,n)*M2X(2) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j,k-1:k,n), M2X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j,k-1,n)*M2X(1) + dxe(i,j,k  ,n)*M2X(2) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j,k-1,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j,k-1,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             k = lo(3)+1
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(3)
             end do
          end do
       end do

       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       ! use 4th-order stencil for cell i,j,lo(3)+2
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             do iface=0,1 
                k = lo(3)+2 + iface

!EXPAND                mmtmp4 = matmul(mu(i,j,k-2:k+1), M4)
                mmtmp4(1) = mu(i,j,k-2) * M4(1,1) &
                          + mu(i,j,k-1) * M4(2,1) &
                          + mu(i,j,k  ) * M4(3,1)
                mmtmp4(2) = mu(i,j,k-2) * M4(1,2) &
                          + mu(i,j,k-1) * M4(2,2) &
                          + mu(i,j,k  ) * M4(3,2) &
                          + mu(i,j,k+1) * M4(4,2)
                mmtmp4(3) =-mu(i,j,k-2) * M4(4,2) &
                          - mu(i,j,k-1) * M4(3,2) &
                          - mu(i,j,k  ) * M4(2,2) &
                          - mu(i,j,k+1) * M4(1,2)
                mmtmp4(4) =-mu(i,j,k-1) * M4(3,1) &
                          - mu(i,j,k  ) * M4(2,1) &
                          - mu(i,j,k+1) * M4(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp4, q(i,j,k-2:k+1,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j,k-2,qu)*mmtmp4(1) + q(i,j,k-1,qu)*mmtmp4(2) &
                   + q(i,j,k  ,qu)*mmtmp4(3) + q(i,j,k+1,qu)*mmtmp4(4) )
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp4, q(i,j,k-2:k+1,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j,k-2,qv)*mmtmp4(1) + q(i,j,k-1,qv)*mmtmp4(2) &
                   + q(i,j,k  ,qv)*mmtmp4(3) + q(i,j,k+1,qv)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(vsp(i,j,k-2:k+1), M4)
                mmtmp4(1) = vsp(i,j,k-2) * M4(1,1) &
                          + vsp(i,j,k-1) * M4(2,1) &
                          + vsp(i,j,k  ) * M4(3,1)
                mmtmp4(2) = vsp(i,j,k-2) * M4(1,2) &
                          + vsp(i,j,k-1) * M4(2,2) &
                          + vsp(i,j,k  ) * M4(3,2) &
                          + vsp(i,j,k+1) * M4(4,2)
                mmtmp4(3) =-vsp(i,j,k-2) * M4(4,2) &
                          - vsp(i,j,k-1) * M4(3,2) &
                          - vsp(i,j,k  ) * M4(2,2) &
                          - vsp(i,j,k+1) * M4(1,2)
                mmtmp4(4) =-vsp(i,j,k-1) * M4(3,1) &
                          - vsp(i,j,k  ) * M4(2,1) &
                          - vsp(i,j,k+1) * M4(1,1)
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp4, q(i,j,k-2:k+1,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j,k-2,qw)*mmtmp4(1) + q(i,j,k-1,qw)*mmtmp4(2) &
                   + q(i,j,k  ,qw)*mmtmp4(3) + q(i,j,k+1,qw)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(lam(i,j,k-2:k+1), M4)
                mmtmp4(1) = lam(i,j,k-2) * M4(1,1) &
                          + lam(i,j,k-1) * M4(2,1) &
                          + lam(i,j,k  ) * M4(3,1)
                mmtmp4(2) = lam(i,j,k-2) * M4(1,2) &
                          + lam(i,j,k-1) * M4(2,2) &
                          + lam(i,j,k  ) * M4(3,2) &
                          + lam(i,j,k+1) * M4(4,2)
                mmtmp4(3) =-lam(i,j,k-2) * M4(4,2) &
                          - lam(i,j,k-1) * M4(3,2) &
                          - lam(i,j,k  ) * M4(2,2) &
                          - lam(i,j,k+1) * M4(1,2)
                mmtmp4(4) =-lam(i,j,k-1) * M4(3,1) &
                          - lam(i,j,k  ) * M4(2,1) &
                          - lam(i,j,k+1) * M4(1,1)
!EXPAND                M4p = matmul(M4,  q(i,j,k-2:k+1,qpres))
                M4p(1) = M4(1,1) * q(i,j,k-2,qpres) &
                       + M4(1,2) * q(i,j,k-1,qpres) &
                       - M4(4,2) * q(i,j,k  ,qpres)
                M4p(2) = M4(2,1) * q(i,j,k-2,qpres) &
                       + M4(2,2) * q(i,j,k-1,qpres) &
                       - M4(3,2) * q(i,j,k  ,qpres) &
                       - M4(3,1) * q(i,j,k+1,qpres)
                M4p(3) = M4(3,1) * q(i,j,k-2,qpres) &
                       + M4(3,2) * q(i,j,k-1,qpres) &
                       - M4(2,2) * q(i,j,k  ,qpres) &
                       - M4(2,1) * q(i,j,k+1,qpres)
                M4p(4) = M4(4,2) * q(i,j,k-1,qpres) &
                       - M4(1,2) * q(i,j,k  ,qpres) &
                       - M4(1,1) * q(i,j,k+1,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp4, q(i,j,k-2:k+1,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j,k-2:k+1), M4p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j,k-2,qtemp)*mmtmp4(1) + q(i,j,k-1,qtemp)*mmtmp4(2) &
                     + q(i,j,k  ,qtemp)*mmtmp4(3) + q(i,j,k+1,qtemp)*mmtmp4(4) ) &
                   + ( dpe(i,j,k-2)*M4p(1) + dpe(i,j,k-1)*M4p(2) &
                     + dpe(i,j,k  )*M4p(3) + dpe(i,j,k+1)*M4p(4) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M4X = matmul(M4, q(i,j,k-2:k+1,qxn))
                   M4X(1) = M4(1,1) * q(i,j,k-2,qxn) &
                          + M4(1,2) * q(i,j,k-1,qxn) &
                          - M4(4,2) * q(i,j,k  ,qxn)
                   M4X(2) = M4(2,1) * q(i,j,k-2,qxn) &
                          + M4(2,2) * q(i,j,k-1,qxn) &
                          - M4(3,2) * q(i,j,k  ,qxn) &
                          - M4(3,1) * q(i,j,k+1,qxn)
                   M4X(3) = M4(3,1) * q(i,j,k-2,qxn) &
                          + M4(3,2) * q(i,j,k-1,qxn) &
                          - M4(2,2) * q(i,j,k  ,qxn) &
                          - M4(2,1) * q(i,j,k+1,qxn)
                   M4X(4) = M4(4,2) * q(i,j,k-1,qxn) &
                          - M4(1,2) * q(i,j,k  ,qxn) &
                          - M4(1,1) * q(i,j,k+1,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j,k-2:k+1,n), M4p) &
!EXPAND                        +    dot_product(dxy(i,j,k-2:k+1,n), M4X)
                   Htmp(n) =  &
                      ( ( dpy(i,j,k-2,n)*M4p(1) + dpy(i,j,k-1,n)*M4p(2) &
                        + dpy(i,j,k  ,n)*M4p(3) + dpy(i,j,k+1,n)*M4p(4) ) &
                      + ( dxy(i,j,k-2,n)*M4X(1) + dxy(i,j,k-1,n)*M4X(2) &
                        + dxy(i,j,k  ,n)*M4X(3) + dxy(i,j,k+1,n)*M4X(4) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j,k-2:k+1,n), M4X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j,k-2,n)*M4X(1) + dxe(i,j,k-1,n)*M4X(2) &
                      + dxe(i,j,k  ,n)*M4X(3) + dxe(i,j,k+1,n)*M4X(4) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j,k-1,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j,k-1,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             k = lo(3)+2
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(3)
             end do
          end do
       end do

       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       ! use 6th-order stencil for cell i,j,lo(3)+3
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             do iface=0,1 
                k = lo(3)+3 + iface

!EXPAND                mmtmp6 = matmul(mu(i,j,k-3:k+2), M6)
                mmtmp6(1) = mu(i,j,k-3) * M6(1,1) &
                          + mu(i,j,k-2) * M6(2,1) &
                          + mu(i,j,k-1) * M6(3,1) &
                          + mu(i,j,k  ) * M6(4,1)
                mmtmp6(2) = mu(i,j,k-3) * M6(1,2) &
                          + mu(i,j,k-2) * M6(2,2) &
                          + mu(i,j,k-1) * M6(3,2) &
                          + mu(i,j,k  ) * M6(4,2) &
                          + mu(i,j,k+1) * M6(5,2)
                mmtmp6(3) = mu(i,j,k-3) * M6(1,3) &
                          + mu(i,j,k-2) * M6(2,3) &
                          + mu(i,j,k-1) * M6(3,3) &
                          + mu(i,j,k  ) * M6(4,3) &
                          + mu(i,j,k+1) * M6(5,3) &
                          + mu(i,j,k+2) * M6(6,3)
                mmtmp6(4) =-mu(i,j,k-3) * M6(6,3) &
                          - mu(i,j,k-2) * M6(5,3) &
                          - mu(i,j,k-1) * M6(4,3) &
                          - mu(i,j,k  ) * M6(3,3) &
                          - mu(i,j,k+1) * M6(2,3) &
                          - mu(i,j,k+2) * M6(1,3)
                mmtmp6(5) =-mu(i,j,k-2) * M6(5,2) &
                          - mu(i,j,k-1) * M6(4,2) &
                          - mu(i,j,k  ) * M6(3,2) &
                          - mu(i,j,k+1) * M6(2,2) &
                          - mu(i,j,k+2) * M6(1,2)
                mmtmp6(6) =-mu(i,j,k-1) * M6(4,1) &
                          - mu(i,j,k  ) * M6(3,1) &
                          - mu(i,j,k+1) * M6(2,1) &
                          - mu(i,j,k+2) * M6(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp6, q(i,j,k-3:k+2,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j,k-3,qu)*mmtmp6(1) + q(i,j,k-2,qu)*mmtmp6(2) &
                   + q(i,j,k-1,qu)*mmtmp6(3) + q(i,j,k  ,qu)*mmtmp6(4) &
                   + q(i,j,k+1,qu)*mmtmp6(5) + q(i,j,k+2,qu)*mmtmp6(6) )
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp6, q(i,j,k-3:k+2,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j,k-3,qv)*mmtmp6(1) + q(i,j,k-2,qv)*mmtmp6(2) &
                   + q(i,j,k-1,qv)*mmtmp6(3) + q(i,j,k  ,qv)*mmtmp6(4) &
                   + q(i,j,k+1,qv)*mmtmp6(5) + q(i,j,k+2,qv)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(vsp(i,j,k-3:k+2), M6)
                mmtmp6(1) = vsp(i,j,k-3) * M6(1,1) &
                          + vsp(i,j,k-2) * M6(2,1) &
                          + vsp(i,j,k-1) * M6(3,1) &
                          + vsp(i,j,k  ) * M6(4,1)
                mmtmp6(2) = vsp(i,j,k-3) * M6(1,2) &
                          + vsp(i,j,k-2) * M6(2,2) &
                          + vsp(i,j,k-1) * M6(3,2) &
                          + vsp(i,j,k  ) * M6(4,2) &
                          + vsp(i,j,k+1) * M6(5,2)
                mmtmp6(3) = vsp(i,j,k-3) * M6(1,3) &
                          + vsp(i,j,k-2) * M6(2,3) &
                          + vsp(i,j,k-1) * M6(3,3) &
                          + vsp(i,j,k  ) * M6(4,3) &
                          + vsp(i,j,k+1) * M6(5,3) &
                          + vsp(i,j,k+2) * M6(6,3)
                mmtmp6(4) =-vsp(i,j,k-3) * M6(6,3) &
                          - vsp(i,j,k-2) * M6(5,3) &
                          - vsp(i,j,k-1) * M6(4,3) &
                          - vsp(i,j,k  ) * M6(3,3) &
                          - vsp(i,j,k+1) * M6(2,3) &
                          - vsp(i,j,k+2) * M6(1,3)
                mmtmp6(5) =-vsp(i,j,k-2) * M6(5,2) &
                          - vsp(i,j,k-1) * M6(4,2) &
                          - vsp(i,j,k  ) * M6(3,2) &
                          - vsp(i,j,k+1) * M6(2,2) &
                          - vsp(i,j,k+2) * M6(1,2)
                mmtmp6(6) =-vsp(i,j,k-1) * M6(4,1) &
                          - vsp(i,j,k  ) * M6(3,1) &
                          - vsp(i,j,k+1) * M6(2,1) &
                          - vsp(i,j,k+2) * M6(1,1)
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp6, q(i,j,k-3:k+2,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j,k-3,qw)*mmtmp6(1) + q(i,j,k-2,qw)*mmtmp6(2) &
                   + q(i,j,k-1,qw)*mmtmp6(3) + q(i,j,k  ,qw)*mmtmp6(4) &
                   + q(i,j,k+1,qw)*mmtmp6(5) + q(i,j,k+2,qw)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(lam(i,j,k-3:k+2), M6)
                mmtmp6(1) = lam(i,j,k-3) * M6(1,1) &
                          + lam(i,j,k-2) * M6(2,1) &
                          + lam(i,j,k-1) * M6(3,1) &
                          + lam(i,j,k  ) * M6(4,1)
                mmtmp6(2) = lam(i,j,k-3) * M6(1,2) &
                          + lam(i,j,k-2) * M6(2,2) &
                          + lam(i,j,k-1) * M6(3,2) &
                          + lam(i,j,k  ) * M6(4,2) &
                          + lam(i,j,k+1) * M6(5,2)
                mmtmp6(3) = lam(i,j,k-3) * M6(1,3) &
                          + lam(i,j,k-2) * M6(2,3) &
                          + lam(i,j,k-1) * M6(3,3) &
                          + lam(i,j,k  ) * M6(4,3) &
                          + lam(i,j,k+1) * M6(5,3) &
                          + lam(i,j,k+2) * M6(6,3)
                mmtmp6(4) =-lam(i,j,k-3) * M6(6,3) &
                          - lam(i,j,k-2) * M6(5,3) &
                          - lam(i,j,k-1) * M6(4,3) &
                          - lam(i,j,k  ) * M6(3,3) &
                          - lam(i,j,k+1) * M6(2,3) &
                          - lam(i,j,k+2) * M6(1,3)
                mmtmp6(5) =-lam(i,j,k-2) * M6(5,2) &
                          - lam(i,j,k-1) * M6(4,2) &
                          - lam(i,j,k  ) * M6(3,2) &
                          - lam(i,j,k+1) * M6(2,2) &
                          - lam(i,j,k+2) * M6(1,2)
                mmtmp6(6) =-lam(i,j,k-1) * M6(4,1) &
                          - lam(i,j,k  ) * M6(3,1) &
                          - lam(i,j,k+1) * M6(2,1) &
                          - lam(i,j,k+2) * M6(1,1)
!EXPAND                M6p = matmul(M6,  q(i,j,k-3:k+2,qpres))
                M6p(1) = M6(1,1) * q(i,j,k-3,qpres) &
                       + M6(1,2) * q(i,j,k-2,qpres) &
                       + M6(1,3) * q(i,j,k-1,qpres) &
                       - M6(6,3) * q(i,j,k  ,qpres)
                M6p(2) = M6(2,1) * q(i,j,k-3,qpres) &
                       + M6(2,2) * q(i,j,k-2,qpres) &
                       + M6(2,3) * q(i,j,k-1,qpres) &
                       - M6(5,3) * q(i,j,k  ,qpres) &
                       - M6(5,2) * q(i,j,k+1,qpres)
                M6p(3) = M6(3,1) * q(i,j,k-3,qpres) &
                       + M6(3,2) * q(i,j,k-2,qpres) &
                       + M6(3,3) * q(i,j,k-1,qpres) &
                       - M6(4,3) * q(i,j,k  ,qpres) &
                       - M6(4,2) * q(i,j,k+1,qpres) &
                       - M6(4,1) * q(i,j,k+2,qpres)
                M6p(4) = M6(4,1) * q(i,j,k-3,qpres) &
                       + M6(4,2) * q(i,j,k-2,qpres) &
                       + M6(4,3) * q(i,j,k-1,qpres) &
                       - M6(3,3) * q(i,j,k  ,qpres) &
                       - M6(3,2) * q(i,j,k+1,qpres) &
                       - M6(3,1) * q(i,j,k+2,qpres)
                M6p(5) = M6(5,2) * q(i,j,k-2,qpres) &
                       + M6(5,3) * q(i,j,k-1,qpres) &
                       - M6(2,3) * q(i,j,k  ,qpres) &
                       - M6(2,2) * q(i,j,k+1,qpres) &
                       - M6(2,1) * q(i,j,k+2,qpres)
                M6p(6) = M6(6,3) * q(i,j,k-1,qpres) &
                       - M6(1,3) * q(i,j,k  ,qpres) &
                       - M6(1,2) * q(i,j,k+1,qpres) &
                       - M6(1,1) * q(i,j,k+2,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp6, q(i,j,k-3:k+2,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j,k-3:k+2), M6p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j,k-3,qtemp)*mmtmp6(1) + q(i,j,k-2,qtemp)*mmtmp6(2) &
                     + q(i,j,k-1,qtemp)*mmtmp6(3) + q(i,j,k  ,qtemp)*mmtmp6(4) &
                     + q(i,j,k+1,qtemp)*mmtmp6(5) + q(i,j,k+2,qtemp)*mmtmp6(6) ) &
                   + ( dpe(i,j,k-3)*M6p(1) + dpe(i,j,k-2)*M6p(2) &
                     + dpe(i,j,k-1)*M6p(3) + dpe(i,j,k  )*M6p(4) &
                     + dpe(i,j,k+1)*M6p(5) + dpe(i,j,k+2)*M6p(6) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M6X = matmul(M6, q(i,j,k-3:k+2,qxn))
                   M6X(1) = M6(1,1) * q(i,j,k-3,qxn) &
                          + M6(1,2) * q(i,j,k-2,qxn) &
                          + M6(1,3) * q(i,j,k-1,qxn) &
                          - M6(6,3) * q(i,j,k  ,qxn)
                   M6X(2) = M6(2,1) * q(i,j,k-3,qxn) &
                          + M6(2,2) * q(i,j,k-2,qxn) &
                          + M6(2,3) * q(i,j,k-1,qxn) &
                          - M6(5,3) * q(i,j,k  ,qxn) &
                          - M6(5,2) * q(i,j,k+1,qxn)
                   M6X(3) = M6(3,1) * q(i,j,k-3,qxn) &
                          + M6(3,2) * q(i,j,k-2,qxn) &
                          + M6(3,3) * q(i,j,k-1,qxn) &
                          - M6(4,3) * q(i,j,k  ,qxn) &
                          - M6(4,2) * q(i,j,k+1,qxn) &
                          - M6(4,1) * q(i,j,k+2,qxn)
                   M6X(4) = M6(4,1) * q(i,j,k-3,qxn) &
                          + M6(4,2) * q(i,j,k-2,qxn) &
                          + M6(4,3) * q(i,j,k-1,qxn) &
                          - M6(3,3) * q(i,j,k  ,qxn) &
                          - M6(3,2) * q(i,j,k+1,qxn) &
                          - M6(3,1) * q(i,j,k+2,qxn)
                   M6X(5) = M6(5,2) * q(i,j,k-2,qxn) &
                          + M6(5,3) * q(i,j,k-1,qxn) &
                          - M6(2,3) * q(i,j,k  ,qxn) &
                          - M6(2,2) * q(i,j,k+1,qxn) &
                          - M6(2,1) * q(i,j,k+2,qxn)
                   M6X(6) = M6(6,3) * q(i,j,k-1,qxn) &
                          - M6(1,3) * q(i,j,k  ,qxn) &
                          - M6(1,2) * q(i,j,k+1,qxn) &
                          - M6(1,1) * q(i,j,k+2,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j,k-3:k+2,n), M6p) &
!EXPAND                        +    dot_product(dxy(i,j,k-3:k+2,n), M6X)
                   Htmp(n) =  &
                      ( ( dpy(i,j,k-3,n)*M6p(1) + dpy(i,j,k-2,n)*M6p(2) &
                        + dpy(i,j,k-1,n)*M6p(3) + dpy(i,j,k  ,n)*M6p(4) &
                        + dpy(i,j,k+1,n)*M6p(5) + dpy(i,j,k+2,n)*M6p(6) ) &
                      + ( dxy(i,j,k-3,n)*M6X(1) + dxy(i,j,k-2,n)*M6X(2) &
                        + dxy(i,j,k-1,n)*M6X(3) + dxy(i,j,k  ,n)*M6X(4) &
                        + dxy(i,j,k+1,n)*M6X(5) + dxy(i,j,k+2,n)*M6X(6) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j,k-3:k+2,n), M6X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j,k-3,n)*M6X(1) + dxe(i,j,k-2,n)*M6X(2) &
                      + dxe(i,j,k-1,n)*M6X(3) + dxe(i,j,k  ,n)*M6X(4) &
                      + dxe(i,j,k+1,n)*M6X(5) + dxe(i,j,k+2,n)*M6X(6) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j,k-1,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j,k-1,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             k = lo(3)+3
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(3)
             end do
          end do
       end do
    end if

    !
    ! hi-z boundary
    !
    if (physbchi(3)) then
       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       ! use 6th-order stencil for cell i,j,hi(3)-3
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             do iface=0,1 
                k = hi(3)-3 + iface

!EXPAND                mmtmp6 = matmul(mu(i,j,k-3:k+2), M6)
                mmtmp6(1) = mu(i,j,k-3) * M6(1,1) &
                          + mu(i,j,k-2) * M6(2,1) &
                          + mu(i,j,k-1) * M6(3,1) &
                          + mu(i,j,k  ) * M6(4,1)
                mmtmp6(2) = mu(i,j,k-3) * M6(1,2) &
                          + mu(i,j,k-2) * M6(2,2) &
                          + mu(i,j,k-1) * M6(3,2) &
                          + mu(i,j,k  ) * M6(4,2) &
                          + mu(i,j,k+1) * M6(5,2)
                mmtmp6(3) = mu(i,j,k-3) * M6(1,3) &
                          + mu(i,j,k-2) * M6(2,3) &
                          + mu(i,j,k-1) * M6(3,3) &
                          + mu(i,j,k  ) * M6(4,3) &
                          + mu(i,j,k+1) * M6(5,3) &
                          + mu(i,j,k+2) * M6(6,3)
                mmtmp6(4) =-mu(i,j,k-3) * M6(6,3) &
                          - mu(i,j,k-2) * M6(5,3) &
                          - mu(i,j,k-1) * M6(4,3) &
                          - mu(i,j,k  ) * M6(3,3) &
                          - mu(i,j,k+1) * M6(2,3) &
                          - mu(i,j,k+2) * M6(1,3)
                mmtmp6(5) =-mu(i,j,k-2) * M6(5,2) &
                          - mu(i,j,k-1) * M6(4,2) &
                          - mu(i,j,k  ) * M6(3,2) &
                          - mu(i,j,k+1) * M6(2,2) &
                          - mu(i,j,k+2) * M6(1,2)
                mmtmp6(6) =-mu(i,j,k-1) * M6(4,1) &
                          - mu(i,j,k  ) * M6(3,1) &
                          - mu(i,j,k+1) * M6(2,1) &
                          - mu(i,j,k+2) * M6(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp6, q(i,j,k-3:k+2,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j,k-3,qu)*mmtmp6(1) + q(i,j,k-2,qu)*mmtmp6(2) &
                   + q(i,j,k-1,qu)*mmtmp6(3) + q(i,j,k  ,qu)*mmtmp6(4) &
                   + q(i,j,k+1,qu)*mmtmp6(5) + q(i,j,k+2,qu)*mmtmp6(6) )
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp6, q(i,j,k-3:k+2,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j,k-3,qv)*mmtmp6(1) + q(i,j,k-2,qv)*mmtmp6(2) &
                   + q(i,j,k-1,qv)*mmtmp6(3) + q(i,j,k  ,qv)*mmtmp6(4) &
                   + q(i,j,k+1,qv)*mmtmp6(5) + q(i,j,k+2,qv)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(vsp(i,j,k-3:k+2), M6)
                mmtmp6(1) = vsp(i,j,k-3) * M6(1,1) &
                          + vsp(i,j,k-2) * M6(2,1) &
                          + vsp(i,j,k-1) * M6(3,1) &
                          + vsp(i,j,k  ) * M6(4,1)
                mmtmp6(2) = vsp(i,j,k-3) * M6(1,2) &
                          + vsp(i,j,k-2) * M6(2,2) &
                          + vsp(i,j,k-1) * M6(3,2) &
                          + vsp(i,j,k  ) * M6(4,2) &
                          + vsp(i,j,k+1) * M6(5,2)
                mmtmp6(3) = vsp(i,j,k-3) * M6(1,3) &
                          + vsp(i,j,k-2) * M6(2,3) &
                          + vsp(i,j,k-1) * M6(3,3) &
                          + vsp(i,j,k  ) * M6(4,3) &
                          + vsp(i,j,k+1) * M6(5,3) &
                          + vsp(i,j,k+2) * M6(6,3)
                mmtmp6(4) =-vsp(i,j,k-3) * M6(6,3) &
                          - vsp(i,j,k-2) * M6(5,3) &
                          - vsp(i,j,k-1) * M6(4,3) &
                          - vsp(i,j,k  ) * M6(3,3) &
                          - vsp(i,j,k+1) * M6(2,3) &
                          - vsp(i,j,k+2) * M6(1,3)
                mmtmp6(5) =-vsp(i,j,k-2) * M6(5,2) &
                          - vsp(i,j,k-1) * M6(4,2) &
                          - vsp(i,j,k  ) * M6(3,2) &
                          - vsp(i,j,k+1) * M6(2,2) &
                          - vsp(i,j,k+2) * M6(1,2)
                mmtmp6(6) =-vsp(i,j,k-1) * M6(4,1) &
                          - vsp(i,j,k  ) * M6(3,1) &
                          - vsp(i,j,k+1) * M6(2,1) &
                          - vsp(i,j,k+2) * M6(1,1)
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp6, q(i,j,k-3:k+2,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j,k-3,qw)*mmtmp6(1) + q(i,j,k-2,qw)*mmtmp6(2) &
                   + q(i,j,k-1,qw)*mmtmp6(3) + q(i,j,k  ,qw)*mmtmp6(4) &
                   + q(i,j,k+1,qw)*mmtmp6(5) + q(i,j,k+2,qw)*mmtmp6(6) )

!EXPAND                mmtmp6 = matmul(lam(i,j,k-3:k+2), M6)
                mmtmp6(1) = lam(i,j,k-3) * M6(1,1) &
                          + lam(i,j,k-2) * M6(2,1) &
                          + lam(i,j,k-1) * M6(3,1) &
                          + lam(i,j,k  ) * M6(4,1)
                mmtmp6(2) = lam(i,j,k-3) * M6(1,2) &
                          + lam(i,j,k-2) * M6(2,2) &
                          + lam(i,j,k-1) * M6(3,2) &
                          + lam(i,j,k  ) * M6(4,2) &
                          + lam(i,j,k+1) * M6(5,2)
                mmtmp6(3) = lam(i,j,k-3) * M6(1,3) &
                          + lam(i,j,k-2) * M6(2,3) &
                          + lam(i,j,k-1) * M6(3,3) &
                          + lam(i,j,k  ) * M6(4,3) &
                          + lam(i,j,k+1) * M6(5,3) &
                          + lam(i,j,k+2) * M6(6,3)
                mmtmp6(4) =-lam(i,j,k-3) * M6(6,3) &
                          - lam(i,j,k-2) * M6(5,3) &
                          - lam(i,j,k-1) * M6(4,3) &
                          - lam(i,j,k  ) * M6(3,3) &
                          - lam(i,j,k+1) * M6(2,3) &
                          - lam(i,j,k+2) * M6(1,3)
                mmtmp6(5) =-lam(i,j,k-2) * M6(5,2) &
                          - lam(i,j,k-1) * M6(4,2) &
                          - lam(i,j,k  ) * M6(3,2) &
                          - lam(i,j,k+1) * M6(2,2) &
                          - lam(i,j,k+2) * M6(1,2)
                mmtmp6(6) =-lam(i,j,k-1) * M6(4,1) &
                          - lam(i,j,k  ) * M6(3,1) &
                          - lam(i,j,k+1) * M6(2,1) &
                          - lam(i,j,k+2) * M6(1,1)
!EXPAND                M6p = matmul(M6,  q(i,j,k-3:k+2,qpres))
                M6p(1) = M6(1,1) * q(i,j,k-3,qpres) &
                       + M6(1,2) * q(i,j,k-2,qpres) &
                       + M6(1,3) * q(i,j,k-1,qpres) &
                       - M6(6,3) * q(i,j,k  ,qpres)
                M6p(2) = M6(2,1) * q(i,j,k-3,qpres) &
                       + M6(2,2) * q(i,j,k-2,qpres) &
                       + M6(2,3) * q(i,j,k-1,qpres) &
                       - M6(5,3) * q(i,j,k  ,qpres) &
                       - M6(5,2) * q(i,j,k+1,qpres)
                M6p(3) = M6(3,1) * q(i,j,k-3,qpres) &
                       + M6(3,2) * q(i,j,k-2,qpres) &
                       + M6(3,3) * q(i,j,k-1,qpres) &
                       - M6(4,3) * q(i,j,k  ,qpres) &
                       - M6(4,2) * q(i,j,k+1,qpres) &
                       - M6(4,1) * q(i,j,k+2,qpres)
                M6p(4) = M6(4,1) * q(i,j,k-3,qpres) &
                       + M6(4,2) * q(i,j,k-2,qpres) &
                       + M6(4,3) * q(i,j,k-1,qpres) &
                       - M6(3,3) * q(i,j,k  ,qpres) &
                       - M6(3,2) * q(i,j,k+1,qpres) &
                       - M6(3,1) * q(i,j,k+2,qpres)
                M6p(5) = M6(5,2) * q(i,j,k-2,qpres) &
                       + M6(5,3) * q(i,j,k-1,qpres) &
                       - M6(2,3) * q(i,j,k  ,qpres) &
                       - M6(2,2) * q(i,j,k+1,qpres) &
                       - M6(2,1) * q(i,j,k+2,qpres)
                M6p(6) = M6(6,3) * q(i,j,k-1,qpres) &
                       - M6(1,3) * q(i,j,k  ,qpres) &
                       - M6(1,2) * q(i,j,k+1,qpres) &
                       - M6(1,1) * q(i,j,k+2,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp6, q(i,j,k-3:k+2,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j,k-3:k+2), M6p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j,k-3,qtemp)*mmtmp6(1) + q(i,j,k-2,qtemp)*mmtmp6(2) &
                     + q(i,j,k-1,qtemp)*mmtmp6(3) + q(i,j,k  ,qtemp)*mmtmp6(4) &
                     + q(i,j,k+1,qtemp)*mmtmp6(5) + q(i,j,k+2,qtemp)*mmtmp6(6) ) &
                   + ( dpe(i,j,k-3)*M6p(1) + dpe(i,j,k-2)*M6p(2) &
                     + dpe(i,j,k-1)*M6p(3) + dpe(i,j,k  )*M6p(4) &
                     + dpe(i,j,k+1)*M6p(5) + dpe(i,j,k+2)*M6p(6) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M6X = matmul(M6, q(i,j,k-3:k+2,qxn))
                   M6X(1) = M6(1,1) * q(i,j,k-3,qxn) &
                          + M6(1,2) * q(i,j,k-2,qxn) &
                          + M6(1,3) * q(i,j,k-1,qxn) &
                          - M6(6,3) * q(i,j,k  ,qxn)
                   M6X(2) = M6(2,1) * q(i,j,k-3,qxn) &
                          + M6(2,2) * q(i,j,k-2,qxn) &
                          + M6(2,3) * q(i,j,k-1,qxn) &
                          - M6(5,3) * q(i,j,k  ,qxn) &
                          - M6(5,2) * q(i,j,k+1,qxn)
                   M6X(3) = M6(3,1) * q(i,j,k-3,qxn) &
                          + M6(3,2) * q(i,j,k-2,qxn) &
                          + M6(3,3) * q(i,j,k-1,qxn) &
                          - M6(4,3) * q(i,j,k  ,qxn) &
                          - M6(4,2) * q(i,j,k+1,qxn) &
                          - M6(4,1) * q(i,j,k+2,qxn)
                   M6X(4) = M6(4,1) * q(i,j,k-3,qxn) &
                          + M6(4,2) * q(i,j,k-2,qxn) &
                          + M6(4,3) * q(i,j,k-1,qxn) &
                          - M6(3,3) * q(i,j,k  ,qxn) &
                          - M6(3,2) * q(i,j,k+1,qxn) &
                          - M6(3,1) * q(i,j,k+2,qxn)
                   M6X(5) = M6(5,2) * q(i,j,k-2,qxn) &
                          + M6(5,3) * q(i,j,k-1,qxn) &
                          - M6(2,3) * q(i,j,k  ,qxn) &
                          - M6(2,2) * q(i,j,k+1,qxn) &
                          - M6(2,1) * q(i,j,k+2,qxn)
                   M6X(6) = M6(6,3) * q(i,j,k-1,qxn) &
                          - M6(1,3) * q(i,j,k  ,qxn) &
                          - M6(1,2) * q(i,j,k+1,qxn) &
                          - M6(1,1) * q(i,j,k+2,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j,k-3:k+2,n), M6p) &
!EXPAND                        +    dot_product(dxy(i,j,k-3:k+2,n), M6X)
                   Htmp(n) =  &
                      ( ( dpy(i,j,k-3,n)*M6p(1) + dpy(i,j,k-2,n)*M6p(2) &
                        + dpy(i,j,k-1,n)*M6p(3) + dpy(i,j,k  ,n)*M6p(4) &
                        + dpy(i,j,k+1,n)*M6p(5) + dpy(i,j,k+2,n)*M6p(6) ) &
                      + ( dxy(i,j,k-3,n)*M6X(1) + dxy(i,j,k-2,n)*M6X(2) &
                        + dxy(i,j,k-1,n)*M6X(3) + dxy(i,j,k  ,n)*M6X(4) &
                        + dxy(i,j,k+1,n)*M6X(5) + dxy(i,j,k+2,n)*M6X(6) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j,k-3:k+2,n), M6X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j,k-3,n)*M6X(1) + dxe(i,j,k-2,n)*M6X(2) &
                      + dxe(i,j,k-1,n)*M6X(3) + dxe(i,j,k  ,n)*M6X(4) &
                      + dxe(i,j,k+1,n)*M6X(5) + dxe(i,j,k+2,n)*M6X(6) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j,k-1,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j,k-1,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             k = hi(3)-3
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(3)
             end do
          end do
       end do

       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       ! use 4th-order stencil for cell i,j,hi(3)-2
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             do iface=0,1 
                k = hi(3)-2 + iface

!EXPAND                mmtmp4 = matmul(mu(i,j,k-2:k+1), M4)
                mmtmp4(1) = mu(i,j,k-2) * M4(1,1) &
                          + mu(i,j,k-1) * M4(2,1) &
                          + mu(i,j,k  ) * M4(3,1)
                mmtmp4(2) = mu(i,j,k-2) * M4(1,2) &
                          + mu(i,j,k-1) * M4(2,2) &
                          + mu(i,j,k  ) * M4(3,2) &
                          + mu(i,j,k+1) * M4(4,2)
                mmtmp4(3) =-mu(i,j,k-2) * M4(4,2) &
                          - mu(i,j,k-1) * M4(3,2) &
                          - mu(i,j,k  ) * M4(2,2) &
                          - mu(i,j,k+1) * M4(1,2)
                mmtmp4(4) =-mu(i,j,k-1) * M4(3,1) &
                          - mu(i,j,k  ) * M4(2,1) &
                          - mu(i,j,k+1) * M4(1,1)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp4, q(i,j,k-2:k+1,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j,k-2,qu)*mmtmp4(1) + q(i,j,k-1,qu)*mmtmp4(2) &
                   + q(i,j,k  ,qu)*mmtmp4(3) + q(i,j,k+1,qu)*mmtmp4(4) )
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp4, q(i,j,k-2:k+1,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j,k-2,qv)*mmtmp4(1) + q(i,j,k-1,qv)*mmtmp4(2) &
                   + q(i,j,k  ,qv)*mmtmp4(3) + q(i,j,k+1,qv)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(vsp(i,j,k-2:k+1), M4)
                mmtmp4(1) = vsp(i,j,k-2) * M4(1,1) &
                          + vsp(i,j,k-1) * M4(2,1) &
                          + vsp(i,j,k  ) * M4(3,1)
                mmtmp4(2) = vsp(i,j,k-2) * M4(1,2) &
                          + vsp(i,j,k-1) * M4(2,2) &
                          + vsp(i,j,k  ) * M4(3,2) &
                          + vsp(i,j,k+1) * M4(4,2)
                mmtmp4(3) =-vsp(i,j,k-2) * M4(4,2) &
                          - vsp(i,j,k-1) * M4(3,2) &
                          - vsp(i,j,k  ) * M4(2,2) &
                          - vsp(i,j,k+1) * M4(1,2)
                mmtmp4(4) =-vsp(i,j,k-1) * M4(3,1) &
                          - vsp(i,j,k  ) * M4(2,1) &
                          - vsp(i,j,k+1) * M4(1,1)
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp4, q(i,j,k-2:k+1,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j,k-2,qw)*mmtmp4(1) + q(i,j,k-1,qw)*mmtmp4(2) &
                   + q(i,j,k  ,qw)*mmtmp4(3) + q(i,j,k+1,qw)*mmtmp4(4) )

!EXPAND                mmtmp4 = matmul(lam(i,j,k-2:k+1), M4)
                mmtmp4(1) = lam(i,j,k-2) * M4(1,1) &
                          + lam(i,j,k-1) * M4(2,1) &
                          + lam(i,j,k  ) * M4(3,1)
                mmtmp4(2) = lam(i,j,k-2) * M4(1,2) &
                          + lam(i,j,k-1) * M4(2,2) &
                          + lam(i,j,k  ) * M4(3,2) &
                          + lam(i,j,k+1) * M4(4,2)
                mmtmp4(3) =-lam(i,j,k-2) * M4(4,2) &
                          - lam(i,j,k-1) * M4(3,2) &
                          - lam(i,j,k  ) * M4(2,2) &
                          - lam(i,j,k+1) * M4(1,2)
                mmtmp4(4) =-lam(i,j,k-1) * M4(3,1) &
                          - lam(i,j,k  ) * M4(2,1) &
                          - lam(i,j,k+1) * M4(1,1)
!EXPAND                M4p = matmul(M4,  q(i,j,k-2:k+1,qpres))
                M4p(1) = M4(1,1) * q(i,j,k-2,qpres) &
                       + M4(1,2) * q(i,j,k-1,qpres) &
                       - M4(4,2) * q(i,j,k  ,qpres)
                M4p(2) = M4(2,1) * q(i,j,k-2,qpres) &
                       + M4(2,2) * q(i,j,k-1,qpres) &
                       - M4(3,2) * q(i,j,k  ,qpres) &
                       - M4(3,1) * q(i,j,k+1,qpres)
                M4p(3) = M4(3,1) * q(i,j,k-2,qpres) &
                       + M4(3,2) * q(i,j,k-1,qpres) &
                       - M4(2,2) * q(i,j,k  ,qpres) &
                       - M4(2,1) * q(i,j,k+1,qpres)
                M4p(4) = M4(4,2) * q(i,j,k-1,qpres) &
                       - M4(1,2) * q(i,j,k  ,qpres) &
                       - M4(1,1) * q(i,j,k+1,qpres)
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp4, q(i,j,k-2:k+1,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j,k-2:k+1), M4p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j,k-2,qtemp)*mmtmp4(1) + q(i,j,k-1,qtemp)*mmtmp4(2) &
                     + q(i,j,k  ,qtemp)*mmtmp4(3) + q(i,j,k+1,qtemp)*mmtmp4(4) ) &
                   + ( dpe(i,j,k-2)*M4p(1) + dpe(i,j,k-1)*M4p(2) &
                     + dpe(i,j,k  )*M4p(3) + dpe(i,j,k+1)*M4p(4) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

!EXPAND                   M4X = matmul(M4, q(i,j,k-2:k+1,qxn))
                   M4X(1) = M4(1,1) * q(i,j,k-2,qxn) &
                          + M4(1,2) * q(i,j,k-1,qxn) &
                          - M4(4,2) * q(i,j,k  ,qxn)
                   M4X(2) = M4(2,1) * q(i,j,k-2,qxn) &
                          + M4(2,2) * q(i,j,k-1,qxn) &
                          - M4(3,2) * q(i,j,k  ,qxn) &
                          - M4(3,1) * q(i,j,k+1,qxn)
                   M4X(3) = M4(3,1) * q(i,j,k-2,qxn) &
                          + M4(3,2) * q(i,j,k-1,qxn) &
                          - M4(2,2) * q(i,j,k  ,qxn) &
                          - M4(2,1) * q(i,j,k+1,qxn)
                   M4X(4) = M4(4,2) * q(i,j,k-1,qxn) &
                          - M4(1,2) * q(i,j,k  ,qxn) &
                          - M4(1,1) * q(i,j,k+1,qxn)
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j,k-2:k+1,n), M4p) &
!EXPAND                        +    dot_product(dxy(i,j,k-2:k+1,n), M4X)
                   Htmp(n) =  &
                      ( ( dpy(i,j,k-2,n)*M4p(1) + dpy(i,j,k-1,n)*M4p(2) &
                        + dpy(i,j,k  ,n)*M4p(3) + dpy(i,j,k+1,n)*M4p(4) ) &
                      + ( dxy(i,j,k-2,n)*M4X(1) + dxy(i,j,k-1,n)*M4X(2) &
                        + dxy(i,j,k  ,n)*M4X(3) + dxy(i,j,k+1,n)*M4X(4) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j,k-2:k+1,n), M4X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j,k-2,n)*M4X(1) + dxe(i,j,k-1,n)*M4X(2) &
                      + dxe(i,j,k  ,n)*M4X(3) + dxe(i,j,k+1,n)*M4X(4) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j,k-1,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j,k-1,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             k = hi(3)-2
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(3)
             end do
          end do
       end do

       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       ! use 2nd-order stencil for cell i,j,hi(3)-1
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             do iface=0,1 
                k = hi(3)-1 + iface

                mmtmp2 = matmul(mu(i,j,k-1:k), M2)
!EXPAND                Hcell(iface,imx) = dot_product(mmtmp2, q(i,j,k-1:k,qu))
                Hcell(iface,imx) =  &
                   ( q(i,j,k-1,qu)*mmtmp2(1) + q(i,j,k  ,qu)*mmtmp2(2) )
!EXPAND                Hcell(iface,imy) = dot_product(mmtmp2, q(i,j,k-1:k,qv))
                Hcell(iface,imy) =  &
                   ( q(i,j,k-1,qv)*mmtmp2(1) + q(i,j,k  ,qv)*mmtmp2(2) )

                mmtmp2 = matmul(vsp(i,j,k-1:k), M2)
!EXPAND                Hcell(iface,imz) = dot_product(mmtmp2, q(i,j,k-1:k,qw))
                Hcell(iface,imz) =  &
                   ( q(i,j,k-1,qw)*mmtmp2(1) + q(i,j,k  ,qw)*mmtmp2(2) )

                mmtmp2 = matmul(lam(i,j,k-1:k), M2)
                M2p = matmul(M2,  q(i,j,k-1:k,qpres))
!EXPAND                Hcell(iface,iene) = dot_product(mmtmp2, q(i,j,k-1:k,qtemp)) &
!EXPAND                     &            + dot_product(      dpe(i,j,k-1:k), M2p)
                Hcell(iface,iene) =  &
                   ( ( q(i,j,k-1,qtemp)*mmtmp2(1) + q(i,j,k  ,qtemp)*mmtmp2(2) ) &
                   + ( dpe(i,j,k-1)*M2p(1) + dpe(i,j,k  )*M2p(2) ) )

                Htot = 0.d0
                do n = 1, nspecies
                   qxn = qx1+n-1
                   qyn = qy1+n-1

                   M2X = matmul(M2, q(i,j,k-1:k,qxn))
                
!EXPAND                   Htmp(n) = dot_product(dpy(i,j,k-1:k,n), M2p) &
!EXPAND                        +    dot_product(dxy(i,j,k-1:k,n), M2X)
                   Htmp(n) =  &
                      ( ( dpy(i,j,k-1,n)*M2p(1) + dpy(i,j,k  ,n)*M2p(2) ) &
                      + ( dxy(i,j,k-1,n)*M2X(1) + dxy(i,j,k  ,n)*M2X(2) ) )

!EXPAND                   Hcell(iface,iene) = Hcell(iface,iene) &
!EXPAND                        +    dot_product(dxe(i,j,k-1:k,n), M2X)
                   Hcell(iface,iene) = Hcell(iface,iene)+ &
                      ( dxe(i,j,k-1,n)*M2X(1) + dxe(i,j,k  ,n)*M2X(2) )

                   Htot = Htot + Htmp(n)
                   Ytmp(n) = 0.5d0*(q(i,j,k-1,qyn) + q(i,j,k,qyn))
                end do

                do n = 1, nspecies
                   Hcell(iface,iry1+n-1) = Htmp(n) - Ytmp(n)*Htot
                end do

                do n = 1, nspecies
                   qhn = qh1+n-1
                   hhalf = 0.5d0*(q(i,j,k-1,qhn) + q(i,j,k,qhn))
                   Hcell(iface,iene) =  Hcell(iface,iene) - Ytmp(n)*Htot*hhalf
                end do
             end do

             k = hi(3)-1
             do n=2,ncons
                rhs(i,j,k,n) = rhs(i,j,k,n) + (Hcell(1,n) - Hcell(0,n)) * dx2inv(3)
             end do
          end do
       end do

       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       k = hi(3)
       ! use completely right-biased stencil
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             mmtmpB = matmul(mu(i,j,k-3:k), BLB)
!EXPAND             rhs(i,j,k,imx) = rhs(i,j,k,imx)+fouhi(3)*dx2inv(3)*dot_product(mmtmpB,q(i,j,k-3:k,qu))
             rhs(i,j,k,imx) = rhs(i,j,k,imx)+fouhi(3)*dx2inv(3)* &
                ( q(i,j,k-3,qu)*mmtmpB(1) + q(i,j,k-2,qu)*mmtmpB(2) &
                + q(i,j,k-1,qu)*mmtmpB(3) + q(i,j,k  ,qu)*mmtmpB(4) )
!EXPAND             rhs(i,j,k,imy) = rhs(i,j,k,imy)+fouhi(3)*dx2inv(3)*dot_product(mmtmpB,q(i,j,k-3:k,qv))
             rhs(i,j,k,imy) = rhs(i,j,k,imy)+fouhi(3)*dx2inv(3)* &
                ( q(i,j,k-3,qv)*mmtmpB(1) + q(i,j,k-2,qv)*mmtmpB(2) &
                + q(i,j,k-1,qv)*mmtmpB(3) + q(i,j,k  ,qv)*mmtmpB(4) )

             mmtmpB = matmul(vsp(i,j,k-3:k), BLB)
!EXPAND             rhs(i,j,k,imz) = rhs(i,j,k,imz)+finhi(3)*dx2inv(3)*dot_product(mmtmpB,q(i,j,k-3:k,qw))
             rhs(i,j,k,imz) = rhs(i,j,k,imz)+finhi(3)*dx2inv(3)* &
                ( q(i,j,k-3,qw)*mmtmpB(1) + q(i,j,k-2,qw)*mmtmpB(2) &
                + q(i,j,k-1,qw)*mmtmpB(3) + q(i,j,k  ,qw)*mmtmpB(4) )

             mmtmpB = matmul(lam(i,j,k-3:k), BLB)
             BBp = matmul(BLB, q(i,j,k-3:k,qpres))
!EXPAND             rhs(i,j,k,iene) = rhs(i,j,k,iene) + fouhi(3)*dx2inv(3) * &
!EXPAND                  ( dot_product(mmtmpB, q(i,j,k-3:k,qtemp)) &
!EXPAND                  + dot_product(      dpe(i,j,k-3:k), BBp) )
             rhs(i,j,k,iene) = rhs(i,j,k,iene)+fouhi(3)*dx2inv(3)* &
                ( ( q(i,j,k-3,qtemp)*mmtmpB(1) + q(i,j,k-2,qtemp)*mmtmpB(2) &
                  + q(i,j,k-1,qtemp)*mmtmpB(3) + q(i,j,k  ,qtemp)*mmtmpB(4) ) &
                + ( dpe(i,j,k-3)*BBp(1) + dpe(i,j,k-2)*BBp(2) &
                  + dpe(i,j,k-1)*BBp(3) + dpe(i,j,k  )*BBp(4) ) )
             
             rhstot = 0.d0
             rhsene = 0.d0
             do n = 1, nspecies
                qxn = qx1+n-1
                qyn = qy1+n-1

                BBX = matmul(BLB, q(i,j,k-3:k,qxn))
                
!EXPAND                rhstmp(n) = dot_product(dpy(i,j,k-3:k,n), BBp) &
!EXPAND                     +      dot_product(dxy(i,j,k-3:k,n), BBX)
                rhstmp(n) =  &
                   ( ( dpy(i,j,k-3,n)*BBp(1) + dpy(i,j,k-2,n)*BBp(2) &
                     + dpy(i,j,k-1,n)*BBp(3) + dpy(i,j,k  ,n)*BBp(4) ) &
                   + ( dxy(i,j,k-3,n)*BBX(1) + dxy(i,j,k-2,n)*BBX(2) &
                     + dxy(i,j,k-1,n)*BBX(3) + dxy(i,j,k  ,n)*BBX(4) ) )
                
!EXPAND                rhsene = rhsene &
!EXPAND                     +      dot_product(dxe(i,j,k-3:k,n), BBX)
                rhsene = rhsene+ &
                   ( dxe(i,j,k-3,n)*BBX(1) + dxe(i,j,k-2,n)*BBX(2) &
                   + dxe(i,j,k-1,n)*BBX(3) + dxe(i,j,k  ,n)*BBX(4) )

                rhstot = rhstot + rhstmp(n)
                Ytmp(n) = q(i,j,k,qyn)
             end do
             
             do n = 1, nspecies
                rhs(i,j,k,iry1+n-1) =  rhs(i,j,k,iry1+n-1) + &
                     fouhi(3)*dx2inv(3) * (rhstmp(n) - Ytmp(n)*rhstot)
             end do

             do n = 1, nspecies
                qhn = qh1+n-1
                rhsene = rhsene - Ytmp(n) * q(i,j,k,qhn) * rhstot
             end do
             rhs(i,j,k,iene) = rhs(i,j,k,iene) + fouhi(3)*dx2inv(3) * rhsene
             
          end do
       end do
    end if

    !
    ! add kinetic energy
    !
    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)
             rhs(i,j,k,iene) = rhs(i,j,k,iene) &
                  + rhs(i,j,k,imx)*q(i,j,k,qu) &
                  + rhs(i,j,k,imy)*q(i,j,k,qv) &
                  + rhs(i,j,k,imz)*q(i,j,k,qw)
          end do
       end do
    end do

    deallocate(Hg,dpy,dxe,dpe,vsp,M8p)
    if (.not.reset_N2) deallocate(Hry)

  end subroutine diffterm_2


  subroutine chemterm_3d(lo,hi,q,qlo,qhi,up,uplo,uphi)
    integer,         intent(in):: lo(3),hi(3),qlo(3),qhi(3),uplo(3),uphi(3)
    double precision,intent(in):: q ( qlo(1): qhi(1), qlo(2): qhi(2), qlo(3): qhi(3),nprim)
    double precision           :: up(uplo(1):uphi(1),uplo(2):uphi(2),uplo(3):uphi(3),ncons)

    integer :: iwrk, i,j,k
    double precision :: Yt(nspecies), wdot(nspecies), rwrk

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             Yt = q(i,j,k,qy1:qy1+nspecies-1)
             call ckwyr(q(i,j,k,qrho), q(i,j,k,qtemp), Yt, iwrk, rwrk, wdot)
             up(i,j,k,iry1:) = wdot * molecular_weight
             
          end do
       end do
    end do

  end subroutine chemterm_3d


  subroutine comp_courno_3d(lo,hi,dx,Q,qlo,qhi,courno)
    integer, intent(in) :: lo(3), hi(3), qlo(3), qhi(3)
    double precision, intent(in) :: dx(3)
    double precision, intent(in) :: q(qlo(1):qhi(1),qlo(2):qhi(2),qlo(3):qhi(3),nprim)
    double precision, intent(inout) :: courno

    integer :: i,j,k, iwrk
    double precision :: dxinv(3), c, rwrk, Cv, Cp
    double precision :: Tt, X(nspecies), gamma
    double precision :: courx, coury, courz

    do i=1,3
       dxinv(i) = 1.0d0 / dx(i)
    end do

    do k=lo(3),hi(3)
       do j=lo(2),hi(2)
          do i=lo(1),hi(1)

             Tt = q(i,j,k,qtemp)
             X  = q(i,j,k,qx1:qx1+nspecies-1)
             call ckcvbl(Tt, X, iwrk, rwrk, Cv)
             Cp = Cv + Ru
             gamma = Cp / Cv
             c = sqrt(gamma*q(i,j,k,qpres)/q(i,j,k,qrho))

             courx = (c+abs(q(i,j,k,qu))) * dxinv(1)
             coury = (c+abs(q(i,j,k,qv))) * dxinv(2)
             courz = (c+abs(q(i,j,k,qw))) * dxinv(3)
             
             courno = max( courx, coury, courz , courno )

          end do
       end do
    end do

  end subroutine comp_courno_3d

end module kernels_module
